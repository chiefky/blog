<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Block</title>
      <link href="/blog/2021/08/27/block/"/>
      <url>/blog/2021/08/27/block/</url>
      
        <content type="html"><![CDATA[<h1 id="Blockçš„ä¸‰ç§ç±»å‹"><a href="#Blockçš„ä¸‰ç§ç±»å‹" class="headerlink" title="Blockçš„ä¸‰ç§ç±»å‹"></a>Blockçš„ä¸‰ç§ç±»å‹</h1><h3 id="ä¸‰ç§ç±»å‹ç‰¹ç‚¹ï¼š"><a href="#ä¸‰ç§ç±»å‹ç‰¹ç‚¹ï¼š" class="headerlink" title="ä¸‰ç§ç±»å‹ç‰¹ç‚¹ï¼š"></a>ä¸‰ç§ç±»å‹ç‰¹ç‚¹ï¼š</h3><p>(å †æ ˆæ˜¯åœ¨è¿è¡Œæ—¶åˆ†é…ç©ºé—´ï¼Œå…¨å±€æ˜¯åœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®š)</p><ul><li>å…¨å±€block<ul><li>ä½äºå…¨å±€åŒº</li><li>åœ¨blockå†…éƒ¨ä¸ä½¿ç”¨å¤–éƒ¨å˜é‡ or <strong>åªä½¿ç”¨</strong>å…¨å±€å˜é‡æˆ–è€…é™æ€å˜é‡</li></ul></li><li>å †åŒºblock<ul><li>ä½äºå †åŒº</li><li>å‰æï¼šåœ¨blockå†…éƒ¨å¯ä»¥ä½¿ç”¨å¤–éƒ¨å˜é‡æˆ–OCå±æ€§ï¼Œå¹¶ä¸”å°†blockèµ‹å€¼ç»™strongæˆ–copyä¿®é¥°çš„å˜é‡</li></ul></li><li>æ ˆåŒºblock<ul><li>ä½äºæ ˆåŒº</li><li>å‰æï¼šåœ¨blockå†…éƒ¨å¯ä»¥ä½¿ç”¨å¤–éƒ¨å˜é‡æˆ–OCå±æ€§ï¼Œå¹¶ä¸”ä¸å¯¹blockèµ‹å€¼æˆ–è€…åªèƒ½èµ‹å€¼ç»™weakä¿®é¥°çš„å˜é‡</li></ul></li></ul><p>ä¸¾ä¾‹è¯´æ˜ï¼š</p><img src="../assets/images/block_å£°æ˜.png" alt="å£°æ˜" style="zoom:80%;"><img src="../assets/images/block_ç±»å‹_global.png" alt="å…¨å±€åŒºblock" style="zoom:80%;"><img src="../assets/images/block_ç±»å‹_malloc_statck.png" alt="å †åŒºå’Œæ ˆåŒº" style="zoom:80%;"><h3 id="é¢è¯•é¢˜"><a href="#é¢è¯•é¢˜" class="headerlink" title="é¢è¯•é¢˜"></a>é¢è¯•é¢˜</h3><ol><li><p>ä»¥ä¸‹ä»£ç å°†ä¼šæ€æ ·æ‰§è¡Œï¼Ÿæ¢æˆæ³¨é‡Šä¸­çš„ä»£ç åˆä¼šæ€æ ·æ‰§è¡Œï¼Ÿ</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (void)testStackBlock_copy {</span><br><span class="line">    int num = 8;</span><br><span class="line">    void(^__weak weakBlock)(void) = nil;</span><br><span class="line">    {</span><br><span class="line">        void(^__weak weakBlock1)(void) = ^{</span><br><span class="line">            NSLog(@"num = %d",num);</span><br><span class="line">        };  </span><br><span class="line">        weakBlock = weakBlock1;// [weakBlock1 copy];</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    weakBlock();</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>ç­”ï¼š </p><p> 1.â€ weakBlock = weakBlock1; â€œ</p><p>  ä¸¤ä¸ªblockéƒ½æ˜¯stack blockï¼Œéƒ½å­˜å‚¨åœ¨æ ˆåŒºï¼›æ ˆåŒºç©ºé—´æ˜¯æ–¹æ³•ä½“ç©ºé—´ï¼Œä¸­é—´çš„â€™{}â€™è¡¨ç¤ºåŒ¿åä½œç”¨åŸŸï¼Œï¼ˆCè¯­è¨€ä¸­ä»‹ç»ï¼‰æ ˆå­˜å‚¨æœŸé—´åŒ¿åä½œç”¨åŸŸçš„å˜é‡è¶…å‡ºåŒ¿åä½œç”¨åŸŸä¸ä¸€å®šç«‹å³é‡Šæ”¾ï¼›</p><pre><code> 2. "weakBlock = [weakBlock1 copy];"     ç»è¿‡copyå weakBlockæŒ‡å‘çš„æ˜¯å †åŒºçš„ç©ºé—´ï¼Œåœ¨ARCä¸‹,ç¼–è¯‘å™¨åœ¨åŒ¿åä½œç”¨åŸŸ"}"æ’å…¥äº†releaseï¼ŒweakBlock æŒ‡å‘çš„åŒºåŸŸè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œæ‰€ä»¥è¶…å‡º"}"è°ƒç”¨weakBlock() ä¼šå´©æºƒã€‚        </code></pre></blockquote></li><li><p>ä»€ä¹ˆæƒ…å†µä¸‹ç³»ç»Ÿä¸ä¼šå¯¹blockæ‰§è¡Œcopyæ“ä½œï¼Ÿ</p></li></ol><p>ç­”ï¼šstack blockä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œç³»ç»Ÿæ— æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œcopyï¼Œæ­¤æ—¶ä¸ä¼šä¸»åŠ¨è¿›è¡Œcopyæ“ä½œï¼›</p><p>#2. blockåŸç†æ¢ç´¢</p><h2 id="2-1-blockçš„æœ¬è´¨"><a href="#2-1-blockçš„æœ¬è´¨" class="headerlink" title="2.1 blockçš„æœ¬è´¨"></a>2.1 blockçš„æœ¬è´¨</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) {</span><br><span class="line">   </span><br><span class="line">    NSObject *obj = [NSObject alloc];</span><br><span class="line">    void (^ strBlock)(void) = ^{</span><br><span class="line">        NSLog(@"obj retainCount: %ld",CFGetRetainCount((__bridge CFTypeRef)obj));</span><br><span class="line">    };</span><br><span class="line">    strBlock();</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>blockä»£ç ç»è¿‡ç¼–è¯‘ç”Ÿæˆçš„c++æºç :</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> {</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  NSObject *obj;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, NSObject *_obj, <span class="keyword">int</span> flags=<span class="number">0</span>) : <span class="built_in">obj</span>(_obj) {</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) {</span><br><span class="line">  NSObject *obj = __cself-&gt;obj; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSLog</span>((NSString *)&amp;__NSConstantStringImpl__var_folders_kg_jwbbkd7s2zd3q3kqhq5x64wm0000gp_T_main_a63961_mi_5,<span class="built_in">CFGetRetainCount</span>((__bridge CFTypeRef)obj));</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;obj, (<span class="keyword">void</span>*)src-&gt;obj, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;obj, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> {</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="built_in"><span class="keyword">void</span></span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  <span class="built_in"><span class="keyword">void</span></span> (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">} __main_block_desc_0_DATA = { <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>{</span><br><span class="line"></span><br><span class="line">    NSObject *obj = ((NSObject *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)<span class="built_in">objc_getClass</span>(<span class="string">"NSObject"</span>), <span class="built_in">sel_registerName</span>(<span class="string">"alloc"</span>));</span><br><span class="line">    <span class="built_in"><span class="keyword">void</span></span> (* strBlock)(<span class="keyword">void</span>) = ((<span class="built_in"><span class="keyword">void</span></span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, obj, <span class="number">570425344</span>));</span><br><span class="line">    ((<span class="built_in"><span class="keyword">void</span></span> (*)(__block_impl *))((__block_impl *)strBlock)-&gt;FuncPtr)((__block_impl *)strBlock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in"><span class="keyword">void</span></span> (* strBlock)(<span class="keyword">void</span>) = ((<span class="built_in"><span class="keyword">void</span></span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, obj, <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">((<span class="built_in"><span class="keyword">void</span></span> (*)(__block_impl *))((__block_impl *)strBlock)-&gt;FuncPtr)((__block_impl *)strBlock);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><img src="../assets/images/block_main_cpp.png" alt="main_cpp" style="zoom:80%;"><p>ä»ä¸Šå›¾çœ‹å‡º:</p><ol><li><p>mainå‡½æ•°ä¸­çš„strBlockè¢«ç¼–è¯‘æˆäº†ä¸€ä¸ª<code>__main_block_impl_0</code>çš„strut;</p></li><li><p><code>__main_block_impl_0</code> ç»“æ„ä½“åŒ…å«ä¸€ä¸ª<code>__block_impl</code>ç»“æ„ä½“ã€ä¸€ä¸ª<code>__main_block_desv_0</code>ç»“æ„ä½“å’Œä¸€ä¸ªæ•è·çš„å¤–éƒ¨å˜é‡<code>obj</code>ï¼›</p><img src="../assets/images/block_imp.jpg" alt="bloc_imp" style="zoom:120%;"></li><li><p><code>__block_impl</code>ç»“æ„ä½“åˆ™åŒ…å«ä¸€ä¸ªisaã€ä¸€ä¸ªFuncPtr å’Œä¸¤ä¸ªintç±»å‹æ ‡è®°ï¼›</p></li></ol><h3 id="å¦‚ä½•æŸ¥çœ‹Blockç±»å‹ï¼Ÿ"><a href="#å¦‚ä½•æŸ¥çœ‹Blockç±»å‹ï¼Ÿ" class="headerlink" title="å¦‚ä½•æŸ¥çœ‹Blockç±»å‹ï¼Ÿ"></a>å¦‚ä½•æŸ¥çœ‹Blockç±»å‹ï¼Ÿ</h3><p>ï¼ˆçœ‹ğŸ‘€â€“&gt; struct çš„isa) ğŸ“¢ï¼šè¿™é‡Œåªæ˜¯ç¼–è¯‘æˆcppä»£ç çš„ä¸­é—´ç±»å‹ï¼Œç»è¿‡æ±‡ç¼–ï¼Œå¦‚æœä¼šcopyåˆ°å †åŒºæœ€ç»ˆå°†ä¿®æ”¹æˆmallocblock</p><h2 id="2-2-blockæ˜¯æ€æ ·æ•è·å¤–éƒ¨å˜é‡çš„ï¼Ÿ"><a href="#2-2-blockæ˜¯æ€æ ·æ•è·å¤–éƒ¨å˜é‡çš„ï¼Ÿ" class="headerlink" title="2.2 blockæ˜¯æ€æ ·æ•è·å¤–éƒ¨å˜é‡çš„ï¼Ÿ"></a>2.2 blockæ˜¯æ€æ ·æ•è·å¤–éƒ¨å˜é‡çš„ï¼Ÿ</h2><p>å¯¹äº block å¤–çš„å˜é‡å¼•ç”¨ï¼Œblock é»˜è®¤æ˜¯å°†å…¶å¤åˆ¶åˆ°å…¶æ•°æ®ç»“æ„ä¸­æ¥å®ç°è®¿é—®çš„ã€‚ä¹Ÿå°±æ˜¯è¯´blockçš„è‡ªåŠ¨å˜é‡æˆªè·åªé’ˆå¯¹blockå†…éƒ¨ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡, ä¸ä½¿ç”¨åˆ™ä¸æˆªè·, å› ä¸ºæˆªè·çš„è‡ªåŠ¨å˜é‡ä¼šå­˜å‚¨äºblockçš„ç»“æ„ä½“å†…éƒ¨, ä¼šå¯¼è‡´blockä½“ç§¯å˜å¤§ã€‚ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯é»˜è®¤æƒ…å†µä¸‹blockåªèƒ½è®¿é—®ä¸èƒ½ä¿®æ”¹å±€éƒ¨å˜é‡çš„å€¼ã€‚æ•è·å˜é‡åˆ†ä¸¤ç§æƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li>é<code>__block</code>ä¿®é¥°çš„å˜é‡</li><li><code>__block</code>ä¿®é¥°çš„å˜é‡</li></ul><h3 id="2-2-1-æ•è·é-blockä¿®é¥°çš„å˜é‡"><a href="#2-2-1-æ•è·é-blockä¿®é¥°çš„å˜é‡" class="headerlink" title="2.2.1 æ•è·é__blockä¿®é¥°çš„å˜é‡"></a>2.2.1 æ•è·é<code>__block</code>ä¿®é¥°çš„å˜é‡</h3><h4 id="ä»å†…å­˜ç®¡ç†è¯­ä¹‰è§’åº¦è€ƒå¯Ÿ"><a href="#ä»å†…å­˜ç®¡ç†è¯­ä¹‰è§’åº¦è€ƒå¯Ÿ" class="headerlink" title="ä»å†…å­˜ç®¡ç†è¯­ä¹‰è§’åº¦è€ƒå¯Ÿ"></a>ä»å†…å­˜ç®¡ç†è¯­ä¹‰è§’åº¦è€ƒå¯Ÿ</h4><p>åŸåˆ™ï¼šé‡å¼ºæ•å¼ºé‡å¼±æ•å¼±</p><h4 id="ä»è¾“å‡ºæ•è·å˜é‡å€¼è€ƒå¯Ÿ"><a href="#ä»è¾“å‡ºæ•è·å˜é‡å€¼è€ƒå¯Ÿ" class="headerlink" title="ä»è¾“å‡ºæ•è·å˜é‡å€¼è€ƒå¯Ÿ"></a>ä»è¾“å‡ºæ•è·å˜é‡å€¼è€ƒå¯Ÿ</h4><ul><li><p>æ•è·å¤–éƒ¨å˜é‡(ä¼ é€’çš„æ˜¯å€¼)</p></li><li><p>æ•è·é™æ€å˜é‡(ä¼ é€’çš„æ˜¯é™æ€å˜é‡çš„æŒ‡é’ˆ)</p></li><li><p>æ•è·å…¨å±€å˜é‡ï¼ˆæ²¡æœ‰ä¼ é€’ï¼Œç›´æ¥è®¿é—®çš„å…¨å±€åŒºï¼‰</p></li><li><p>æ•è·å¤–éƒ¨OCå¯¹è±¡ï¼ˆä¼ çš„æ˜¯å¯¹è±¡çš„å€¼ï¼‰</p><p>åŸå› ï¼š<strong>ä¸ºäº†ä¿è¯blockå†…éƒ¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®å¤–éƒ¨çš„å˜é‡ï¼Œblockæœ‰ä¸ªå˜é‡æ•è·æœºåˆ¶ï¼›autoå˜é‡ageçš„blockè®¿é—®æ–¹å¼æ˜¯å€¼ä¼ é€’ï¼Œstaticå˜é‡numçš„blockè®¿é—®æ–¹å¼æ˜¯æŒ‡é’ˆä¼ é€’ï¼Œblockä¸éœ€è¦å¯¹å…¨å±€å˜é‡æ•è·ï¼Œéƒ½æ˜¯ç›´æ¥é‡‡ç”¨å–å…¨å±€å˜é‡çš„å€¼</strong>ã€‚</p><img src="../assets/images/block_main_m_catch.png" alt="æ•è·å˜é‡" style="zoom:80%;"><img src="../assets/images/block_main_cpp_catch_2.png" alt="æ•è·å˜é‡ç¼–è¯‘æºç è§£æ2" style="zoom:80%;"><img src="../assets/images/block_main_cpp_catch_1.png" alt="æ•è·å˜é‡æºç è§£æ1" style="zoom:80%;"></li></ul><h3 id="2-2-2-æ•è·-blockä¿®é¥°çš„å˜é‡"><a href="#2-2-2-æ•è·-blockä¿®é¥°çš„å˜é‡" class="headerlink" title="2.2.2 æ•è·__blockä¿®é¥°çš„å˜é‡"></a>2.2.2 æ•è·<code>__block</code>ä¿®é¥°çš„å˜é‡</h3><p>å¯¹äºç”¨ <code>__block</code> ä¿®é¥°çš„å¤–éƒ¨å˜é‡å¼•ç”¨ï¼Œblock æ˜¯å¤åˆ¶å…¶å¼•ç”¨åœ°å€æ¥å®ç°è®¿é—®çš„ã€‚blockå¯ä»¥ä¿®æ”¹__block ä¿®é¥°çš„å¤–éƒ¨å˜é‡çš„å€¼ã€‚</p><img src="../assets/images/block_main_cpp__block_2.png" alt="__blockä¼ æŒ‡é’ˆ" style="zoom:80%;"><img src="../assets/images/block_main_cpp__block_0.png" alt="__blockä¼ æŒ‡é’ˆ" style="zoom:100%;"><p>é€šè¿‡ç¼–è¯‘æºç è§£ææˆçš„cä»£ç ï¼Œä¼šå‘ç°åŠ ä¸Š<code>__block</code>ä¿®é¥°ç¬¦çš„å±€éƒ¨å˜é‡ï¼Œç«Ÿç„¶è·Ÿblockä¸€æ ·å˜æˆäº†ä¸€ä¸ª<code>__Block_byref_bmuArray_0</code>ç»“æ„ä½“ç±»å‹å˜é‡å®ä¾‹ï¼ï¼ï¼ï¼</p><p>æ­¤æ—¶æˆ‘ä»¬åœ¨blockå†…éƒ¨è®¿é—®valå˜é‡åˆ™éœ€è¦é€šè¿‡ä¸€ä¸ªå«__forwardingçš„æˆå‘˜å˜é‡æ¥é—´æ¥è®¿é—®valå˜é‡ã€‚</p><img src="../assets/images/block_main_cpp__block_1.png" alt="__blockä¼ æŒ‡é’ˆ" style="zoom:80%;"><h4 id="blockå˜é‡ä¸-forwarding"><a href="#blockå˜é‡ä¸-forwarding" class="headerlink" title="__blockå˜é‡ä¸__forwarding"></a><code>__blockå˜é‡</code>ä¸__forwarding</h4><img src="../assets/images/block_forwarding.png" alt="__forwording" style="zoom:80%;"><p>é€šè¿‡__forwarding, æ— è®ºæ˜¯åœ¨blockä¸­è¿˜æ˜¯ blockå¤–è®¿é—®__blockå˜é‡, ä¹Ÿä¸ç®¡è¯¥å˜é‡åœ¨æ ˆä¸Šæˆ–å †ä¸Š, éƒ½èƒ½é¡ºåˆ©åœ°è®¿é—®åŒä¸€ä¸ª__blockå˜é‡ã€‚</p><h1 id="3-blockå†…å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆ"><a href="#3-blockå†…å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆ" class="headerlink" title="3. blockå†…å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆ"></a>3. blockå†…å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆ</h1><ul><li> æ–¹æ¡ˆä¸€ï¼šå€ŸåŠ©weak</li></ul>  <figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)testBlockLifeCircle_weak {</span><br><span class="line">  __weak typeof(self) weakSelf = self;</span><br><span class="line"></span><br><span class="line">  self.yl_VBlock = ^{</span><br><span class="line">    NSLog(@"demoName = %@",[weakSelf demoName]);</span><br><span class="line">  };</span><br><span class="line">  self.yl_VBlock();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li><p>æ–¹æ¡ˆäºŒï¼šå€ŸåŠ©__block</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (void)testBlockLifeCircle_block {</span><br><span class="line"></span><br><span class="line">  __block YLBlockRetainCycleViewController *tmpVC = self;</span><br><span class="line">  self.yl_VBlock = ^{</span><br><span class="line">    NSLog(@"demoName = %@",[tmpVC demoName]);</span><br><span class="line">    tmpVC = nil; // ğŸ“¢ï¼š1.å¿…é¡»å°†å˜é‡ç½®ä¸ºnil</span><br><span class="line">  };</span><br><span class="line">  self.yl_VBlock(); // ğŸ“¢ï¼š2.å¿…é¡»è°ƒç”¨block(å¦‚æœä¸è°ƒä¸ä¼šï¼Œè§£å†³å¾ªç¯å¼•ç”¨)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p> æ–¹æ¡ˆä¸‰ï¼šå€ŸåŠ©å‚æ•°</p></li></ul>  <figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)testBlockLifeCircle_Parameter {</span><br><span class="line">  self.yl_PBlock = ^(YLBlockRetainCycleViewController *vc) {</span><br><span class="line">    NSLog(@"demoName = %@",[vc demoName]);</span><br><span class="line">  };</span><br><span class="line">  self.yl_PBlock(self);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ul><li> æ–¹æ¡ˆå››ï¼šä½¿ç”¨NSProxyï¼ˆå…¶å®æ˜¯å€ŸåŠ©å‚æ•°ä¼ é€’ä¸­é—´è€…+ä¸­é—´è€…å¼±æŒæœ‰selfå°±å¯ä»¥è§£å†³ï¼Œå®Œå…¨å¯ä»¥ä¸ç”¨æ¶ˆæ¯è½¬å‘ï¼‰ï¼ˆä½¿ç”¨Proxyçš„åŸç†æ˜¯ï¼š1.æ·»åŠ äº†ä¸€ä¸ªä¸­é—´è€…Proxyï¼›2.ProxyæŒæœ‰ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å“åº”æ–¹æ³•çš„ç›®æ ‡å¯¹è±¡ï¼›3. å€ŸåŠ©æ¶ˆæ¯è½¬å‘æœºåˆ¶å°†æ¶ˆæ¯ä¼ é€’ç»™ç›®æ ‡å¯¹è±¡ï¼‰</li></ul>  <figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)testBlockLifeCircle_Rroxy {</span><br><span class="line">  YLProxy *proxy = [YLProxy proxyWithTarget:self];</span><br><span class="line">  self.yl_PoxBlock = ^(YLProxy *pox) {</span><br><span class="line">    NSLog(@"demoName = %@",[pox.target demoName]);</span><br><span class="line">  };</span><br><span class="line">  self.yl_PoxBlock(proxy);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> block </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/blog/2021/08/27/hello-world/"/>
      <url>/blog/2021/08/27/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å†…å­˜ç®¡ç†</title>
      <link href="/blog/2018/09/07/nei-cun-guan-li/"/>
      <url>/blog/2018/09/07/nei-cun-guan-li/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="1-å†…å­˜å¸ƒå±€ï¼ˆå†…å­˜åˆ†åŒºï¼‰"><a href="#1-å†…å­˜å¸ƒå±€ï¼ˆå†…å­˜åˆ†åŒºï¼‰" class="headerlink" title="1. å†…å­˜å¸ƒå±€ï¼ˆå†…å­˜åˆ†åŒºï¼‰"></a>1. å†…å­˜å¸ƒå±€ï¼ˆå†…å­˜åˆ†åŒºï¼‰</h1><p>å…±äº«åº“ï¼ˆlibobjc.A.dylibç­‰ï¼‰ä¸å†…æ ¸ç©ºé—´çš„å†…å­˜å¸ƒå±€åœ¨æ ˆåŒºä¹‹ä¸Š;å¦‚ä¸‹å›¾ï¼š</p><img src="/Users/tangh/yuki/iOSç»ƒä¹ Demos/YLNote/YLNote/latest/ä¸ªäººç¬”è®°/æ–‡ç« /images/å†…å­˜å¸ƒå±€_0.jpg" alt="å†…å­˜åˆ†å¸ƒ" style="zoom:100%;"><ul><li><p><strong>å†…æ ¸åŒº</strong>ï¼šç”¨äºåŠ è½½å†…æ ¸ä»£ç ï¼Œé¢„ç•™1GB</p></li><li><p><strong>å…±äº«åŒºï¼šç”¨äºåŠ è½½ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚:libobjc.a.dylib</strong></p></li><li><p><strong>æ ˆåŒº</strong>ï¼šåˆ›å»ºä¸´æ—¶å˜é‡æ—¶ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤çš„å˜é‡çš„å­˜å‚¨åŒºã€‚é‡Œé¢çš„å˜é‡é€šå¸¸æ˜¯å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ç­‰ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä½äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é¡¶éƒ¨çš„æ˜¯ç”¨æˆ·æ ˆï¼Œç¼–è¯‘å™¨ç”¨å®ƒæ¥å®ç°å‡½æ•°çš„è°ƒç”¨ã€‚å’Œå †ä¸€æ ·ï¼Œç”¨æˆ·æ ˆåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å¯ä»¥åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚æ ˆåŒºçš„å†…å­˜åœ°å€ä¸€èˆ¬æ˜¯0x7å¼€å¤´,ä»é«˜åœ°å€åˆ°åº•åœ°å€åˆ†é…å†…å­˜ç©ºé—´ï¼ˆ**<font color="red">TaggedPointer</font>**ï¼‰</p></li><li><p><strong>å †åŒº</strong>ï¼šé‚£äº›ç”± new alloc åˆ›å»ºçš„å¯¹è±¡æ‰€åˆ†é…çš„å†…å­˜å—ï¼Œå®ƒä»¬çš„é‡Šæ”¾ç³»ç»Ÿä¸ä¼šä¸»åŠ¨å»ç®¡ï¼Œç”±æˆ‘ä»¬çš„å¼€å‘è€…å»å‘Šè¯‰ç³»ç»Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾è¿™å—å†…å­˜(ä¸€ä¸ªå¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º0æ˜¯ç³»ç»Ÿå°±ä¼šå›é”€æ¯è¯¥å†…å­˜åŒºåŸŸå¯¹è±¡)ã€‚ä¸€èˆ¬ä¸€ä¸ª new å°±è¦å¯¹åº”ä¸€ä¸ªreleaseã€‚åœ¨ARCä¸‹ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨åˆé€‚ä½ç½®ä¸ºOCå¯¹è±¡æ·»åŠ releaseæ“ä½œã€‚ä¼šåœ¨å½“å‰çº¿ç¨‹Runloopé€€å‡ºæˆ–ä¼‘çœ æ—¶é”€æ¯è¿™äº›å¯¹è±¡ï¼ŒMRCåˆ™éœ€ç¨‹åºå‘˜æ‰‹åŠ¨é‡Šæ”¾ã€‚å †å¯ä»¥åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚å †åŒºçš„å†…å­˜åœ°å€ä¸€èˆ¬æ˜¯0x6å¼€å¤´,ä»åº•åœ°å€åˆ°é«˜åœ°å€åˆ†é…å†…å­˜ç©ºé—´</p></li><li><p><strong>æœªåˆå§‹åŒ–æ•°æ®ï¼ˆé™æ€åŒºï¼‰</strong>ï¼šBSSæ®µåˆç§°é™æ€åŒºï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡å­˜æ”¾åœ¨è¿™é‡Œã€‚ä¸€æ—¦åˆå§‹åŒ–å°±ä¼šè¢«å›æ”¶ï¼Œå¹¶ä¸”å°†æ•°æ®è½¬å­˜åˆ°æ•°æ®æ®µä¸­ã€‚</p></li><li><p><strong>å·²åˆå§‹åŒ–æ•°æ®ï¼ˆå¸¸é‡åŒºï¼‰</strong>ï¼šæ•°æ®æ®µåˆç§°å¸¸é‡åŒºï¼Œä¸“é—¨å­˜æ”¾å¸¸é‡ï¼Œç›´åˆ°ç¨‹åºç»“æŸçš„æ—¶å€™æ‰ä¼šè¢«å›æ”¶</p></li><li><p><strong>ä»£ç æ®µ</strong>ï¼šç”¨äºå­˜æ”¾ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç ï¼Œä»£ç ä¼šè¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶å­˜è¿›å†…å­˜çš„ç¨‹åºä»£ç åŒºã€‚ç¨‹åºç»“æŸæ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶å­˜å‚¨åœ¨ä»£ç æ®µä¸­çš„æ•°æ®ã€‚</p></li><li><p><strong>ä¿ç•™åŒº</strong>ï¼šå†…å­˜æœ‰4MBä¿ç•™ï¼Œåœ°å€ä»ä½åˆ°é«˜é€’å¢</p><p>å¦‚ä½•æŸ¥çœ‹å¯¹è±¡åœ°å€ï¼š</p><img src="../assets/images/å†…å­˜å¸ƒå±€_1.jpg" alt="å†…å­˜åˆ†å¸ƒ-1" style="zoom:80%;"></li></ul><h1 id="2-å†…å­˜ç®¡ç†æ–¹æ¡ˆ"><a href="#2-å†…å­˜ç®¡ç†æ–¹æ¡ˆ" class="headerlink" title="2. å†…å­˜ç®¡ç†æ–¹æ¡ˆ"></a>2. å†…å­˜ç®¡ç†æ–¹æ¡ˆ</h1><ul><li><p>å †åŒºï¼šç”±å¼€å‘è€…ï¼ˆå€ŸåŠ©<font color="red">å¼•ç”¨è®¡æ•°</font>ï¼‰ç®¡ç†çš„ï¼Œéœ€è¦å‘Šè¯‰ç³»ç»Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾å†…å­˜ã€‚</p><p>ARCä¸‹ï¼šç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨åˆé€‚çš„æ—¶å€™æ’å…¥å¼•ç”¨è®¡æ•°ç®¡ç†ä»£ç ï¼ˆ<code>retain</code>ã€<code>release</code>ã€<code>autorelease</code>ï¼‰ï¼›</p><p>MRCä¸‹ï¼šéœ€è¦å¼€å‘è€…æ‰‹åŠ¨é‡Šæ”¾ã€‚</p></li><li><p>æ ˆåŒºã€å…¶ä»–åŒºï¼šç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œç”±ç³»ç»Ÿç®¡ç†ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤ï¼›</p></li></ul><h1 id="3-å¼•ç”¨è®¡æ•°åŸç†"><a href="#3-å¼•ç”¨è®¡æ•°åŸç†" class="headerlink" title="3. å¼•ç”¨è®¡æ•°åŸç†"></a>3. å¼•ç”¨è®¡æ•°åŸç†</h1><p>å¼•ç”¨è®¡æ•°æ˜¯ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œæ˜¯æŒ‡å°†èµ„æºï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€å†…å­˜æˆ–ç£ç›˜ç©ºé—´ç­‰ç­‰ï¼‰çš„<strong>è¢«å¼•ç”¨æ¬¡æ•°</strong>ä¿å­˜èµ·æ¥ï¼Œå½“è¢«å¼•ç”¨æ¬¡æ•°<strong>å˜ä¸ºé›¶</strong>æ—¶å°±å°†å…¶<strong>é‡Šæ”¾</strong>çš„è¿‡ç¨‹ã€‚ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å¯ä»¥å®ç°è‡ªåŠ¨èµ„æºç®¡ç†çš„ç›®çš„ã€‚åŒæ—¶å¼•ç”¨è®¡æ•°è¿˜å¯ä»¥æŒ‡ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å›æ”¶æœªä½¿ç”¨èµ„æºçš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p><h2 id="3-1-å¼•ç”¨è®¡æ•°è§„åˆ™"><a href="#3-1-å¼•ç”¨è®¡æ•°è§„åˆ™" class="headerlink" title="3.1 å¼•ç”¨è®¡æ•°è§„åˆ™"></a>3.1 å¼•ç”¨è®¡æ•°è§„åˆ™</h2><ol><li>è‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±æŒæœ‰ã€‚ï¼ˆalloc,new,copy,mutableCopyç­‰ï¼‰</li><li>éè‡ªå·±ç”Ÿæˆçš„å¯¹è±¡ï¼Œè‡ªå·±ä¹Ÿèƒ½æŒæœ‰ã€‚ï¼ˆretain ç­‰ï¼‰</li><li>ä¸å†éœ€è¦è‡ªå·±æŒæœ‰çš„å¯¹è±¡æ—¶é‡Šæ”¾ã€‚ï¼ˆreleaseï¼Œdealloc ç­‰ï¼‰</li><li>éè‡ªå·±æŒæœ‰çš„å¯¹è±¡æ— æ³•é‡Šæ”¾ã€‚</li></ol><h2 id="3-2-allocå¼•èµ·å¼•ç”¨è®¡æ•°-1-çš„åŸå› "><a href="#3-2-allocå¼•èµ·å¼•ç”¨è®¡æ•°-1-çš„åŸå› " class="headerlink" title="3.2 allocå¼•èµ·å¼•ç”¨è®¡æ•°+1 çš„åŸå› "></a>3.2 allocå¼•èµ·å¼•ç”¨è®¡æ•°+1 çš„åŸå› </h2><p>ç­”æ¡ˆçœ‹æºç ï¼š</p><img src="../assets/images/å†…å­˜ç®¡ç†_retaincount_alloc2.png" alt="retaincount" style="zoom:80%;"><img src="../assets/images/å†…å­˜ç®¡ç†_retaincount_alloc1.png" alt="retaincount" style="zoom:80%;"><h1 id="4-Autoreleasepool"><a href="#4-Autoreleasepool" class="headerlink" title="4. Autoreleasepool"></a>4. Autoreleasepool</h1><h2 id="4-1-ä»€ä¹ˆæ˜¯Autoreleasepool"><a href="#4-1-ä»€ä¹ˆæ˜¯Autoreleasepool" class="headerlink" title="4.1 ä»€ä¹ˆæ˜¯Autoreleasepool?"></a>4.1 ä»€ä¹ˆæ˜¯Autoreleasepool?</h2><p>è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ <code>Objective-C</code> å¼€å‘ä¸­çš„ä¸€ç§è‡ªåŠ¨å†…å­˜å›æ”¶ç®¡ç†çš„æœºåˆ¶ï¼Œä¸ºäº†æ›¿ä»£å¼€å‘äººå‘˜æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œå®è´¨ä¸Šæ˜¯ä½¿ç”¨ç¼–è¯‘å™¨åœ¨é€‚å½“çš„ä½ç½®æ’å…¥<code>release</code>ã€<code>autorelease</code>ç­‰å†…å­˜é‡Šæ”¾æ“ä½œã€‚å½“å¯¹è±¡è°ƒç”¨ <code>autorelease </code>æ–¹æ³•åä¼šè¢«æ”¾åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­å»¶è¿Ÿé‡Šæ”¾æ—¶æœºï¼Œå½“ç¼“å­˜æ± éœ€è¦æ¸…é™¤<code>dealloc</code>æ—¶ï¼Œä¼šå‘è¿™äº› <code>Autoreleased </code>å¯¹è±¡åš <code>release</code> é‡Šæ”¾æ“ä½œã€‚</p><h2 id="4-2-å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾"><a href="#4-2-å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾" class="headerlink" title="4.2 å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾"></a>4.2 å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾</h2><p>ä»¥ä¸‹Aã€Bä¸¤ç§æƒ…å†µpersonåˆ†åˆ«ä»€ä¹ˆæ—¶å€™é‡Šæ”¾(deallocè§¦å‘æ—¶æœº)ï¼Ÿ</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// A:</span><br><span class="line">__weak id temp = nil;</span><br><span class="line">{</span><br><span class="line">    Person *person = [[Person alloc] init];</span><br><span class="line">    temp = person;</span><br><span class="line">}</span><br><span class="line">// æ’å…¥çš„releaseæ“ä½œ</span><br><span class="line"> // call void @llvm.objc.storeStrong(i8** %19, i8* null) #3  ----retainCount == 0ï¼Œdealloc</span><br><span class="line">// æ’å…¥NSLog ä¼ å…¥weakå˜é‡æ“ä½œ</span><br><span class="line"> // %20 = call i8* @llvm.objc.loadWeakRetained(i8** %6) #3</span><br><span class="line">NSLog(@"temp = %@",temp);</span><br><span class="line">// æ’å…¥ weak releaseå’Œdestory</span><br><span class="line"> // call void @llvm.objc.release(i8* %20) #3, !clang.imprecise_release !10</span><br><span class="line"> // call void @llvm.objc.destroyWeak(i8** %6) #3</span><br><span class="line"> // call void @llvm.objc.autoreleasePoolPop(i8* %10)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç­”æ¡ˆï¼š</p><blockquote><p>å…ˆæ‰“å°ï¼š [person dealloc]</p><p>åæ‰“å°ï¼š temp = ï¼ˆnullï¼‰</p><p>retainCount å‡åˆ°0ï¼Œç«‹å³é‡Šæ”¾ï¼Œè§¦å‘dealloc</p></blockquote><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// B:</span><br><span class="line"></span><br><span class="line">+(instancetype)defaultPerson</span><br><span class="line">{</span><br><span class="line">    return [[Person alloc] init];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">__weak id temp = nil;</span><br><span class="line">{</span><br><span class="line">    Person *person = [Person defaultPerson]; </span><br><span class="line">   // %16 = notail call i8* @llvm.objc.retainAutoreleasedReturnValue(i8* %14) #3 ----retainCount == 2ï¼ŒretainAutoreleasedReturnValueä¸­è°ƒäº†objc_retain(obj);</span><br><span class="line"></span><br><span class="line">    temp = person;</span><br><span class="line">}</span><br><span class="line"> // call void @llvm.objc.storeStrong(i8** %21, i8* null) #3 ----retainCount == 1ï¼Œå»¶è¿Ÿé‡Šæ”¾</span><br><span class="line"> // %22 = call i8* @llvm.objc.loadWeakRetained(i8** %6) #3</span><br><span class="line">//  invoke void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_.35 to i8*), i8* %22) to label %23 unwind label %24</span><br><span class="line">NSLog(@"temp = %@",temp);</span><br><span class="line">//   call void @llvm.objc.release(i8* %22) #3, !clang.imprecise_release !10</span><br><span class="line">//  call void @llvm.objc.destroyWeak(i8** %6) #3</span><br><span class="line">//  call void @llvm.objc.autoreleasePoolPop(i8* %10)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç­”æ¡ˆï¼š</p><blockquote><p>å…ˆæ‰“å°ï¼š temp = <strong>&lt;Person: 0x10133d460&gt;</strong></p><p>åæ‰“å°ï¼š [person dealloc]</p><p>retainCountå‡åˆ°1ï¼Œå¯¹è±¡å»¶è¿Ÿé‡Šæ”¾ï¼Œç­‰åˆ°autoreleasepool popæ—¶ï¼Œå‘poolå†…çš„å¯¹è±¡å‘realseæ¶ˆæ¯å‡åˆ°0æ‰é‡Šæ”¾ï¼›</p></blockquote><h2 id="4-3-AutoreleasePoolçš„ä½¿ç”¨"><a href="#4-3-AutoreleasePoolçš„ä½¿ç”¨" class="headerlink" title="4.3 AutoreleasePoolçš„ä½¿ç”¨"></a>4.3 AutoreleasePoolçš„ä½¿ç”¨</h2><p><strong>åˆå§‹åŒ–oråˆ›å»º</strong></p><p>MRCä¸‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//1.ç”Ÿæˆä¸€ä¸ªNSAutoreleasePoolå¯¹è±¡</span><br><span class="line">NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span><br><span class="line">//2.åˆ›å»ºå¯¹è±¡</span><br><span class="line">id object = [[NSObject alloc] init];</span><br><span class="line">//3.å¯¹è±¡è°ƒç”¨autoreleaseæ–¹æ³•</span><br><span class="line">[object autorelease];</span><br><span class="line">//4.åºŸå¼ƒNSAutoreleasePoolå¯¹è±¡ï¼Œä¼šå¯¹é‡Šæ”¾æ± ä¸­çš„objectå‘é€releaseæ¶ˆæ¯</span><br><span class="line">[pool drain];</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ARC:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool {</span><br><span class="line">    //LLVMä¼šåœ¨å†…éƒ¨æ’å…¥autoreleaseæ–¹æ³•</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="TODO-é¢è¯•é¢˜ï¼š"><a href="#TODO-é¢è¯•é¢˜ï¼š" class="headerlink" title="TODO: é¢è¯•é¢˜ï¼š"></a>TODO: é¢è¯•é¢˜ï¼š</h3><p>ä»¥ä¸‹ä»£ç æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ</p><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YLAnimal</span></span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc {</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>,__func__);</span><br><span class="line">}</span><br><span class="line">+ (<span class="keyword">instancetype</span>)animal {</span><br><span class="line">  YLAnimal *ani = [YLAnimal alloc];</span><br><span class="line">  <span class="keyword">return</span> ani;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// A</span></span><br><span class="line"><span class="keyword">@autoreleasepool</span> {</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">id</span> temp = <span class="literal">nil</span>;</span><br><span class="line">  {</span><br><span class="line">    YLAnimal *animal = [[YLAnimal alloc] init];</span><br><span class="line">    temp = animal;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"temp = %@"</span>,temp);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// B</span></span><br><span class="line"><span class="keyword">@autoreleasepool</span> {</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">id</span> temp = <span class="literal">nil</span>;</span><br><span class="line">  {</span><br><span class="line">      YLAnimal *animal = [YLAnimal animal];</span><br><span class="line">      temp = animal;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"temp = %@"</span>,temp);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç­”ï¼š<code>alloc</code>æ–¹æ³•åˆå§‹åŒ– çš„animalä¸ä¼šåŠ å…¥åˆ°autoreleasepoolä¸­ï¼Œè¶…å‡ºä½œç”¨åŸŸåï¼Œretaincountå‡ä¸º0ï¼Œç«‹å³é‡Šæ”¾ï¼›</p><p><code>anima</code>æ–¹æ³•åˆå§‹åŒ–çš„animalä¼šåŠ å…¥åˆ°autoreleasepoolä¸­ï¼Œè¶…å‡ºä½œç”¨åŸŸåï¼Œå»¶è¿Ÿåˆ°autoreleasepool popï¼Œæ‰ä¼šé‡Šæ”¾;</p><blockquote><p>å¼•ç”³ï¼š</p><p>åŠ å…¥åˆ°autoreleasepoolçš„å¯¹è±¡ä¸€å®šä¼šé‡Šæ”¾å—ï¼Ÿ</p><p>ç­”ï¼šä¸ä¸€å®šï¼Œautoreleasepoolé”€æ¯æ—¶åªæ˜¯å¯¹å…¶å†…éƒ¨å¯¹è±¡å‘é€releaseæ¶ˆæ¯ï¼Œå¼•ç”¨è®¡æ•°å‡1ï¼Œæ­¤æ—¶è‹¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡å®Œåä¸ä¸º0ï¼Œå°±ä¸ä¼šè¢«é‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å†…å­˜æ³„æ¼ã€‚</p><p>å¼•å‘å†…å­˜æ³„æ¼çš„æƒ…å†µæœ‰å“ªäº›ï¼Ÿ</p><ul><li>å¾ªç¯å¼•ç”¨ï¼š<ul><li>block</li><li>A â€“&gt; B â€“&gt; A</li><li>A â€“&gt; B â€“&gt; C â€“&gt; A</li><li>NSObserver center (<font color="red">å¾…è¡¥å……</font>) </li></ul></li><li>NSObserver center (<font color="red">å¾…è¡¥å……</font>) </li><li></li></ul></blockquote><h2 id="4-4-ARCä¸‹-autoreleasepool-è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆ"><a href="#4-4-ARCä¸‹-autoreleasepool-è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆ" class="headerlink" title="4.4  ARCä¸‹@autoreleasepool {} è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆ"></a>4.4  ARCä¸‹<code>@autoreleasepool {} </code>è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆ</h2><p>ä½¿ç”¨clangå‘½ä»¤å°†main.mç¼–è¯‘æˆmain.cppï¼ŒæŸ¥çœ‹ç›¸å…³ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–è¯‘å‰ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>{</span><br><span class="line">    @autoreleasepool {</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼–è¯‘åï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>{</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> { __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯è§ï¼Œç¼–è¯‘åæŠŠ<code>@autoreleasePool</code>è½¬æ¢æˆä¸€ä¸ª<code>__AtAutoreleasePool </code>ç±»å‹çš„å±€éƒ¨ç§æœ‰å˜é‡<code>__AtAutoreleasePool __autoreleasepool</code>;ç„¶åæŸ¥çœ‹ä¸€ä¸‹<code>__AtAutoreleasePool</code>æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å¯¹åº”main.cppæ–‡ä»¶ï¼Œmainå‡½æ•°å‰é¢æœ‰<code>__AtAutoreleasePool</code>æºç ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">AtAutoreleasePool</span> {</span></span><br><span class="line">  __AtAutoreleasePool() {atautoreleasepoolobj = <span class="built_in">objc_autoreleasePoolPush</span>();}</span><br><span class="line">  ~__AtAutoreleasePool() {<span class="built_in">objc_autoreleasePoolPop</span>(atautoreleasepoolobj);}</span><br><span class="line">  <span class="keyword">void</span> * atautoreleasepoolobj;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><code>__AtAutoreleasePool</code>æ˜¯ç»“æ„ä½“ç±»å‹ï¼Œå…¶å†…åŒ…å«ï¼š</p><ul><li>æ„é€ å‡½æ•°<code>__AtAutoreleasePool()</code></li><li>ææ„å‡½æ•°<code>~__AtAutoreleasePool(atautoreleasepoolobj)</code>ã€‚</li><li>atautoreleasepoolobj (å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<code>POOL_BOUNDARY</code>æ¡©å¯¹è±¡ï¼Œææ„æ—¶ï¼Œä»¥æ­¤å¯¹è±¡ä¸ºå‚ç…§ç‰©å‘æ­¤å¯¹è±¡ä¹‹åæ’å…¥çš„å¯¹è±¡å…¨éƒ¨å‘é€releaseæ¶ˆæ¯)</li></ul><p>å…³äº<code>@autoreleasepool</code>å°±è¿™äº›ï¼Œæ¥ä¸‹æ¥æ˜¯<code>objc_autoreleasePoolPush()</code> ã€<code>objc_autoreleasePoolPop(obj)</code>çš„å®ç°ï¼Œå³å…³äº<code>AutoreleasepoolPage</code>çš„æ¢ç´¢ï¼›</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::<span class="built_in">push</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">NEVER_INLINE</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="keyword">void</span> *ctxt)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    AutoreleasePoolPage::<span class="built_in">pop</span>(ctxt);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="5-AutoreleasepoolPage"><a href="#5-AutoreleasepoolPage" class="headerlink" title="5. AutoreleasepoolPage"></a>5. AutoreleasepoolPage</h1><h2 id="5-1-å†…å­˜ç»“æ„"><a href="#5-1-å†…å­˜ç»“æ„" class="headerlink" title="5.1 å†…å­˜ç»“æ„"></a>5.1 å†…å­˜ç»“æ„</h2><h3 id="AutoreleasepoolPageåœ¨å†…å­˜ä¸­ä»¥åŒå‘é“¾è¡¨å½¢å¼å­˜åœ¨ï¼Œå¦‚å›¾ï¼š"><a href="#AutoreleasepoolPageåœ¨å†…å­˜ä¸­ä»¥åŒå‘é“¾è¡¨å½¢å¼å­˜åœ¨ï¼Œå¦‚å›¾ï¼š" class="headerlink" title="AutoreleasepoolPageåœ¨å†…å­˜ä¸­ä»¥åŒå‘é“¾è¡¨å½¢å¼å­˜åœ¨ï¼Œå¦‚å›¾ï¼š"></a>AutoreleasepoolPageåœ¨å†…å­˜ä¸­ä»¥åŒå‘é“¾è¡¨å½¢å¼å­˜åœ¨ï¼Œå¦‚å›¾ï¼š</h3><p><img src="../assets/images/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-AutoreleasePoolPage_0.png" alt="åŒå‘é“¾è¡¨"></p><h3 id="å•ä¸ªpageçš„å†…å­˜å½¢æ€"><a href="#å•ä¸ªpageçš„å†…å­˜å½¢æ€" class="headerlink" title="å•ä¸ªpageçš„å†…å­˜å½¢æ€"></a>å•ä¸ªpageçš„å†…å­˜å½¢æ€</h3><img src="../assets/images/å†…å­˜ç®¡ç†-autoreleasepage_1.png" alt="AutoreleasepoolPage" style="zoom:80%;"><p><code>next</code> æŒ‡å‘äº†ä¸‹ä¸€ä¸ªä¸ºç©ºçš„å†…å­˜åœ°å€ï¼Œå¦‚æœ <code>next</code> æŒ‡å‘çš„åœ°å€åŠ å…¥ä¸€ä¸ª <code>object</code>ï¼Œå®ƒå°±ä¼šå¦‚ä¸‹å›¾æ‰€ç¤º<strong>ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä¸ºç©ºçš„å†…å­˜åœ°å€ä¸­</strong>ï¼š</p><blockquote><p>æ³¨æ„ï¼šå„å˜é‡åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼›</p></blockquote><h2 id="5-2-AutoreleasePoolPageéƒ¨åˆ†å…³é”®æºç "><a href="#5-2-AutoreleasePoolPageéƒ¨åˆ†å…³é”®æºç " class="headerlink" title="5.2  AutoreleasePoolPageéƒ¨åˆ†å…³é”®æºç "></a>5.2  AutoreleasePoolPageéƒ¨åˆ†å…³é”®æºç </h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span> :</span> <span class="keyword">private</span> AutoreleasePoolPageData</span><br><span class="line">{</span><br><span class="line"><span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">thread_data_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> SIZE =</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PROTECT_AUTORELEASEPOOL</span></span><br><span class="line">PAGE_MAX_SIZE;  <span class="comment">// must be multiple of vm page size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">PAGE_MIN_SIZE;  <span class="comment">// size and alignment, power of 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_key_t</span> <span class="keyword">const</span> key = AUTORELEASE_POOL_KEY;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="keyword">const</span> SCRIBBLE = <span class="number">0xA3</span>;  <span class="comment">// 0xA3A3A3A3 after releasing</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> COUNT = SIZE / <span class="built_in"><span class="keyword">sizeof</span></span>(id);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> MAX_FAULTS = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// EMPTY_POOL_PLACEHOLDER is stored in TLS when exactly one pool is </span></span><br><span class="line">    <span class="comment">// pushed and it has never contained any objects. This saves memory </span></span><br><span class="line">    <span class="comment">// when the top level (i.e. libdispatch) pushes and pops pools but </span></span><br><span class="line">    <span class="comment">// never uses them.</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> EMPTY_POOL_PLACEHOLDER ((id*)1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> POOL_BOUNDARY nil</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">AutoreleasePoolPage</span>(AutoreleasePoolPage *newParent) :</span><br><span class="line"><span class="built_in">AutoreleasePoolPageData</span>(<span class="built_in">begin</span>(),</span><br><span class="line"><span class="built_in">objc_thread_self</span>(),</span><br><span class="line">newParent,</span><br><span class="line">newParent ? <span class="number">1</span>+newParent-&gt;depth : <span class="number">0</span>,</span><br><span class="line">newParent ? newParent-&gt;hiwat : <span class="number">0</span>){ }</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">AutoreleasePoolPage</span>(){}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function">id *<span class="title">add</span><span class="params">(id obj)</span></span>{}</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">void</span> *token)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> AutoreleasePoolPage *<span class="title">hotPage</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">setHotPage</span><span class="params">(AutoreleasePoolPage *page)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">static</span> <span class="keyword">inline</span> AutoreleasePoolPage *<span class="title">coldPage</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    .</span></span><br><span class="line"><span class="function">    .</span></span><br><span class="line"><span class="function">    .</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">}</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AutoreleasePoolPageData</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_AUTORELEASEPOOL_DEDUP_PTRS</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AutoreleasePoolEntry</span> {</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> ptr: <span class="number">48</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> count: <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uintptr_t</span> maxCount = <span class="number">65535</span>; <span class="comment">// 2^16 - 1</span></span><br><span class="line">    };</span><br><span class="line">    <span class="built_in"><span class="keyword">static_assert</span></span>((AutoreleasePoolEntry){ .ptr = MACH_VM_MAX_ADDRESS }.ptr == MACH_VM_MAX_ADDRESS, <span class="string">"MACH_VM_MAX_ADDRESS doesn't fit into AutoreleasePoolEntry::ptr!"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">magic_t</span> <span class="keyword">const</span> magic; <span class="comment">//ç”¨æ¥æ ¡éªŒ `AutoreleasePoolPage`çš„ç»“æ„æ˜¯å¦å®Œæ•´ï¼›16</span></span><br><span class="line">__unsafe_unretained id *next; <span class="comment">//æŒ‡å‘æœ€æ–°æ·»åŠ çš„ `autoreleased` å¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘  `begin()` ï¼›8</span></span><br><span class="line"><span class="keyword">pthread_t</span> <span class="keyword">const</span> thread;  <span class="comment">//æŒ‡å‘å½“å‰çº¿ç¨‹ï¼›8</span></span><br><span class="line">AutoreleasePoolPage * <span class="keyword">const</span> parent;    <span class="comment">//æŒ‡å‘çˆ¶ç»“ç‚¹ï¼Œç¬¬ä¸€ä¸ªç»“ç‚¹çš„ `parent` å€¼ä¸º `nil` ï¼›8</span></span><br><span class="line">AutoreleasePoolPage *child;     <span class="comment">//æŒ‡å‘å­ç»“ç‚¹ï¼Œæœ€åä¸€ä¸ªç»“ç‚¹çš„ `child` å€¼ä¸º `nil` ï¼›8</span></span><br><span class="line"><span class="keyword">uint32_t</span> <span class="keyword">const</span> depth;  <span class="comment">//ä»£è¡¨æ·±åº¦ï¼Œä» `0` å¼€å§‹ï¼Œå¾€åé€’å¢ `1`ï¼›4</span></span><br><span class="line"><span class="keyword">uint32_t</span> hiwat; <span class="comment">//ä»£è¡¨ `high water mark` ; 4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">AutoreleasePoolPageData</span>(__unsafe_unretained id* _next, <span class="keyword">pthread_t</span> _thread, AutoreleasePoolPage* _parent, <span class="keyword">uint32_t</span> _depth, <span class="keyword">uint32_t</span> _hiwat)</span><br><span class="line">: <span class="built_in">magic</span>(), <span class="built_in">next</span>(_next), <span class="built_in">thread</span>(_thread),</span><br><span class="line">  <span class="built_in">parent</span>(_parent), <span class="built_in">child</span>(nil),</span><br><span class="line">  <span class="built_in">depth</span>(_depth), <span class="built_in">hiwat</span>(_hiwat)</span><br><span class="line">{</span><br><span class="line">}</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><strong>é€šè¿‡æºç ç›´è§‚å¯è§ï¼š</strong></p><ol><li><code>AutoreleasePoolPage</code>æ˜¯ç»§æ‰¿è‡ª<code>AutoreleasePoolPageData</code>ã€‚</li><li><code>AutoreleasePoolPageData</code>æœ‰ä¸€ä¸ªparentã€ä¸€ä¸ªchildå˜é‡ï¼Œåˆ†åˆ«æ˜¯ä¸€ä¸ª<code>AutoreleasePoolPage</code>æŒ‡é’ˆã€‚</li><li>æ¯ä¸€ä¸ª<code>AutoreleasePoolPageData</code>éƒ½å¯¹åº”ä¸€ä¸ªpthread_tçº¿ç¨‹</li><li><code>AutoreleasePoolPageData</code>ç»“æ„ä½“çš„å¤§å°ä¸º56å­—èŠ‚</li></ol><h3 id="5-2-1-AutoreleasePoolPage-push"><a href="#5-2-1-AutoreleasePoolPage-push" class="headerlink" title="5.2.1 AutoreleasePoolPage::push()"></a>5.2.1 AutoreleasePoolPage::push()</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        id *dest;</span><br><span class="line">          <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–AutoreleasePoolPageï¼Œslowpath()ä¸ºå°æ¦‚ç‡å‘ç”Ÿäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">slowpath</span>(DebugPoolAllocation)) {</span><br><span class="line">            <span class="comment">// Each autorelease pool starts on a new pool page.</span></span><br><span class="line">            dest = <span class="built_in">autoreleaseNewPage</span>(POOL_BOUNDARY); </span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            dest = <span class="built_in">autoreleaseFast</span>(POOL_BOUNDARY);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// â¬†ï¸ è¿™é‡Œçš„POOL_BOUNDARYå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å“¨å…µå¯¹è±¡</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY);</span><br><span class="line">        <span class="keyword">return</span> dest;</span><br><span class="line">    }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="å…³äºâ€autoreleaseFastâ€æ ¸å¿ƒæ–¹æ³•çš„æ¦‚æ‹¬ï¼š"><a href="#å…³äºâ€autoreleaseFastâ€æ ¸å¿ƒæ–¹æ³•çš„æ¦‚æ‹¬ï¼š" class="headerlink" title="å…³äºâ€autoreleaseFastâ€æ ¸å¿ƒæ–¹æ³•çš„æ¦‚æ‹¬ï¼š"></a>å…³äºâ€autoreleaseFastâ€æ ¸å¿ƒæ–¹æ³•çš„æ¦‚æ‹¬ï¼š</h5><ul><li><p>autoreleaseFullPage() ; // hotpageå·²æ»¡: å¦‚æœå­é¡µé¢å­˜åœ¨ï¼Œåˆ™å°†é¡µé¢æ›¿æ¢ä¸ºå­é¡µé¢;ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°é¡µé¢</p></li><li><p>autoreleaseNoPage()ï¼›// hotpageä¸å­˜åœ¨;</p><blockquote><p>ç¬¬ä¸€æ­¥ï¼šå…ˆåˆ¤æ–­â€œæ˜¯å¦æœ‰ç©ºå ä½ç¬¦â€ï¼Œç„¶åè¯¥æ ‡è®°æ ‡è®°ï¼Œè¯¥æŠ¥é”™æŠ¥é”™ï¼Œè¯¥è¿”å›empty pool placeholderè¿”å›empty pool placeholderï¼›</p><p>ç¬¬äºŒæ­¥ï¼šç¡®ä¿å ä½ç¬¦çŠ¶æ€okï¼Œä¸”å·²ç»æœ‰äº†boundaryï¼Œç„¶ååˆå§‹åŒ–ä¸€ä¸ªpageï¼Œå¹¶è®¾ç½®ä¸ºhotPageï¼›</p><p>ç¬¬ä¸‰æ­¥ï¼špageå’Œå ä½ç¬¦éƒ½å°±ç»ªï¼Œå…ˆæ’å…¥boundryå¯¹è±¡ï¼Œå†add(obj)</p></blockquote></li><li><p>add(objï¼‰ï¼›// hotpageå­˜åœ¨ï¼Œä¸”æœªæ»¡ï¼šå°†å½“å‰å¯¹è±¡åŠ å…¥poolä¸­ï¼›(ç–‘é—®â“ è¿™é‡Œè¿”å›çš„æ˜¯è°çš„æŒ‡é’ˆ)</p></li></ul><h4 id="autoreleaseNewPage-æ–¹æ³•â€“å°æ¦‚ç‡å‘ç”Ÿäº‹ä»¶"><a href="#autoreleaseNewPage-æ–¹æ³•â€“å°æ¦‚ç‡å‘ç”Ÿäº‹ä»¶" class="headerlink" title="autoreleaseNewPage()æ–¹æ³•â€“å°æ¦‚ç‡å‘ç”Ÿäº‹ä»¶"></a>autoreleaseNewPage()æ–¹æ³•â€“å°æ¦‚ç‡å‘ç”Ÿäº‹ä»¶</h4><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __attribute__((noinline))</span><br><span class="line"><span class="function">id *<span class="title">autoreleaseNewPage</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//è·å–å½“å‰hotpage</span></span><br><span class="line">    AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰é¡µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å‹æ ˆå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (page) <span class="keyword">return</span> <span class="built_in">autoreleaseFullPage</span>(obj, page);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºpage</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="built_in">autoreleaseNoPage</span>(obj);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></blockquote><h4 id="autoreleaseFast-æ–¹æ³•â€“å¤§æ¦‚ç‡å‘ç”Ÿäº‹ä»¶"><a href="#autoreleaseFast-æ–¹æ³•â€“å¤§æ¦‚ç‡å‘ç”Ÿäº‹ä»¶" class="headerlink" title="autoreleaseFast()æ–¹æ³•â€“å¤§æ¦‚ç‡å‘ç”Ÿäº‹ä»¶"></a>autoreleaseFast()æ–¹æ³•â€“å¤§æ¦‚ç‡å‘ç”Ÿäº‹ä»¶</h4><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> id *<span class="title">autoreleaseFast</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">    <span class="keyword">if</span> (page &amp;&amp; !page-&gt;<span class="built_in">full</span>()) {</span><br><span class="line">        <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (page) {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseFullPage</span>(obj, page);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseNoPage</span>(obj);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></blockquote><h6 id="autoreleaseFullPage-æ–¹æ³•"><a href="#autoreleaseFullPage-æ–¹æ³•" class="headerlink" title="autoreleaseFullPage() æ–¹æ³•"></a>autoreleaseFullPage() æ–¹æ³•</h6><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> __attribute__((noinline))</span><br><span class="line"><span class="function">id *<span class="title">autoreleaseFullPage</span><span class="params">(id obj, AutoreleasePoolPage *page)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// The hot page is full. </span></span><br><span class="line">    <span class="comment">// Step to the next non-full page, adding a new page if necessary.</span></span><br><span class="line">    <span class="comment">// Then add the object to that page.</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(page == <span class="built_in">hotPage</span>());</span><br><span class="line">    <span class="built_in">ASSERT</span>(page-&gt;<span class="built_in">full</span>()  ||  DebugPoolAllocation);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//éå†å¾ªç¯æŸ¥æ‰¾pageæ˜¯å¦å·²æ»¡</span></span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="comment">//å¦‚æœå­é¡µé¢å­˜åœ¨ï¼Œåˆ™å°†é¡µé¢æ›¿æ¢ä¸ºå­é¡µé¢</span></span><br><span class="line">        <span class="keyword">if</span> (page-&gt;child) page = page-&gt;child;</span><br><span class="line">        <span class="comment">//å¦‚æœå­é¡µé¢ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°é¡µé¢</span></span><br><span class="line">        <span class="keyword">else</span> page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(page);</span><br><span class="line">    } <span class="keyword">while</span> (page-&gt;<span class="built_in">full</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸ºå½“å‰hotPage</span></span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    <span class="comment">//å¯¹è±¡å‹æ ˆ</span></span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="autoreleaseNoPage-æ–¹æ³•"><a href="#autoreleaseNoPage-æ–¹æ³•" class="headerlink" title="autoreleaseNoPage()æ–¹æ³•"></a>autoreleaseNoPage()æ–¹æ³•</h6><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __attribute__((noinline))</span><br><span class="line"><span class="function">id *<span class="title">autoreleaseNoPage</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// "No page" could mean no pool has been pushed</span></span><br><span class="line">    <span class="comment">// or an empty placeholder pool has been pushed and has no contents yet</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(!<span class="built_in">hotPage</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> pushExtraBoundary = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºå ä½ç¬¦ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å‹æ ˆå“¨å…µæ ‡è¯†ç¬¦ç½®ä¸ºYES</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">haveEmptyPoolPlaceholder</span>()) {</span><br><span class="line">        pushExtraBoundary = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//å¦‚æœå¯¹è±¡ä¸æ˜¯å“¨å…µå¯¹è±¡ï¼Œä¸”æ²¡æœ‰Poolï¼Œåˆ™æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools) {</span><br><span class="line">        _objc_inform(<span class="string">"MISSING POOLS: (%p) Object %p of class %s "</span></span><br><span class="line">                     <span class="string">"autoreleased with no pool in place - "</span></span><br><span class="line">                     <span class="string">"just leaking - break on "</span></span><br><span class="line">                     <span class="string">"objc_autoreleaseNoPool() to debug"</span>, </span><br><span class="line">                     <span class="built_in">objc_thread_self</span>(), (<span class="keyword">void</span>*)obj, <span class="built_in">object_getClassName</span>(obj));</span><br><span class="line">        <span class="built_in">objc_autoreleaseNoPool</span>(obj);</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//å¦‚æœå¯¹è±¡æ˜¯å“¨å…µå¯¹è±¡ï¼Œä¸”æ²¡æœ‰ç”³è¯·è‡ªåŠ¨é‡Šæ”¾æ± å†…å­˜ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªç©ºå ä½ç¬¦å­˜å‚¨åœ¨tlsä¸­ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation) {</span><br><span class="line">        <span class="comment">// We are pushing a pool with no pool in place,</span></span><br><span class="line">        <span class="comment">// and alloc-per-pool debugging was not requested.</span></span><br><span class="line">        <span class="comment">// Install and return the empty pool placeholder.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setEmptyPoolPlaceholder</span>();<span class="comment">//è®¾ç½®ç©ºçš„å ä½ç¬¦</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We are pushing an object or a non-placeholder'd pool.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install the first page.</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ç¬¬ä¸€é¡µ</span></span><br><span class="line">    AutoreleasePoolPage *page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(nil);</span><br><span class="line">    <span class="comment">//è®¾ç½®pageä¸ºå½“å‰hotpage</span></span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Push a boundary on behalf of the previously-placeholder'd pool.</span></span><br><span class="line">    <span class="comment">//å‹æ ˆå“¨å…µçš„æ ‡è¯†ç¬¦ä¸ºYESï¼Œåˆ™å‹æ ˆå“¨å…µå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (pushExtraBoundary) {</span><br><span class="line">        <span class="comment">//å‹æ ˆå“¨å…µ</span></span><br><span class="line">        page-&gt;<span class="built_in">add</span>(POOL_BOUNDARY);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Push the requested object or pool.</span></span><br><span class="line">    <span class="comment">//å‹æ ˆå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h6 id="add-obj-æ–¹æ³•"><a href="#add-obj-æ–¹æ³•" class="headerlink" title="add(obj)æ–¹æ³•"></a>add(obj)æ–¹æ³•</h6><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">id *<span class="title">add</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">full</span>());</span><br><span class="line">    <span class="built_in">unprotect</span>();</span><br><span class="line">    id *ret = next;  <span class="comment">// faster than `return next-1` because of aliasing</span></span><br><span class="line">    *next++ = obj;</span><br><span class="line">    <span class="built_in">protect</span>();</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-2-AutoreleasePoolPage-pop"><a href="#5-2-2-AutoreleasePoolPage-pop" class="headerlink" title="5.2.2 AutoreleasePoolPage::pop()"></a>5.2.2 AutoreleasePoolPage::pop()</h3><img src="../assets/images/å†…å­˜ç®¡ç†-autoreleasepage_pop_0.png" alt="pop-0" style="zoom:80%;"><img src="../assets/images/å†…å­˜ç®¡ç†-autoreleasepage_pop_1.png" alt="pop-1" style="zoom:80%;"><img src="../assets/images/å†…å­˜ç®¡ç†-autoreleasepage_pop_2.png" alt="pop-2" style="zoom:80%;"><h5 id="å…¶ä¸­æ ¸å¿ƒä¸‰æ­¥ï¼š"><a href="#å…¶ä¸­æ ¸å¿ƒä¸‰æ­¥ï¼š" class="headerlink" title="å…¶ä¸­æ ¸å¿ƒä¸‰æ­¥ï¼š"></a>å…¶ä¸­æ ¸å¿ƒä¸‰æ­¥ï¼š</h5><ul><li>pageForPointer(token); æ ¹æ®ä¼ å…¥çš„å“¨å…µå¯¹è±¡çš„åœ°å€ï¼Œå–å¾—å“¨å…µå¯¹è±¡æ‰€åœ¨çš„pageåœ°å€ï¼›</li><li>releaseUntil(stop); æ‹¿hotPageé€ä¸€å‡1ï¼Œç›´åˆ°pageçš„nextæŒ‡å‘boundaryï¼›</li><li>page-&gt;kill(); æ–¹æ³•åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªpage</li></ul><h4 id="pageForPointer-æ–¹æ³•-â€”-æ ¹æ®å“¨å…µå¯¹è±¡æ‰¾åˆ°page"><a href="#pageForPointer-æ–¹æ³•-â€”-æ ¹æ®å“¨å…µå¯¹è±¡æ‰¾åˆ°page" class="headerlink" title="pageForPointer( ) æ–¹æ³• â€”- æ ¹æ®å“¨å…µå¯¹è±¡æ‰¾åˆ°page"></a>pageForPointer( ) æ–¹æ³• â€”- æ ¹æ®å“¨å…µå¯¹è±¡æ‰¾åˆ°page</h4><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> AutoreleasePoolPage *<span class="title">pageForPointer</span><span class="params">(<span class="keyword">uintptr_t</span> p)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    AutoreleasePoolPage *result;</span><br><span class="line">    <span class="keyword">uintptr_t</span> offset = p % SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ASSERT</span>(offset &gt;= <span class="built_in"><span class="keyword">sizeof</span></span>(AutoreleasePoolPage));</span><br><span class="line"></span><br><span class="line">    result = (AutoreleasePoolPage *)(p - offset);</span><br><span class="line">    result-&gt;<span class="built_in">fastcheck</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è§£è¯»ï¼š</p><ol><li>å“¨å…µå¯¹è±¡åœ°å€ä¸é¡µé¢size(4096)å–æ¨¡â€”&gt;å“¨å…µå¯¹è±¡çš„åç§»é‡</li><li>æ ¹æ®å“¨å…µå¯¹è±¡çš„åœ°å€å‡åç§»é‡ä¾¿å¯ä»¥å¾—åˆ°æ ¹pageçš„é¦–åœ°å€â€”&gt;å“¨å…µå¯¹è±¡æ‰€åœ¨pageé¡µ</li></ol></blockquote><h4 id="releaseUntil-stop-æ–¹æ³•-â€”-é‡Šæ”¾å¯¹è±¡"><a href="#releaseUntil-stop-æ–¹æ³•-â€”-é‡Šæ”¾å¯¹è±¡" class="headerlink" title="releaseUntil(stop)æ–¹æ³• â€”- é‡Šæ”¾å¯¹è±¡"></a>releaseUntil(stop)æ–¹æ³• â€”- é‡Šæ”¾å¯¹è±¡</h4><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseUntil</span><span class="params">(id *stop)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Not recursive: we don't want to blow out the stack </span></span><br><span class="line">    <span class="comment">// if a thread accumulates a stupendous amount of garbage</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡Šæ”¾AutoreleasePoolPageä¸­çš„å¯¹è±¡ï¼Œç›´åˆ°nextæŒ‡å‘stop</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;next != stop) {</span><br><span class="line">        <span class="comment">// Restart from hotPage() every time, in case -release </span></span><br><span class="line">        <span class="comment">// autoreleased more objects</span></span><br><span class="line">        <span class="comment">// hotPageå¯ä»¥ç†è§£ä¸ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„page</span></span><br><span class="line">        AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fixme I think this `while` can be `if`, but I can't prove it</span></span><br><span class="line">        <span class="keyword">while</span> (page-&gt;<span class="built_in">empty</span>()) {</span><br><span class="line">            page = page-&gt;parent;</span><br><span class="line">            <span class="built_in">setHotPage</span>(page);</span><br><span class="line">        }</span><br><span class="line">   </span><br><span class="line">        page-&gt;<span class="built_in">unprotect</span>();</span><br><span class="line">        <span class="comment">// obj = page-&gt;next; page-&gt;next--;</span></span><br><span class="line">     id obj = *--page-&gt;next;</span><br><span class="line">        <span class="built_in">memset</span>((<span class="keyword">void</span>*)page-&gt;next, SCRIBBLE, <span class="built_in"><span class="keyword">sizeof</span></span>(*page-&gt;next));</span><br><span class="line">        page-&gt;<span class="built_in">protect</span>();</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// POOL_BOUNDARYä¸ºnilï¼Œæ˜¯å“¨å…µå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (obj != POOL_BOUNDARY) {</span><br><span class="line">         <span class="comment">// é‡Šæ”¾objå¯¹è±¡</span></span><br><span class="line">            <span class="built_in">objc_release</span>(obj);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½®hotPage</span></span><br><span class="line">    <span class="built_in">setHotPage</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="comment">// we expect any children to be completely empty</span></span><br><span class="line"> <span class="keyword">for</span> (AutoreleasePoolPage *page = child; page; page = page-&gt;child) {</span><br><span class="line">     <span class="built_in">assert</span>(page-&gt;<span class="built_in">empty</span>());</span><br><span class="line">    }</span><br><span class="line">   <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure></blockquote><h4 id="kill-æ–¹æ³•-â€”-åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªpage"><a href="#kill-æ–¹æ³•-â€”-åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªpage" class="headerlink" title="kill()æ–¹æ³• â€”- åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªpage"></a>kill()æ–¹æ³• â€”- åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªpage</h4><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kill</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Not recursive: we don't want to blow out the stack </span></span><br><span class="line">    <span class="comment">// if a thread accumulates a stupendous amount of garbage</span></span><br><span class="line">    AutoreleasePoolPage *page = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°é“¾è¡¨æœ€æœ«å°¾çš„page</span></span><br><span class="line">    <span class="keyword">while</span> (page-&gt;child) page = page-&gt;child;</span><br><span class="line"></span><br><span class="line">    AutoreleasePoolPage *deathptr;</span><br><span class="line">    <span class="comment">// å¾ªç¯åˆ é™¤æ¯ä¸€ä¸ªpage</span></span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        deathptr = page;</span><br><span class="line">        page = page-&gt;parent;</span><br><span class="line">        <span class="keyword">if</span> (page) {</span><br><span class="line">            page-&gt;<span class="built_in">unprotect</span>();</span><br><span class="line">            page-&gt;child = nil;</span><br><span class="line">            page-&gt;<span class="built_in">protect</span>();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">delete</span> deathptr;</span><br><span class="line">    } <span class="keyword">while</span> (deathptr != <span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></blockquote><p><strong>é€šè¿‡æºç æ–¹æ³•å®ç°è§£è¯»çš„ï¼š</strong></p><ol><li><p><code>AutoreleasePoolPage</code>æ¯ä¸ªå¯¹è±¡ä¼šå¼€è¾Ÿ4096å­—èŠ‚å†…å­˜ï¼ˆè™šæ‹Ÿå†…å­˜ä¸€é¡µçš„å¤§å°ï¼‰</p></li><li><p>é™¤äº†ä¸Šé¢<code>AutoreleasePoolPageData</code>çš„å®ä¾‹å˜é‡ï¼ˆç»“æ„ä½“çš„å¤§å°ï¼‰æ‰€å ç©ºé—´ï¼Œå‰©ä¸‹çš„ç©ºé—´å…¨éƒ¨ç”¨æ¥å‚¨å­˜<code>autorelease</code>å¯¹è±¡çš„åœ°å€</p><blockquote><p>ï¼ˆæ³¨æ„ï¼Œ<code>AutoreleasePoolPage</code>çš„ç¬¬ä¸€é¡µä¼šåŒ…å«å“¨å…µå¯¹è±¡ï¼Œå“¨å…µå¯¹è±¡å ä½8å­—èŠ‚ï¼Œç°æ¯ä¸ªåŠ å…¥çš„å¯¹è±¡ä¸º8å­—èŠ‚ï¼Œé‚£ä¹ˆç¬¬ä¸€é¡µæœ€å¤šå¯ä»¥å­˜å‚¨504ä¸ªå¯¹è±¡ï¼Œä»ç¬¬äºŒé¡µå¼€å§‹æœ€å¤šå¯ä»¥å­˜å‚¨505ä¸ªå¯¹è±¡ã€‚ï¼‰</p></blockquote></li><li><p><code>AutoreleasepoolPage </code>é€šè¿‡å‹æ ˆçš„æ–¹å¼æ¥å­˜å‚¨æ¯ä¸ª<code>autorelease</code>çš„å¯¹è±¡(<font color="red">ä»ä½åœ°å€åˆ°é«˜åœ°å€</font>)ã€‚</p></li><li><p><code>next</code>æŒ‡é’ˆä½œä¸ºæ¸¸æ ‡æŒ‡å‘æ ˆé¡¶æœ€æ–°<code>add</code>è¿›æ¥çš„<code>autorelease</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®,</p><blockquote><p>å½“ <code>next</code>æŒ‡é’ˆæŒ‡å‘<code>begin</code>æ—¶ï¼Œè¡¨ç¤º <code>AutoreleasePoolPage </code>ä¸ºç©ºï¼›</p><p>å½“ <code>next</code>æŒ‡é’ˆæŒ‡å‘<code>end</code>æ—¶ï¼Œè¡¨ç¤º <code>AutoreleasePoolPage</code> å·²æ»¡;</p></blockquote></li><li><p>å½“å‘<code>AutoreleasePool</code>ä¸­æ–°å¢<code>autorelease</code>å¯¹è±¡æ—¶ï¼Œåº•å±‚<code>autoreleaseFast</code>å‡½æ•°å†…ä¼šï¼š</p><ul><li>å½“å‰<code>AutoreleasePoolPage</code>æ²¡æ»¡ï¼šç›´æ¥å°†è¯¥å¯¹è±¡æ’å…¥æ­¤pageä¸­</li><li>å½“å‰<code>AutoreleasePoolPage</code>æ»¡äº†ï¼šæ–°å»ºä¸€ä¸ª<code>AutoreleasePoolPage</code>å¯¹è±¡(ä½œä¸ºchildï¼Œè‡ªç„¶åŸæ¥çš„pageå˜æˆäº†parent)ï¼Œå¹¶è®¾ç½®<code>child</code>ä¸º<code>hotPage</code>ï¼Œ<code>parent</code>ä¸º<code>coldPage</code>ï¼Œå°†è¯¥å¯¹è±¡æ’å…¥hotPageä¸­ï¼›</li><li>å½“å‰<code>AutoreleasePoolPage</code>ä¸ºç©ºï¼šæ–°å»ºä¸€ä¸ª<code>AutoreleasePoolPage</code>å¯¹è±¡ï¼Œè®¾ç½®ä¸ºhotPageï¼Œå†å°†è¯¥å¯¹è±¡æ’å…¥hotPageä¸­ï¼›</li></ul></li><li><p>å½“é”€æ¯Autoreleasepoolæ—¶,Autoreleasepool::popå‡½æ•°å†…ä¼šï¼š</p><ul><li>æ ¹æ®å“¨å…µå¯¹è±¡è·å–ç›®æ ‡pageåœ°å€</li><li>é€šè¿‡root pageæ‹¿åˆ°hotpage(),ä»hotPageçš„nextæŒ‡é’ˆå¼€å§‹å‘boundaryä¹‹åçš„æ‰€æœ‰å¯¹è±¡å‘é€releaseæ¶ˆæ¯</li><li>æ‰€æœ‰å¯¹è±¡å‘å®Œreleaseæ¶ˆæ¯ä¹‹åï¼Œè°ƒç”¨killæ–¹æ³•åˆ é™¤ç©ºpage ï¼ˆmemory: delete empty childrenï¼‰ï¼›</li></ul></li></ol><h1 id="6-AutoreleasePoolçš„åµŒå¥—"><a href="#6-AutoreleasePoolçš„åµŒå¥—" class="headerlink" title="6. AutoreleasePoolçš„åµŒå¥—"></a>6. AutoreleasePoolçš„åµŒå¥—</h1><p>æŸ¥çœ‹ä¸¤ä¸ªåµŒå¥—çš„AutoreleasePoolåœ¨å†…å­˜ä¸­çš„ç»“æ„ï¼š</p><p>æºç ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool {</span><br><span class="line">       for (int i = 0; i&lt;5; i++) {</span><br><span class="line">           YLAnimal *tmpAni = [YLAnimal animal2];</span><br><span class="line">       }</span><br><span class="line">       @autoreleasepool {</span><br><span class="line">           for (int i = 0; i&lt;10; i++) {</span><br><span class="line">               YLDog *tmpAni = [YLDog doggy2];</span><br><span class="line">           }</span><br><span class="line">           _objc_autoreleasePoolPrint();</span><br><span class="line">       }</span><br><span class="line">       </span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p>æ‰“å°ç»“æœï¼š</p><img src="../assets/images/å†…å­˜ç®¡ç†-autoreleasepool_åµŒå¥—.png" alt="poolåµŒå¥—" style="zoom:80%;"><p>å…¶å†…éƒ¨å¯¹è±¡é‡Šæ”¾è¿‡ç¨‹ï¼š</p><p>ä¸å•ä¸€autoreleasepoolæ²¡æœ‰åŒºåˆ«ï¼Œä¸»è¦æ˜¯æ˜ç™½ä¸€ç‚¹ï¼š<strong>ä»»ä½•é‡Šæ”¾æ± åœ¨é‡Šæ”¾æ—¶éƒ½æ˜¯ä»å†…ä¾§poolå¼€å§‹é‡Šæ”¾ï¼Œä¸å­˜åœ¨ä¸€ä¸ªç›´æ¥ä»å¤–å±‚poolå¼€å§‹çš„æƒ…å†µï¼›</strong></p><p>ä»¥ä¸Šé¢ç»“æ„ä¸ºä¾‹ï¼Œä¸€å®šæ˜¯å…ˆé‡Šæ”¾boundary 2 æ‰€åœ¨çš„poolï¼›ç„¶åæ‰èƒ½è½®åˆ° boundary 1 çš„poolï¼›å½“é‡Šæ”¾åˆ°boundary 1 poolæ—¶ï¼Œbound 2poolå·²ç»è¢«é”€æ¯äº†ï¼Œæ‰€ä»¥æœ€ç»ˆé‡Šæ”¾çš„éƒ½æ˜¯ä¸€ä¸ªå•å±‚çš„poolï¼›</p><p>æ€»ç»“ï¼š</p><ul><li>ä¸€ä¸ªpool æœ‰ä¸”åªæœ‰ä¸€ä¸ªboundaryï¼Œä½†æ˜¯å¯ä»¥æœ‰Nä¸ªpage</li><li>ä¸€ä¸ªpageå†…å¯èƒ½æœ‰1ä¸ªã€0ä¸ªã€å¤šä¸ªboundary</li></ul><h1 id="TODOï¼š7-å“ªäº›å¯¹è±¡ä¼šè‡ªåŠ¨åŠ å…¥autoreleasepoolï¼Ÿ"><a href="#TODOï¼š7-å“ªäº›å¯¹è±¡ä¼šè‡ªåŠ¨åŠ å…¥autoreleasepoolï¼Ÿ" class="headerlink" title="TODOï¼š7. å“ªäº›å¯¹è±¡ä¼šè‡ªåŠ¨åŠ å…¥autoreleasepoolï¼Ÿ"></a>TODOï¼š7. å“ªäº›å¯¹è±¡ä¼šè‡ªåŠ¨åŠ å…¥autoreleasepoolï¼Ÿ</h1><img src="../assets/images/å†…å­˜ç®¡ç†-autorelease_æ±‡ç¼–code.png" alt="poolåµŒå¥—" style="zoom:100%;"><ul><li><strong>+(instancetype)è‡ªå®šä¹‰çš„çš„å·¥å‚æ–¹æ³•åˆ›å»ºçš„å¯¹è±¡ä¸€å®šä¼šåŠ å…¥åˆ°autoreleasepoolä¸­å—ï¼Ÿ</strong></li><li>alloc çš„å¯¹è±¡ä¸€å®šä¸ä¼šåŠ åˆ°autoreleasepoolä¸­</li></ul>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…å­˜å¸ƒå±€-å†…å­˜å¯¹é½</title>
      <link href="/blog/2018/09/07/nei-cun-guan-li-nei-cun-dui-qi/"/>
      <url>/blog/2018/09/07/nei-cun-guan-li-nei-cun-dui-qi/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="1-åŸºç¡€çŸ¥è¯†"><a href="#1-åŸºç¡€çŸ¥è¯†" class="headerlink" title="1. åŸºç¡€çŸ¥è¯†"></a>1. åŸºç¡€çŸ¥è¯†</h1><p><strong>C/C++å„æ•°æ®ç±»å‹å ç”¨å­—èŠ‚æ•°(Byte)</strong></p><table><thead><tr><th>ç¼–è¯‘å™¨ç±»å‹</th><th>16ä½</th><th>32ä½</th><th>64ä½</th></tr></thead><tbody><tr><td>char</td><td>1</td><td>1</td><td>1</td></tr><tr><td>short int</td><td>2</td><td>2</td><td>2</td></tr><tr><td>int</td><td>2</td><td>4</td><td>4</td></tr><tr><td>unsigned int</td><td>2</td><td>4</td><td>4</td></tr><tr><td>long</td><td>4</td><td>4</td><td>4</td></tr><tr><td>unsigned long</td><td>4</td><td>4</td><td>4</td></tr><tr><td>long long</td><td>8</td><td>8</td><td>8</td></tr><tr><td>float</td><td>4</td><td>4</td><td>4</td></tr><tr><td>double</td><td>8</td><td>8</td><td>8</td></tr><tr><td>æŒ‡é’ˆ</td><td>2</td><td>4</td><td>8</td></tr></tbody></table><p>é™„: </p><blockquote><p>32ä½çš„æ“ä½œç³»ç»Ÿå°±æ˜¯æŒ‡ï¼šåœ°å€æ€»çº¿æ˜¯32ä½çš„ç³»ç»Ÿã€‚é‚£ä¹ˆï¼Œä¹Ÿå°±æ˜¯è¯´æ“ä½œç³»ç»Ÿçš„ä½æ•°å†³å®šäº†æŒ‡é’ˆå˜é‡æ‰€å çš„å­—èŠ‚æ•°ã€‚</p></blockquote><h1 id="2-è·å–å†…å­˜å¤§å°çš„ä¸‰ç§æ–¹å¼"><a href="#2-è·å–å†…å­˜å¤§å°çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="2. è·å–å†…å­˜å¤§å°çš„ä¸‰ç§æ–¹å¼"></a>2. è·å–å†…å­˜å¤§å°çš„ä¸‰ç§æ–¹å¼</h1><ul><li><p>sizeof</p><blockquote><p>1ã€<code>sizeof</code>æ˜¯ä¸€ä¸ª <strong>æ“ä½œç¬¦</strong>ï¼Œä¸æ˜¯å‡½æ•°</p><p>2ã€æˆ‘ä»¬ä¸€èˆ¬ç”¨sizeofè®¡ç®—å†…å­˜å¤§å°æ—¶ï¼Œ<code>ä¼ å…¥</code>çš„ä¸»è¦å¯¹è±¡æ˜¯<code>æ•°æ®ç±»å‹</code>ï¼Œè¿™ä¸ªåœ¨ç¼–è¯‘å™¨çš„<code>ç¼–è¯‘é˜¶æ®µ</code>(å³ç¼–è¯‘æ—¶)å°±ä¼šç¡®å®šå¤§å°è€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚</p><p>3ã€<code>sizeof</code>æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯è¯¥æ•°æ®ç±»å‹å ç”¨ç©ºé—´çš„å¤§å°</p></blockquote></li><li><p>**class_getInstanceSize **</p><p>è®¡ç®—å¯¹è±¡å®é™…å ç”¨çš„å†…å­˜å¤§å°ï¼Œè¿™ä¸ªéœ€è¦ä¾æ®ç±»çš„å±æ€§è€Œå˜åŒ–</p></li><li><p><strong>malloc_size</strong></p><p>å¯¹è±¡ç³»ç»Ÿåˆ†é…çš„å†…å­˜å¤§å°</p><table><thead><tr><th></th><th>åŒºåˆ«</th><th>å‚æ•°ç±»å‹</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td><strong>sizeof()</strong></td><td>ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯è¯¥æ•°æ®ç±»å‹å ç”¨ç©ºé—´çš„å¤§å°</td><td>åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡ã€æŒ‡é’ˆ</td><td>sizeof(Struct1ï¼‰<br>sizeof(Int)</td></tr><tr><td><strong>class_getInstanceSizeï¼ˆï¼‰</strong></td><td>å¯¹è±¡å®é™…å ç”¨çš„å†…å­˜å¤§å°</td><td>å¯¹è±¡ç±»å‹</td><td>class_getInstanceSize([NSObject  class])</td></tr><tr><td><strong>malloc_sizeï¼ˆï¼‰</strong></td><td>ç³»ç»Ÿåˆ†é…çš„å†…å­˜å¤§å°</td><td>__bridgeæŒ‡é’ˆç±»å‹</td><td>malloc_size((__bridge const void*)(obj))</td></tr></tbody></table></li></ul><h1 id="3-ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½"><a href="#3-ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½" class="headerlink" title="3. ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½"></a>3. ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½</h1><ol><li>å°½ç®¡å†…å­˜æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†å¤„ç†å™¨å¹¶ä¸æ˜¯æŒ‰å­—èŠ‚å—æ¥å­˜å–å†…å­˜çš„.å®ƒä¸€èˆ¬ä¼šä»¥åŒå­—èŠ‚,å››å­—èŠ‚,8å­—èŠ‚,16å­—èŠ‚ç”šè‡³32å­—èŠ‚ä¸ºå•ä½æ¥å­˜å–å†…å­˜ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°è¿™äº›å­˜å–å•ä½ç§°ä¸ºå†…å­˜å­˜å–ç²’åº¦.</li><li>ä¸åŒç¡¬ä»¶å¹³å°ä¸ä¸€å®šæ”¯æŒè®¿é—®ä»»æ„å†…å­˜åœ°å€æ•°æ®ï¼Œä½¿ç”¨å†…å­˜å¯¹é½å¯ä»¥ä¿è¯æ¯æ¬¡è®¿é—®éƒ½ä»å—å†…å­˜åœ°å€å¤´éƒ¨å¼€å§‹å­˜å–</li><li>æé«˜cpuå†…å­˜è®¿é—®é€Ÿåº¦ï¼Œå†…å­˜æ˜¯åˆ†å—çš„ï¼Œå¦‚ä¸¤å­—èŠ‚ä¸€å—ï¼Œå››å­—èŠ‚ä¸€å—ï¼Œè€ƒè™‘è¿™ç§æƒ…å†µï¼šä¸€ä¸ªå››å­—èŠ‚å˜é‡å­˜åœ¨ä¸€ä¸ªå››å­—èŠ‚åœ°å€çš„åä¸‰ä½å’Œä¸‹ä¸€ä¸ªå››å­—èŠ‚åœ°å€çš„å‰ä¸€ä½ï¼Œè¿™æ ·cpuä»å†…å­˜ä¸­å–æ•°æ®ä¾¿éœ€è¦è®¿é—®ä¸¤ä¸ªå†…å­˜å¹¶å°†ä»–ä»¬ç»„åˆèµ·æ¥ï¼Œé™ä½cpuæ€§èƒ½</li></ol><blockquote><ul><li>é€šå¸¸å†…å­˜æ˜¯ç”±ä¸€ä¸ªä¸ªå­—èŠ‚ç»„æˆçš„ï¼Œcpuåœ¨å­˜å–æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½å­˜å‚¨ï¼Œè€Œæ˜¯ä»¥å—ä¸ºå•ä½å­˜å–ï¼Œå—çš„å¤§å°ä¸ºå†…å­˜å­˜å–åŠ›åº¦ã€‚é¢‘ç¹å­˜å–å­—èŠ‚æœªå¯¹é½çš„æ•°æ®ï¼Œä¼šæå¤§é™ä½cpuçš„æ€§èƒ½ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å‡å°‘å­˜å–æ¬¡æ•°æ¥é™ä½cpuçš„å¼€é”€</li><li>16å­—èŠ‚å¯¹é½ï¼Œæ˜¯ç”±äºåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œç¬¬ä¸€ä¸ªå±æ€§isaå 8å­—èŠ‚ï¼Œå½“ç„¶ä¸€ä¸ªå¯¹è±¡è‚¯å®šè¿˜æœ‰å…¶ä»–å±æ€§ï¼Œå½“æ— å±æ€§æ—¶ï¼Œä¼šé¢„ç•™8å­—èŠ‚ï¼Œå³16å­—èŠ‚å¯¹é½ï¼Œå¦‚æœä¸é¢„ç•™ï¼Œç›¸å½“äºè¿™ä¸ªå¯¹è±¡çš„isaå’Œå…¶ä»–å¯¹è±¡çš„isaç´§æŒ¨ç€ï¼Œå®¹æ˜“é€ æˆè®¿é—®æ··ä¹±</li><li>16å­—èŠ‚å¯¹é½åï¼Œå¯ä»¥åŠ å¿«CPUè¯»å–é€Ÿåº¦ï¼ŒåŒæ—¶ä½¿è®¿é—®æ›´å®‰å…¨ï¼Œä¸ä¼šäº§ç”Ÿè®¿é—®æ··ä¹±çš„æƒ…å†µ</li></ul></blockquote><h1 id="4-å†…å­˜å¯¹é½åŸåˆ™"><a href="#4-å†…å­˜å¯¹é½åŸåˆ™" class="headerlink" title="4. å†…å­˜å¯¹é½åŸåˆ™"></a>4. å†…å­˜å¯¹é½åŸåˆ™</h1><p><strong>å†…å­˜å­—èŠ‚å¯¹é½çš„åŸåˆ™ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š</strong></p><ol><li><p>æ•°æ®æˆå‘˜å¯¹é½è§„åˆ™ï¼šstruct æˆ–è€… union çš„æ•°æ®æˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ•°æ®æˆå‘˜æ”¾åœ¨offsetä¸º0çš„åœ°æ–¹ï¼Œä»¥åæ¯ä¸ªæ•°æ®æˆå‘˜å­˜å‚¨çš„èµ·å§‹ä½ç½®è¦ä»è¯¥æˆå‘˜å¤§å°æˆ–è€…æˆå‘˜çš„å­æˆå‘˜å¤§å°ï¼ˆåªè¦è¯¥æˆå‘˜æœ‰å­æˆå‘˜ï¼Œæ¯”å¦‚æ•°æ®ã€ç»“æ„ä½“ç­‰ï¼‰çš„æ•´æ•°å€å¼€å§‹ï¼ˆä¾‹å¦‚intåœ¨32ä½æœºä¸­æ˜¯4å­—èŠ‚ï¼Œåˆ™è¦ä»4çš„æ•´æ•°å€åœ°å€å¼€å§‹å­˜å‚¨ï¼‰</p><blockquote><p>index çš„å–å€¼æ»¡è¶³ä»¥ä¸‹ä¼ªä»£ç ï¼š</p><p>forï¼ˆint x= offset; x++; x % currentIvarSize == 0 ï¼‰ {</p><p>â€‹      index = x; </p><p>}</p></blockquote></li><li><p>æ•°æ®æˆå‘˜ä¸ºç»“æ„ä½“ï¼šå¦‚æœä¸€ä¸ªç»“æ„é‡Œæœ‰æŸäº›ç»“æ„ä½“æˆå‘˜ï¼Œåˆ™ç»“æ„ä½“æˆå‘˜è¦ä»å…¶å†…éƒ¨æœ€å¤§å…ƒç´ å¤§å°çš„æ•´æ•°å€åœ°å€å¼€å§‹å­˜å‚¨ï¼ˆä¾‹å¦‚ï¼šstruct aé‡Œé¢å­˜æœ‰struct bï¼Œbé‡Œé¢æœ‰charã€intã€doubleç­‰å…ƒç´ ï¼Œåˆ™båº”è¯¥ä»8çš„æ•´æ•°å€å¼€å§‹å­˜å‚¨ï¼‰</p></li><li><p>ç»“æ„ä½“çš„æ•´ä½“å¯¹é½è§„åˆ™ï¼šç»“æ„ä½“çš„æ€»å¤§å°ï¼Œå³sizeofçš„ç»“æœï¼Œå¿…é¡»æ˜¯å…¶å†…éƒ¨åšå¤§æˆå‘˜çš„æ•´æ•°å€ï¼Œä¸è¶³çš„è¦è¡¥é½</p></li></ol><p><strong>å®ä¾‹ğŸŒ°</strong></p><p>ä¾‹å­1ï¼ˆä¸‹æ ‡å¯¹é½ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct Struct1 {</span><br><span class="line">    double a; // 8</span><br><span class="line">    int b; // 4</span><br><span class="line">    char c; // 1</span><br><span class="line">    short d; // 2</span><br><span class="line">}Struct1;</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th></th><th>a(8å­—èŠ‚)</th><th>bï¼ˆ4å­—èŠ‚ï¼‰</th><th>cï¼ˆ1å­—èŠ‚ï¼‰</th><th>dï¼ˆ2å­—èŠ‚ï¼‰</th><th>æœ«å°¾è¡¥é½</th></tr></thead><tbody><tr><td>å¯¹é½å‰</td><td>ã€0-7ã€‘</td><td>ã€8-11ã€‘</td><td>ã€12ã€‘</td><td>ã€13-14ã€‘</td><td></td></tr><tr><td>å¯¹é½å</td><td>ã€0-7ã€‘</td><td>ã€8-11ã€‘</td><td>ã€12ã€‘</td><td>ä¸‹æ ‡13ä¸å¯ä»¥æ•´é™¤2(åŸåˆ™ç¬¬1æ¡);å¯¹é½åæ˜¯ã€14-15ã€‘</td><td>æ­£å¥½ï¼Œä¸éœ€è¦è¡¥</td></tr></tbody></table><p>ä¾‹å­2ï¼ˆä¸‹è¡¨å¯¹é½+æ€»é•¿åº¦å¯¹é½ï¼‰ï¼š</p><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Struct2 {</span><br><span class="line">    <span class="keyword">int</span> a; <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">double</span> b; <span class="comment">// 8</span></span><br><span class="line">    <span class="keyword">int</span> c; <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">char</span> d; <span class="comment">// 1</span></span><br><span class="line">}Struct2;</span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th></th><th>a(4å­—èŠ‚)</th><th>bï¼ˆ8å­—èŠ‚ï¼‰</th><th>cï¼ˆ4å­—èŠ‚ï¼‰</th><th>dï¼ˆ1å­—èŠ‚ï¼‰</th><th>æœ«å°¾è¡¥é½</th></tr></thead><tbody><tr><td>å¯¹é½å‰</td><td>ã€0-3ã€‘</td><td>ã€4-11ã€‘</td><td>ã€12-15ã€‘</td><td>ã€16ã€‘</td><td></td></tr><tr><td>å¯¹é½å</td><td>ã€0-3ã€‘</td><td>ä¸‹æ ‡4ä¸å¯ä»¥æ•´é™¤8(åŸåˆ™ç¬¬1æ¡);<br>å¯¹é½åæ˜¯ã€8-15ã€‘</td><td>ã€16-19ã€‘</td><td>ã€20ã€‘</td><td>æ€»é•¿åº¦å¿…é¡»æ˜¯æœ€å¤§æˆå‘˜çš„æ•´æ•°å€(åŸåˆ™ç¬¬3æ¡)ï¼›<br>è¡¥é½æœ«å°¾ã€21-23ã€‘</td></tr></tbody></table><p>ä¾‹å­3ï¼ˆï¼‰ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//1ã€ç»“æ„ä½“åµŒå¥—ç»“æ„ä½“</span><br><span class="line">struct Struct3{</span><br><span class="line">    char a;   //1å­—èŠ‚</span><br><span class="line">    int b;      //4å­—èŠ‚</span><br><span class="line">    short c;    //2å­—èŠ‚</span><br><span class="line">    double d;     //8å­—èŠ‚</span><br><span class="line">    struct Struct2 str; </span><br><span class="line">}Struct3;</span><br><span class="line"></span><br><span class="line">//2ã€æ‰“å° Mystruct3 çš„å†…å­˜å¤§å°</span><br><span class="line">NSLog(@"Mystruct3å†…å­˜å¤§å°ï¼š%lu", sizeof(Mystruct3));</span><br><span class="line">NSLog(@"Mystruct3ä¸­ç»“æ„ä½“æˆå‘˜å†…å­˜å¤§å°ï¼š%lu", sizeof(Mystruct3.str));</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><table><thead><tr><th></th><th>a<br>(1å­—èŠ‚)</th><th>b<br>ï¼ˆ4å­—èŠ‚ï¼‰</th><th>c<br>ï¼ˆ2å­—èŠ‚ï¼‰</th><th>d<br>ï¼ˆ8å­—èŠ‚ï¼‰</th><th>str<br>ï¼ˆ24å­—èŠ‚ï¼‰</th><th>æœ«å°¾è¡¥é½</th></tr></thead><tbody><tr><td>å¯¹é½å‰</td><td>ã€0ã€‘</td><td>ã€1-4ã€‘</td><td>ã€5-6ã€‘</td><td>ã€7-14ã€‘</td><td>â€¦..</td><td></td></tr><tr><td>å¯¹é½å</td><td>ã€0ã€‘</td><td>ä¸‹æ ‡1ä¸å¯ä»¥æ•´é™¤4(åŸåˆ™ç¬¬1æ¡);<br>å¯¹é½åæ˜¯ã€4-7ã€‘</td><td>ã€8-9ã€‘</td><td>ä¸‹æ ‡10ä¸å¯ä»¥æ•´é™¤8(åŸåˆ™ç¬¬1æ¡);<br>ã€16-23ã€‘</td><td>ã€24-27ã€‘â€“a<br>ã€32-39ã€‘â€“b<br>ã€40-43ã€‘â€“c<br>ã€44ã€‘</td><td>æ€»é•¿åº¦å¿…é¡»æ˜¯æœ€å¤§æˆå‘˜çš„æ•´æ•°å€(åŸåˆ™ç¬¬3æ¡)ï¼›<br>è¡¥é½æœ«å°¾ã€45-47ã€‘</td></tr></tbody></table><h1 id="TODOï¼š5-å†…å­˜ä¼˜åŒ–ï¼ˆå±æ€§é‡æ’ï¼‰"><a href="#TODOï¼š5-å†…å­˜ä¼˜åŒ–ï¼ˆå±æ€§é‡æ’ï¼‰" class="headerlink" title="TODOï¼š5. å†…å­˜ä¼˜åŒ–ï¼ˆå±æ€§é‡æ’ï¼‰"></a>TODOï¼š5. å†…å­˜ä¼˜åŒ–ï¼ˆå±æ€§é‡æ’ï¼‰</h1><p>å¾…ã€‚ã€‚ã€‚ã€‚</p><h1 id="6-å†…å­˜å¯¹é½ç®—æ³•"><a href="#6-å†…å­˜å¯¹é½ç®—æ³•" class="headerlink" title="6. å†…å­˜å¯¹é½ç®—æ³•"></a>6. å†…å­˜å¯¹é½ç®—æ³•</h1><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_SHIFT 3UL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_MASK 7UL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_BITS 64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_SHIFT 2UL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_MASK 3UL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> WORD_BITS 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint32_t</span> <span class="title">word_align</span><span class="params">(<span class="keyword">uint32_t</span> x)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (x + WORD_MASK) &amp; ~WORD_MASK;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">word_align</span><span class="params">(<span class="keyword">size_t</span> x)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (x + WORD_MASK) &amp; ~WORD_MASK;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">align16</span><span class="params">(<span class="keyword">size_t</span> x)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (x + <span class="built_in">size_t</span>(<span class="number">15</span>)) &amp; ~<span class="built_in">size_t</span>(<span class="number">15</span>);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>æ³¨æ„ï¼š</strong></p><ul><li>class_getInstanceSizeï¼ˆClass clsï¼‰ï¼šåº•å±‚æ˜¯8å­—èŠ‚å¯¹é½</li><li>cls-&gt;instanceSize(extraBytes)ï¼šåº•å±‚æ˜¯16å­—èŠ‚å¯¹é½</li></ul><p><strong>æ€»ç»“</strong></p><ul><li>åœ¨å­—èŠ‚å¯¹é½ç®—æ³•ä¸­ï¼Œå¯¹é½çš„ä¸»è¦æ˜¯<code>å¯¹è±¡</code>ï¼Œè€Œå¯¹è±¡çš„æœ¬è´¨åˆ™æ˜¯ä¸€ä¸ª struct objc_objectçš„<code>ç»“æ„ä½“</code>ï¼Œ</li><li><code>ç»“æ„ä½“</code>åœ¨å†…å­˜ä¸­æ˜¯<code>è¿ç»­å­˜æ”¾</code>çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ç‚¹å¯¹ç»“æ„ä½“è¿›è¡Œå¼ºè½¬ã€‚</li><li>è‹¹æœæ—©æœŸæ˜¯<code>8</code>å­—èŠ‚å¯¹é½ï¼Œ<code>ç°åœ¨</code>æ˜¯<code>16å­—èŠ‚å¯¹é½</code></li></ul><p>ä¸‹é¢ä»¥<code>alignï¼ˆ8ï¼‰ ä¸ºä¾‹ï¼Œ</code>å›¾è§£16å­—èŠ‚å¯¹é½ç®—æ³•çš„è®¡ç®—è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><p> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92677025d2674fd0b3c0996b89e6b08c~tplv-k3u1fbpfcp-watermark.awebp" alt="16å­—èŠ‚å¯¹é½ç®—æ³•å›¾è§£"></p><ul><li>é¦–å…ˆå°†åŸå§‹çš„å†…å­˜ <code>8</code> ä¸ <code>size_t(15)</code>ç›¸åŠ ï¼Œå¾—åˆ° 8 + 15 = 23</li><li>å°† <code>size_t(15)</code> å³ 15è¿›è¡Œ<code>~ï¼ˆå–åï¼‰</code>æ“ä½œï¼Œ<code>~ï¼ˆå–åï¼‰</code>çš„è§„åˆ™æ˜¯ï¼š<code>1å˜ä¸º0ï¼Œ0å˜ä¸º1</code></li><li>æœ€åå°† 23 ä¸ 15çš„å–åç»“æœ è¿›è¡Œ <code>&amp;ï¼ˆä¸ï¼‰</code>æ“ä½œï¼Œ<code>&amp;ï¼ˆä¸ï¼‰</code>çš„è§„åˆ™æ˜¯ï¼š<code>éƒ½æ˜¯1ä¸º1ï¼Œåä¹‹ä¸º0</code>ï¼Œæœ€åçš„ç»“æœä¸º 16ï¼Œå³å†…å­˜çš„å¤§å°æ˜¯ä»¥<code>16</code>çš„å€æ•°å¢åŠ çš„</li></ul><p>é“¾æ¥ï¼š<a href="https://juejin.cn/post/6949576678205030431">https://juejin.cn/post/6949576678205030431</a></p><h1 id="7-é¢è¯•é¢˜"><a href="#7-é¢è¯•é¢˜" class="headerlink" title="7. é¢è¯•é¢˜"></a>7. é¢è¯•é¢˜</h1><ol><li><p>ä¸€ä¸ªNSObjectå¯¹è±¡å ç”¨å¤šå°‘å†…å­˜ç©ºé—´ï¼Ÿï¼ˆé—®çš„æ˜¯å®é™…å ç”¨ç©ºé—´ï¼Œä¸æ˜¯ç³»ç»Ÿåˆ†é…ç©ºé—´ï¼‰</p><p>ç­”ï¼šä¸€ä¸ªNSObjectå¯¹è±¡çš„ç»“æ„ä½“ä¸­ï¼Œåªæœ‰isaä¸€ä¸ªæˆå‘˜ï¼Œisaæ˜¯æŒ‡é’ˆç±»å‹ã€‚å› æ­¤ï¼Œåœ¨64ä½æ¶æ„ä¸­ï¼Œå ç”¨<strong>8ä¸ªå­—èŠ‚</strong>çš„å†…å­˜ã€‚åœ¨è¿™é‡Œï¼Œç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼Œæ‰€ä»¥isaçš„åœ°å€ï¼Œå°±æ˜¯ç»“æ„ä½“çš„åœ°å€ï¼Œå°±æ˜¯NSObjectå¯¹è±¡çš„åœ°å€ã€‚</p></li><li><p>ä¸€ä¸ªè‡ªå®šä¹‰ç±»çš„å¯¹è±¡å ç”¨å¤šå¤§çš„å†…å­˜ç©ºé—´ï¼Ÿ</p><p>ç­”ï¼šisa(8å­—èŠ‚) + å„å˜é‡å ç”¨ç©ºé—´</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…å­˜å¸ƒå±€-OCç±»ä¸å¯¹è±¡</title>
      <link href="/blog/2018/09/07/nei-cun-bu-ju-oc-lei-yu-dui-xiang/"/>
      <url>/blog/2018/09/07/nei-cun-bu-ju-oc-lei-yu-dui-xiang/</url>
      
        <content type="html"><![CDATA[<h1 id="1-Clangä½¿ç”¨"><a href="#1-Clangä½¿ç”¨" class="headerlink" title="1. Clangä½¿ç”¨"></a>1. Clangä½¿ç”¨</h1><h2 id="1-1-å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ-C-ä»£ç "><a href="#1-1-å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ-C-ä»£ç " class="headerlink" title="1.1 å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ C++ä»£ç "></a>1.1 å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ <code>C++</code>ä»£ç </h2><blockquote><p>æ‰“å¼€<strong>ç»ˆç«¯</strong>ï¼Œ cd åˆ°æŒ‡å®šçš„OCæ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹ï¼Œé”®å…¥æŒ‡ä»¤</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -rewrite-objc å¯¹åº”OCæ–‡ä»¶.m -o OCæ–‡ä»¶åŒå.cpp</span><br></pre></td></tr></tbody></table></figure><p>ä¹Ÿå¯ä»¥æŒ‡å®šæ¶æ„ï¼Œé”®å…¥æŒ‡ä»¤</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc å¯¹åº”OCæ–‡ä»¶.m -o OCæ–‡ä»¶åŒå.cpp</span><br></pre></td></tr></tbody></table></figure><p>ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿ<code>åº•å±‚</code>çš„ä¸€äº›<code>ç»“æ„</code> åŠ <code>å®ç°</code>çš„é€»è¾‘,å­¦ä¼šä½¿ç”¨clangå‘½ä»¤ï¼›</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">clang -rewrite-objc main.m -o main.cpp </span><br><span class="line">//UIKitæŠ¥é”™</span><br><span class="line">clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m</span><br><span class="line">// xcrunå‘½ä»¤åŸºäºclangåŸºç¡€ä¸Šè¿›è¡Œäº†å°è£…æ›´å¥½ç”¨</span><br><span class="line">//3ã€æ¨¡æ‹Ÿå™¨ç¼–è¯‘</span><br><span class="line">xcrun -sdk iphonesimulator clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp </span><br><span class="line">//4ã€çœŸæœºç¼–è¯‘</span><br><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main- arm64.cpp </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></blockquote><h2 id="1-2-å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ-æ±‡ç¼–ä»£ç "><a href="#1-2-å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ-æ±‡ç¼–ä»£ç " class="headerlink" title="1.2  å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ æ±‡ç¼–ä»£ç "></a>1.2  å€ŸåŠ©clangå‘½ä»¤å°†ä¸Šå±‚OCä»£ç è¿˜åŸæˆ æ±‡ç¼–ä»£ç </h2><blockquote><p>æ‰“å¼€<strong>ç»ˆç«¯</strong>ï¼Œ cd åˆ°æŒ‡å®šçš„OCæ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹ï¼Œé”®å…¥æŒ‡ä»¤</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S -fobjc-arc -emit-llvm main.m -o main.ll</span><br></pre></td></tr></tbody></table></figure><p>ä¹Ÿå¯ä»¥æŒ‡å®šæ¶æ„ï¼Œé”®å…¥æŒ‡ä»¤</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphonesimulator clang -S -fobjc-arc -emit-llvm main.m -o main.ll</span><br></pre></td></tr></tbody></table></figure></blockquote><h1 id="2-OCä¸­çš„ä¸‰ç§å¯¹è±¡ï¼š"><a href="#2-OCä¸­çš„ä¸‰ç§å¯¹è±¡ï¼š" class="headerlink" title="2. OCä¸­çš„ä¸‰ç§å¯¹è±¡ï¼š"></a>2. OCä¸­çš„ä¸‰ç§å¯¹è±¡ï¼š</h1><ul><li>instanceå¯¹è±¡</li><li>classå¯¹è±¡</li><li>meta-classå¯¹è±¡</li></ul><h2 id="2-1-instanceå¯¹è±¡"><a href="#2-1-instanceå¯¹è±¡" class="headerlink" title="2.1 instanceå¯¹è±¡"></a>2.1 instanceå¯¹è±¡</h2><p>instanceå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„ä¿¡æ¯  åŒ…æ‹¬ï¼š</p><ul><li><p>isaæŒ‡é’ˆ</p></li><li><p>å…¶ä»–æˆå‘˜å˜é‡</p><table><thead><tr><th>å®ä¾‹å¯¹è±¡ï¼šï¼ˆå †åŒºï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘å®ƒçš„æŒ‡é’ˆåœ¨æ ˆåŒºï¼‰</th></tr></thead><tbody><tr><td>isaï¼ˆå‰8ä¸ªå­—èŠ‚ï¼‰<br>æˆå‘˜å˜é‡å€¼<br>â€¦</td></tr></tbody></table></li></ul><h2 id="2-2-classå¯¹è±¡"><a href="#2-2-classå¯¹è±¡" class="headerlink" title="2.2 classå¯¹è±¡"></a>2.2 classå¯¹è±¡</h2><p>classå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„ä¿¡æ¯ ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><p>isaæŒ‡é’ˆ</p></li><li><p>superclassæŒ‡é’ˆ</p></li><li><p>ç±»çš„å±æ€§ä¿¡æ¯ï¼ˆPropertyï¼‰</p></li><li><p>ç±»çš„æˆå‘˜å˜é‡ä¿¡æ¯ï¼ˆIvarï¼‰</p></li><li><p>å¯¹è±¡æ–¹æ³•ä¿¡æ¯ï¼ˆInstance Methodï¼‰</p></li><li><p>ç±»çš„åè®®ä¿¡æ¯ï¼ˆProtocolï¼‰</p><table><thead><tr><th>ç±»å¯¹è±¡ï¼šï¼ˆå…¨å±€åŒºï¼‰</th></tr></thead><tbody><tr><td>isa ï¼ˆå‰8ä¸ªå­—èŠ‚ï¼‰<br>superClass ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰<br>æˆå‘˜å˜é‡ä¿¡æ¯<br>å±æ€§ä¿¡æ¯<br>å¯¹è±¡æ–¹æ³•ä¿¡æ¯<br>åè®®ä¿¡æ¯<br>â€¦.</td></tr></tbody></table></li></ul><h2 id="2-3-meta-classå¯¹è±¡"><a href="#2-3-meta-classå¯¹è±¡" class="headerlink" title="2.3 meta-classå¯¹è±¡"></a>2.3 meta-classå¯¹è±¡</h2><p>meta-classå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„ä¿¡æ¯ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><p>isaæŒ‡é’ˆ</p></li><li><p>superclassæŒ‡é’ˆ</p></li><li><p>ç±»æ–¹æ³•ä¿¡æ¯ï¼ˆClass Methodï¼‰</p><table><thead><tr><th>å…ƒç±»å¯¹è±¡ï¼šï¼ˆå…¨å±€åŒºï¼‰</th></tr></thead><tbody><tr><td>isa ï¼ˆå‰8ä¸ªå­—èŠ‚ï¼‰<br>superClass ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰<br>ç±»æ–¹æ³•ä¿¡æ¯<br>â€¦</td></tr></tbody></table></li></ul><h2 id="2-4-ç»å…¸å›¾isa-amp-superèµ°å‘"><a href="#2-4-ç»å…¸å›¾isa-amp-superèµ°å‘" class="headerlink" title="2.4 ç»å…¸å›¾isa&amp; superèµ°å‘"></a>2.4 ç»å…¸å›¾isa&amp; superèµ°å‘</h2><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_isa_super.jpg" alt="isa_super" style="zoom:60%;"><h2 id="2-5-æ€»ç»“ï¼š"><a href="#2-5-æ€»ç»“ï¼š" class="headerlink" title="2.5 æ€»ç»“ï¼š"></a>2.5 æ€»ç»“ï¼š</h2><p><strong>isaæŒ‡å‘:</strong></p><blockquote><p>instanceå¯¹è±¡ â€”&gt; classå¯¹è±¡ â€”-&gt; meta-classå¯¹è±¡ â€”-&gt; NSObject(Meta) â€”-&gt; NSObject(Meta) è‡ªå·±</p><p>ğŸŒ°ï¼šperson â€”&gt; YLPerson â€”-&gt; YLPerson(Meta) â€”-&gt; NSObject(Meta) â€”-&gt; NSObject(Meta) è‡ªå·±</p></blockquote><p><strong>superæŒ‡å‘:</strong></p><blockquote><p>è‡ªå®šä¹‰classå¯¹è±¡ â€”-&gt; NSObject â€”-&gt; nil</p><p>ğŸŒ°ï¼šson â€”-&gt; YLPerson â€”-&gt; NSObject â€”-&gt; nil </p></blockquote><p><strong>è°ƒè¯•æŒ‡ä»¤</strong></p><blockquote><p>xæ˜¯è¯»å–å†…å­˜çš„å‘½ä»¤ï¼Œx/4gxä¸­ç¬¬ä¸€ä¸ªxæ˜¯è¯»å–å†…å­˜å‘½ä»¤ï¼Œåé¢çš„gæ˜¯æ¯æ¬¡è¯»å–8å­—èŠ‚ï¼Œxçš„æ„æ€æ˜¯16è¿›åˆ¶æ˜¾ç¤ºç»“æœï¼Œ4è¡¨ç¤ºè¿ç»­æ‰“å°4æ®µ</p></blockquote><ol><li><p>æ‰“å°å¯¹è±¡å†…å­˜ç»“æ„ï¼Œè·å–<strong>ISA</strong>æŒ‡é’ˆä¿¡æ¯ï¼š<strong>x/4gx vc</strong></p><p>0x7fd03d605730: 0x000000010bb22280 0x0000000000000000</p><p>0x7fd03d605740: 0x0000000000000000 0x0000000000000000</p></li><li><p>ç”¨ <strong>ISA</strong> ä¸ <strong>ISA_MASK</strong> åšâ€œä¸â€æ“ä½œï¼Œè·å–ç±»ä¿¡æ¯ï¼š po 0x000000010bb22280 &amp; 0x007ffffffffffff8ULLï¼ˆ<strong>TARGET_OS_SIMULATOR</strong> ä¸‹çš„ <strong>ISA_MASK</strong>ï¼‰</p></li></ol><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_isa.jpg" alt="å†…å­˜åœ°å€" style="zoom:80%;"><h1 id="3-ç±»çš„ç»“æ„åˆ†æ"><a href="#3-ç±»çš„ç»“æ„åˆ†æ" class="headerlink" title="3. ç±»çš„ç»“æ„åˆ†æ"></a>3. ç±»çš„ç»“æ„åˆ†æ</h1><h2 id="3-1-ç±»çš„æœ¬è´¨"><a href="#3-1-ç±»çš„æœ¬è´¨" class="headerlink" title="3.1 ç±»çš„æœ¬è´¨"></a>3.1 ç±»çš„æœ¬è´¨</h2><p>ç±»çš„æœ¬è´¨æ˜¯ä¸€ä¸ª<code>objc_class</code>ç±»å‹çš„ç»“æ„ä½“ï¼Œ<code>objc_class</code>ç»§æ‰¿äº<code>objc_object</code>;</p><h3 id="3-1-1-ç±»åœ¨åº•å±‚çš„å®šä¹‰"><a href="#3-1-1-ç±»åœ¨åº•å±‚çš„å®šä¹‰" class="headerlink" title="3.1.1 ç±»åœ¨åº•å±‚çš„å®šä¹‰:"></a>3.1.1 ç±»åœ¨åº•å±‚çš„å®šä¹‰:</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object {</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">class_rw_t</span> *<span class="title">data</span><span class="params">()</span> </span>{ </span><br><span class="line">        <span class="keyword">return</span> bits.<span class="built_in">data</span>();</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>å†…å­˜å ç”¨æƒ…å†µï¼š</p><ul><li> ISA: Classæœ¬èº«å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå ç”¨8å­—èŠ‚</li><li> superclass: superclassæ˜¯Classç±»å‹ï¼Œæ‰€ä»¥å ç”¨8å­—èŠ‚</li><li> cacheï¼š <font color="red"><code>cache_t</code>å ç”¨16å­—èŠ‚ï¼Ÿï¼Ÿï¼Ÿ</font></li><li> bits:</li></ul></blockquote><h2 id="3-2-isaåˆ†æ"><a href="#3-2-isaåˆ†æ" class="headerlink" title="3.2 isaåˆ†æ"></a>3.2 isaåˆ†æ</h2><h3 id="3-2-1-isa-tç»“æ„è§£æ"><a href="#3-2-1-isa-tç»“æ„è§£æ" class="headerlink" title="3.2.1 isa_tç»“æ„è§£æ"></a>3.2.1 isa_tç»“æ„è§£æ</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¯æŒarm64ä¹‹åï¼Œä¹‹å‰åªæœ‰ä¸€ä¸ªclassæˆå‘˜å˜é‡ï¼š</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">isa_t</span> {</span></span><br><span class="line">    <span class="built_in">isa_t</span>() { }</span><br><span class="line">    <span class="built_in">isa_t</span>(<span class="keyword">uintptr_t</span> value) : <span class="built_in">bits</span>(value) { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line">    Class cls;</span><br><span class="line">  </span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p><strong>isa_t</strong> å…¶å®æ˜¯ä¸€ä¸ªè”åˆä½“<strong>union :</strong> ä¸€ä¸ª<strong>8</strong>å­—èŠ‚æŒ‡é’ˆ**(64<strong>ä½</strong>) = cls = bits =** ä½¿ç”¨ä½åŸŸçš„<strong>struct</strong> </p><p>è”åˆä½“**(union)**æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œå…è®¸æ‚¨åœ¨ç›¸åŒçš„å†…å­˜ä½ç½®å­˜å‚¨ä¸åŒçš„æ•°æ®ç±»å‹ã€‚æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå¸¦æœ‰å¤šæˆå‘˜çš„å…±ç”¨ä½“ï¼Œä½†æ˜¯ä»»ä½•æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªæˆå‘˜å¸¦æœ‰å€¼ã€‚(å¦‚ä¸‹ï¼Œè¦ä¹ˆclsæœ‰å€¼ï¼Œè¦ä¹ˆbitsæœ‰å€¼ï¼›ä¸¤è€…ä¸å¯èƒ½åŒæ—¶æœ‰å€¼)</p><blockquote><p><strong>ç®€ä»‹ï¼š</strong></p><p>ARM64ä½æ¶æ„ä¹‹å‰ï¼Œ<code>isa</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘<code>class/meta-class</code>å¯¹è±¡çš„åœ°å€ ï¼›</p><p>ARM64ä½æ¶æ„å¼€å§‹(ä¹Ÿå°±æ˜¯13å¹´5sé¢ä¸–)ï¼Œ<code>isa</code>æ˜¯ä¸€ä¸ªè”åˆä½“/å…±ç”¨ä½“ï¼ˆ<code>union</code>ï¼‰ï¼Œè¿™æ˜¯è‹¹æœå¯¹<code>isa</code>çš„ä¼˜åŒ–ï¼Œç»“åˆä½åŸŸçš„æ¦‚å¿µä»¥åŠä½è¿ç®—çš„æ–¹å¼æ¥å­˜å‚¨æ›´å¤šç±»ç›¸å…³ä¿¡æ¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯<code>isa</code>æŒ‡é’ˆé€šè¿‡ä¸€ä¸ªå«<code>ISA_MASK</code>çš„å€¼è¿›è¡ŒäºŒè¿›åˆ¶&amp;è¿ç®—ï¼Œå¾—åˆ°çœŸå®çš„<code>class/meta-class</code>å¯¹è±¡çš„çœŸå®åœ°å€ã€‚</p></blockquote><h3 id="3-2-2-isaæºç -amp-å„ä½ä»£è¡¨å«ä¹‰"><a href="#3-2-2-isaæºç -amp-å„ä½ä»£è¡¨å«ä¹‰" class="headerlink" title="3.2.2 isaæºç &amp;å„ä½ä»£è¡¨å«ä¹‰"></a>3.2.2 isaæºç &amp;å„ä½ä»£è¡¨å«ä¹‰</h3><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x86_64 æ¶æ„</span></span><br><span class="line"><span class="keyword">struct</span> {</span><br><span class="line">    uintptr_t nonpointer        : <span class="number">1</span>;  <span class="comment">// 0:ä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œ1:ä»£è¡¨è¢«ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯</span></span><br><span class="line">    uintptr_t has_assoc         : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦å«æœ‰æˆ–æ›¾ç»å«æœ‰å…³è”å¼•ç”¨</span></span><br><span class="line">    uintptr_t has_cxx_dtor      : <span class="number">1</span>;  <span class="comment">// è¡¨ç¤ºæ˜¯å¦æœ‰C++ææ„å‡½æ•°æˆ–OCçš„dealloc</span></span><br><span class="line">    uintptr_t shiftcls          : <span class="number">44</span>; <span class="comment">// å­˜æ”¾ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</span></span><br><span class="line">    uintptr_t magic             : <span class="number">6</span>;  <span class="comment">// ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    uintptr_t weakly_referenced : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦è¢«å¼±å¼•ç”¨æŒ‡å‘</span></span><br><span class="line">    uintptr_t deallocating      : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</span></span><br><span class="line">    uintptr_t has_sidetable_rc  : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦éœ€è¦ä½¿ç”¨ sidetable æ¥å­˜å‚¨å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    uintptr_t extra_rc          : <span class="number">8</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°èƒ½å¤Ÿç”¨ 8 ä¸ªäºŒè¿›åˆ¶ä½å­˜å‚¨æ—¶ï¼Œç›´æ¥å­˜å‚¨åœ¨è¿™é‡Œ</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// arm64 æ¶æ„</span></span><br><span class="line"><span class="keyword">struct</span> {</span><br><span class="line">    uintptr_t nonpointer        : <span class="number">1</span>;  <span class="comment">// 0:ä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œ1:ä»£è¡¨è¢«ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯</span></span><br><span class="line">    uintptr_t has_assoc         : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦å«æœ‰æˆ–æ›¾ç»å«æœ‰å…³è”å¼•ç”¨</span></span><br><span class="line">    uintptr_t has_cxx_dtor      : <span class="number">1</span>;  <span class="comment">// è¡¨ç¤ºæ˜¯å¦æœ‰C++ææ„å‡½æ•°æˆ–OCçš„dealloc</span></span><br><span class="line">    uintptr_t shiftcls          : <span class="number">33</span>; <span class="comment">// å­˜æ”¾ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</span></span><br><span class="line">    uintptr_t magic             : <span class="number">6</span>;  <span class="comment">// ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    uintptr_t weakly_referenced : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦è¢«å¼±å¼•ç”¨æŒ‡å‘</span></span><br><span class="line">    uintptr_t deallocating      : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</span></span><br><span class="line">    uintptr_t has_sidetable_rc  : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦éœ€è¦ä½¿ç”¨ sidetable æ¥å­˜å‚¨å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    uintptr_t extra_rc          : <span class="number">19</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°èƒ½å¤Ÿç”¨ 19 ä¸ªäºŒè¿›åˆ¶ä½å­˜å‚¨æ—¶ï¼Œç›´æ¥å­˜å‚¨åœ¨è¿™é‡Œ</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>æ³¨ï¼š åœ¨ 64 ä½ç¯å¢ƒä¸‹ï¼Œä¼˜åŒ–çš„ isa æŒ‡é’ˆå¹¶ä¸æ˜¯å°±ä¸€å®šä¼šå­˜å‚¨å¼•ç”¨è®¡æ•°ï¼Œæ¯•ç«Ÿç”¨ 19bit ï¼ˆiOS ç³»ç»Ÿï¼‰ä¿å­˜å¼•ç”¨è®¡æ•°ä¸ä¸€å®šå¤Ÿã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ 19 ä½ä¿å­˜çš„æ˜¯å¼•ç”¨è®¡æ•°çš„å€¼å‡ä¸€ã€‚has_sidetable_rc çš„å€¼å¦‚æœä¸º 1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå« SideTable çš„ç±»çš„å±æ€§ä¸­ã€‚ï¼ˆæºç å®ç°ï¼šå¦‚æœæ˜¯ä¼˜åŒ–è¿‡çš„isaï¼Œextra_rc+1å°±æ˜¯å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœæœ‰SideTableï¼Œå°±ä»SideTableæ‹¿åˆ°å¼•ç”¨è®¡æ•°ï¼Œä»SideTableæ‹¿åˆ°çš„å¼•ç”¨è®¡æ•°åŠ ä¸Šextra_rc+1å°±æ˜¯æ€»çš„å¼•ç”¨è®¡æ•°ã€‚ï¼‰</p><h4 id="3-2-2-1-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"><a href="#3-2-2-1-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ" class="headerlink" title="3.2.2.1 å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"></a>3.2.2.1 å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ</h4><ul><li><p>nonpointer ï¼ˆæ ‡è®°æ˜¯å¦å¼€å¯æŒ‡é’ˆä¼˜åŒ–ï¼‰</p><blockquote><ul><li><p>0ï¼Œä»£è¡¨æ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€<code>Class</code>ã€<code>Meta-Class</code>å¯¹è±¡çš„å†…å­˜åœ°å€ â€”- ï¼ˆ**<font color="red">æœªå¼€å¯isaä¼˜åŒ–</font>** ï¼‰</p><p>å¦‚æœnonpointerä¸º0ï¼Œä»£è¡¨raw isaï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç»“æ„ä½“çš„éƒ¨åˆ†ï¼Œè®¿é—®å¯¹è±¡çš„ isa ä¼šç›´æ¥è¿”å›ä¸€ä¸ªæŒ‡å‘ cls çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åœ¨ iPhone è¿ç§»åˆ° 64 ä½ç³»ç»Ÿä¹‹å‰æ—¶ isa çš„ç±»å‹ã€‚</p></li><li><p>1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ â€”â€“ï¼ˆ<font color="red"><strong>å¼€å¯isaä¼˜åŒ–</strong></font> ï¼‰</p></li></ul></blockquote></li><li><p>has_sidetable_rc (æ ‡è®°æ˜¯å¦ä½¿ç”¨SideTableå­˜å‚¨å¼•ç”¨è®¡æ•°)</p><blockquote><ul><li>0ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨<code>extra_rc</code>ä¸­,`extra_rcï¼‰å°±æ˜¯æ€»çš„å¼•ç”¨è®¡æ•°ã€‚ï¼ˆ<font color="red">å¼€å¯æŒ‡é’ˆä¼˜åŒ– &amp;&amp; extra_rcå­—æ®µç§»æœªæº¢å‡ºçš„æƒ…å†µä¸‹</font>ï¼‰</li><li>1 ï¼Œå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå« SideTable çš„ç±»çš„RefcountMapå±æ€§ä¸­; ä»SideTableæ‹¿åˆ°çš„å¼•ç”¨è®¡æ•°åŠ ä¸Š<code>extra_rc</code>+<code>1</code>å°±æ˜¯æ€»çš„å¼•ç”¨è®¡æ•°ã€‚ï¼ˆ<font color="red"> 1.æœªå¼€å¯æŒ‡é’ˆä¼˜åŒ– ; 2.å¼€å¯æŒ‡é’ˆä¼˜åŒ– &amp;&amp; &nbsp;extra_rcå­—æ®µç§»æº¢å‡ºçš„æƒ…å†µä¸‹</font>ï¼‰</li></ul></blockquote></li><li><p>extra_rc (å¼€å¯æŒ‡é’ˆä¼˜åŒ–çš„å¯¹è±¡ï¼Œå­˜æ”¾å…¶å¼•ç”¨è®¡æ•°)</p><blockquote><p><font color="red">æ³¨æ„ï¼šobjc4-818ç‰ˆæœ¬ä¹‹åextra_rc å€¼å°±æ˜¯æœ‰æ•ˆå¼•ç”¨è®¡æ•°å€¼ä¸åŠ 1ï¼›alloc åˆå§‹åŒ–æ—¶<code>extra_rc</code>==1ï¼›,ä¹‹å‰æ˜¯åœ¨rootRetainCounté‡Œ+1</font></p></blockquote></li><li><p>shiftcls (å­˜æ”¾ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯)</p><blockquote><p><code>isa</code>&amp;<code>ISA_MASK</code> : ç»“æœæ˜¾ç¤º<code>é«˜17ä½</code>æ˜¯<code>0</code>ï¼Œ<code>ä½3ä½</code>æ˜¯<code>0</code>ï¼Œä¸­é—´çš„<code>44ä½</code>æ˜¯<code>1</code>ï¼Œç”¨æ¥æ˜¾ç¤º<code>isa</code>ä¸­çš„<code>shiftcls</code>ã€‚<code>ISA_MASK</code> å°±åƒä¸€ä¸ªé¢å…·æŠŠéœ²å‡ºæ¥çš„æ˜¾ç¤ºï¼Œå…¶å®ƒçš„å…¨éƒ¨æŠ¹æ‰ã€‚</p></blockquote></li></ul><h3 id="3-2-3-isaå®ä¾‹åŒ–æ–¹å¼"><a href="#3-2-3-isaå®ä¾‹åŒ–æ–¹å¼" class="headerlink" title="3.2.3 isaå®ä¾‹åŒ–æ–¹å¼"></a>3.2.3 isaå®ä¾‹åŒ–æ–¹å¼</h3><blockquote><p>ç”±isaæºç å¾—çŸ¥ï¼Œisa_tæä¾›äº†ä¸¤ä¸ªæˆå‘˜ï¼Œ<code>cls</code>  å’Œ <code> bits</code>ï¼Œç”±è”åˆä½“çš„å®šä¹‰æ‰€çŸ¥ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜æ˜¯<strong>äº’æ–¥</strong>çš„ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œå½“åˆå§‹åŒ–isaæŒ‡é’ˆæ—¶ï¼Œæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼</p><ul><li>é€šè¿‡<code>cls</code>åˆå§‹åŒ–ï¼Œ<code>bits</code>æ— é»˜è®¤å€¼</li><li>é€šè¿‡<code>bits</code>åˆå§‹åŒ–ï¼Œ<code>cls</code> æœ‰é»˜è®¤å€¼</li></ul></blockquote><h3 id="3-2-4-éªŒè¯isa-tä½åŸŸ"><a href="#3-2-4-éªŒè¯isa-tä½åŸŸ" class="headerlink" title="3.2.4 éªŒè¯isa_tä½åŸŸ"></a>3.2.4 éªŒè¯isa_tä½åŸŸ</h3><p>æ–¹æ³•ï¼šä½¿ç”¨objcæºç æ„å»ºå¯ç¼–è¯‘å·¥ç¨‹ï¼Œç„¶ååœ¨mainä¸­çš„<code>[YLPerson alloc]</code> (æ³¨ï¼šYLPersonæœªå¼€å¯<code>+load</code>æ–¹æ³•)æ–­ç‚¹ â€“&gt; <code>initInstanceIsa</code> â€“&gt; <code>initIsa</code> â€“&gt; èµ°åˆ°<code>else</code>ä¸­çš„ <code>isa</code>åˆå§‹åŒ–;</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// isaåˆå§‹åŒ–åº•å±‚ä»£ç </span><br><span class="line">inline void </span><br><span class="line">objc_object::initIsa(Class cls, bool nonpointer, UNUSED_WITHOUT_INDEXED_ISA_AND_DTOR_BIT bool hasCxxDtor)</span><br><span class="line">{ </span><br><span class="line">    ASSERT(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    isa_t newisa(0);</span><br><span class="line"></span><br><span class="line">    if (!nonpointer) { // é€šè¿‡clsåˆå§‹åŒ–ï¼Œä¸è®¾ç½®bitsé»˜è®¤å€¼</span><br><span class="line">        newisa.setClass(cls, this);</span><br><span class="line">    } else {</span><br><span class="line">        ASSERT(!DisableNonpointerIsa);</span><br><span class="line">        ASSERT(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line">      </span><br><span class="line">#if SUPPORT_INDEXED_ISA</span><br><span class="line">        ASSERT(cls-&gt;classArrayIndex() &gt; 0);</span><br><span class="line">        newisa.bits = ISA_INDEX_MAGIC_VALUE;</span><br><span class="line">        // isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        // isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">        newisa.indexcls = (uintptr_t)cls-&gt;classArrayIndex();</span><br><span class="line">#else</span><br><span class="line">        newisa.bits = ISA_MAGIC_VALUE; </span><br><span class="line">        // isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        // isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">#   if ISA_HAS_CXX_DTOR_BIT</span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">#   endif</span><br><span class="line">        newisa.setClass(cls, this); // é€šè¿‡bitsåˆå§‹åŒ–ï¼Œè®¾ç½®clsé»˜è®¤å€¼</span><br><span class="line">#endif</span><br><span class="line">        newisa.extra_rc = 1;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // This write must be performed in a single store in some cases</span><br><span class="line">    // (for example when realizing a class because other threads</span><br><span class="line">    // may simultaneously try to use the class).</span><br><span class="line">    // fixme use atomics here to guarantee single-store and to</span><br><span class="line">    // guarantee memory order w.r.t. the class index table</span><br><span class="line">    // ...but not too atomic because we don't want to hurt instantiation</span><br><span class="line">    isa = newisa;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡bitsåˆå§‹åŒ–å‰åå¯¹æ¯”ï¼š</p><img src="/Users/tangh/yuki/iOSç»ƒä¹ Demos/YLNote/YLNote/latest/ä¸ªäººç¬”è®°/æ–‡ç« /images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ.jpg" alt="isaéªŒè¯bitsä½åŸŸ" style="zoom:80%;"><p>å…¶ä¸­<code>magic</code>æ˜¯<code>59</code>æ˜¯ç”±äºå°†<code>isa</code>æŒ‡é’ˆåœ°å€è½¬æ¢ä¸º<code>äºŒè¿›åˆ¶</code>ï¼Œä»<code>47</code>ï¼ˆå› ä¸ºå‰é¢æœ‰4ä¸ªä½åŸŸï¼Œå…±å ç”¨47ä½ï¼Œåœ°å€æ˜¯ä»0å¼€å§‹ï¼‰ä½å¼€å§‹è¯»å–<code>6</code>ä½ï¼Œå†è½¬æ¢ä¸º<code>åè¿›åˆ¶</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="../assets/images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ_0.jpg" alt="isaéªŒè¯bitsä½åŸŸ" style="zoom:80%;"><h3 id="3-2-5-isa-ä¸-ç±»-çš„å…³è”"><a href="#3-2-5-isa-ä¸-ç±»-çš„å…³è”" class="headerlink" title="3.2.5 isa ä¸ ç±» çš„å…³è”"></a>3.2.5 isa ä¸ ç±» çš„å…³è”</h3><p><code>cls</code> ä¸ <code>isa</code> å…³è”<code>åŸç†</code>å°±æ˜¯<code>isa</code>æŒ‡é’ˆä¸­çš„<code>shiftcls</code>ä½åŸŸä¸­å­˜å‚¨äº†<code>ç±»ä¿¡æ¯</code>ï¼Œå…¶ä¸­<code>initInstanceIsa</code>çš„è¿‡ç¨‹æ˜¯å°† <code>calloc</code> æŒ‡é’ˆ å’Œå½“å‰çš„ <code>ç±»cls</code> å…³è”èµ·æ¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç§éªŒè¯æ–¹å¼ï¼š</p><ul><li>ã€æ–¹å¼ä¸€ã€‘é€šè¿‡ä»¥ä¸Š<code>initIsa</code>æ–¹æ³•ä¸­çš„<code>newisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;</code>éªŒè¯</li><li>ã€æ–¹å¼äºŒã€‘é€šè¿‡<code>isaæŒ‡é’ˆåœ°å€</code>ä¸<code>ISA_MSAK</code> çš„å€¼ <code>&amp;</code> æ¥éªŒè¯</li><li>ã€æ–¹å¼ä¸‰ã€‘é€šè¿‡runtimeçš„æ–¹æ³•<code>object_getClass</code>éªŒè¯</li><li>ã€æ–¹å¼å››ã€‘é€šè¿‡<code>ä½è¿ç®—</code>éªŒè¯</li></ul><p>å‚è€ƒï¼šé“¾æ¥ï¼š<a href="https://juejin.cn/post/6949580932479189029">https://juejin.cn/post/6949580932479189029</a></p><h2 id="3-3-chceh-tåˆ†æ"><a href="#3-3-chceh-tåˆ†æ" class="headerlink" title="3.3 chceh_tåˆ†æ"></a>3.3 chceh_tåˆ†æ</h2><h3 id="3-3-1-chceh-tåº•å±‚æºç "><a href="#3-3-1-chceh-tåº•å±‚æºç " class="headerlink" title="3.3.1 chceh_tåº•å±‚æºç "></a>3.3.1 chceh_tåº•å±‚æºç </h3><p>objc790,ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_t</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span>  * _<span class="title">buckets</span>;</span>  <span class="comment">//  æ•£åˆ—è¡¨, æ˜¯ä¸€ä¸ªæ•°ç»„, æ•°ç»„é‡Œé¢çš„æ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªbucket_t, bucket_té‡Œé¢å­˜æ”¾ç€ SEL å’Œä¸€ä¸ªIMPã€‚IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘äº†ä¸€ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚</span></span><br><span class="line">    <span class="keyword">mask_t</span> _mask;         <span class="comment">//  _maskæ˜¯æŒ‡æ©ç æ•°æ®ï¼Œç”¨äºåœ¨å“ˆå¸Œç®—æ³•æˆ–è€…å“ˆå¸Œå†²çªç®—æ³•ä¸­è®¡ç®—å“ˆå¸Œä¸‹æ ‡ï¼Œå…¶ä¸­mask ç­‰äºcapacity - 1</span></span><br><span class="line">    <span class="keyword">mask_t</span> _occupied;  <span class="comment">// è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­&nbsp;sel-imp&nbsp;çš„å ç”¨å¤§å°&nbsp;(å³å¯ä»¥ç†è§£ä¸ºåˆ†é…çš„å†…å­˜ä¸­å·²ç»å­˜å‚¨äº†sel-impçš„çš„ä¸ªæ•°)</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>objc818ï¼Œï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_t</span> {</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    explicit_atomic&lt;<span class="keyword">uintptr_t</span>&gt; _bucketsAndMaybeMask;            <span class="comment">// 8</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">            explicit_atomic&lt;<span class="keyword">mask_t</span>&gt;    _maybeMask;              <span class="comment">// 4 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __LP64__</span></span><br><span class="line">            <span class="keyword">uint16_t</span>                   _flags;                  <span class="comment">// 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">uint16_t</span>                   _occupied;               <span class="comment">// 2</span></span><br><span class="line">        };</span><br><span class="line">        explicit_atomic&lt;<span class="keyword">preopt_cache_t</span> *&gt; _originalPreoptCache; <span class="comment">// 8</span></span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="bucket-tç»“æ„"><a href="#bucket-tç»“æ„" class="headerlink" title="bucket_tç»“æ„"></a><strong>bucket_tç»“æ„</strong></h4><p>bucket_t ä¸­selï¼Œimpçš„é¡ºåºå¯¹åº”åœ¨ä¸åŒå¹³å°å…ˆåé¡ºåºä¸ä¸€æ ·ï¼›</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 3.3.2 cache_t çš„ insert æ“ä½œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</span><br><span class="line"></span><br><span class="line">&gt; - ã€ç¬¬ä¸€æ­¥ã€‘è®¡ç®—å‡ºå½“å‰çš„ç¼“å­˜å ç”¨é‡</span><br><span class="line">&gt;</span><br><span class="line">&gt; â€‹    æ ¹æ®occupiedçš„å€¼è®¡ç®—å‡ºå½“å‰çš„ç¼“å­˜å ç”¨é‡ï¼Œå…³äºç¼“å­˜å ç”¨é‡çš„è®¡ç®—ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š</span><br><span class="line">&gt;</span><br><span class="line">&gt; - - allocç”³è¯·ç©ºé—´æ—¶ï¼Œæ­¤æ—¶çš„å¯¹è±¡å·²ç»åˆ›å»ºï¼Œå¦‚æœå†è°ƒç”¨initæ–¹æ³•ï¼Œoccupiedä¹Ÿä¼š+1</span><br><span class="line">&gt;   - å½“æœ‰å±æ€§èµ‹å€¼æ—¶ï¼Œä¼šéšå¼è°ƒç”¨setæ–¹æ³•ï¼Œoccupiedä¹Ÿä¼šå¢åŠ ï¼Œå³æœ‰å‡ ä¸ªå±æ€§èµ‹å€¼ï¼Œoccupiedå°±ä¼šåœ¨åŸæœ‰çš„åŸºç¡€ä¸ŠåŠ å‡ ä¸ª</span><br><span class="line">&gt;   - å½“æœ‰æ–¹æ³•è°ƒç”¨æ—¶ï¼Œoccupiedä¹Ÿä¼šå¢åŠ ï¼Œå³æœ‰å‡ æ¬¡è°ƒç”¨ï¼Œoccupiedå°±ä¼šåœ¨åŸæœ‰çš„åŸºç¡€ä¸ŠåŠ å‡ ä¸ª</span><br><span class="line">&gt;</span><br><span class="line">&gt; - ã€ç¬¬äºŒæ­¥ã€‘æ ¹æ® ç¼“å­˜å ç”¨é‡ åˆ¤æ–­æ‰§è¡Œçš„æ“ä½œ</span><br><span class="line">&gt;</span><br><span class="line">&gt; - - å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œåˆ™é»˜è®¤å¼€è¾Ÿ4ä¸ª</span><br><span class="line">&gt;   - å¦‚æœç¼“å­˜å ç”¨é‡å°äºç­‰äº3/4ï¼ˆnewOccupied + CACHE_END_MARKER &lt;=  capacity * 3 / 4ï¼‰ï¼Œåˆ™ä¸ä½œä»»ä½•å¤„ç†</span><br><span class="line">&gt;   - å¦‚æœç¼“å­˜å ç”¨é‡è¶…è¿‡3/4ï¼Œåˆ™éœ€è¦è¿›è¡Œä¸¤å€æ‰©å®¹ä»¥åŠè°ƒç”¨ **realloc**æ–¹æ³• é‡æ–°å¼€è¾Ÿç©ºé—´</span><br><span class="line">&gt;</span><br><span class="line">&gt; - ã€ç¬¬ä¸‰æ­¥ã€‘é’ˆå¯¹éœ€è¦å­˜å‚¨çš„bucketè¿›è¡Œå†…éƒ¨impå’Œselèµ‹å€¼</span><br><span class="line">&gt;</span><br><span class="line">&gt; â€‹    è¿™éƒ¨åˆ†ä¸»è¦æ˜¯æ ¹æ®cache_hashæ–¹æ³•ï¼Œå³å“ˆå¸Œç®—æ³• ï¼Œè®¡ç®—sel-impå­˜å‚¨çš„å“ˆå¸Œä¸‹æ ‡ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</span><br><span class="line">&gt;</span><br><span class="line">&gt; - - å¦‚æœå“ˆå¸Œä¸‹æ ‡çš„ä½ç½®æœªå­˜å‚¨selï¼Œå³è¯¥ä¸‹æ ‡ä½ç½®è·å–selç­‰äº0ï¼Œæ­¤æ—¶å°†sel-impå­˜å‚¨è¿›å»ï¼Œå¹¶å°†occupiedå ç”¨å¤§å°åŠ 1</span><br><span class="line">&gt;   - å¦‚æœå½“å‰å“ˆå¸Œä¸‹æ ‡å­˜å‚¨çš„sel ç­‰äº å³å°†æ’å…¥çš„selï¼Œåˆ™ç›´æ¥è¿”å›</span><br><span class="line">&gt;   - å¦‚æœå½“å‰å“ˆå¸Œä¸‹æ ‡å­˜å‚¨çš„sel ä¸ç­‰äº å³å°†æ’å…¥çš„selï¼Œåˆ™é‡æ–°ç»è¿‡cache_nextæ–¹æ³• å³å“ˆå¸Œå†²çªç®—æ³•ï¼Œé‡æ–°è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ°æ–°çš„ä¸‹æ ‡ï¼Œå†å»å¯¹æ¯”è¿›è¡Œå­˜å‚¨</span><br><span class="line"></span><br><span class="line">### 3.3.3 é¢è¯•é¢˜</span><br><span class="line"></span><br><span class="line">&gt; _maskæ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">&gt;</span><br><span class="line">&gt; ç­”ï¼š _maskæ˜¯æŒ‡æ©ç æ•°æ®ï¼Œç”¨äºåœ¨å“ˆå¸Œç®—æ³•æˆ–è€…å“ˆå¸Œå†²çªç®—æ³•ä¸­è®¡ç®—å“ˆå¸Œä¸‹æ ‡ï¼Œå…¶ä¸­mask ç­‰äºcapacity - 1ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br><span class="line">&gt; occupied æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">&gt;</span><br><span class="line">&gt; ç­”ï¼š_occupiedè¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­ sel-imp çš„å ç”¨å¤§å° (å³å¯ä»¥ç†è§£ä¸ºåˆ†é…çš„å†…å­˜ä¸­å·²ç»å­˜å‚¨äº†sel-impçš„çš„ä¸ªæ•°)ï¼Œ</span><br><span class="line">&gt;</span><br><span class="line">&gt; &gt; * initä¼šå¯¼è‡´occupiedå˜åŒ–</span><br><span class="line">&gt; &gt; * å±æ€§èµ‹å€¼ï¼Œä¹Ÿä¼šéšå¼è°ƒç”¨ï¼Œå¯¼è‡´occupiedå˜åŒ–</span><br><span class="line">&gt; &gt; * æ–¹æ³•è°ƒç”¨ï¼Œå¯¼è‡´occupiedå˜åŒ–</span><br><span class="line">&gt;</span><br><span class="line">&gt; ä¸ºä»€ä¹ˆéšç€æ–¹æ³•è°ƒç”¨çš„å¢å¤šï¼Œå…¶æ‰“å°çš„occupied å’Œ maskä¼šå˜åŒ–ï¼Ÿ</span><br><span class="line">&gt;</span><br><span class="line">&gt; ç­”ï¼š å› ä¸ºåœ¨cacheåˆå§‹åŒ–æ—¶ï¼Œåˆ†é…çš„ç©ºé—´æ˜¯4ä¸ªï¼Œéšç€æ–¹æ³•è°ƒç”¨çš„å¢å¤šï¼Œå½“å­˜å‚¨çš„sel-impä¸ªæ•°ï¼Œå³newOccupied + CACHE_END_MARKERï¼ˆç­‰äº1ï¼‰çš„å’Œ è¶…è¿‡ æ€»å®¹é‡çš„3/4æ—¶ï¼Œä¾‹å¦‚æ€»å®¹é‡ä¸º4ï¼Œå½“occupied ç­‰äº2æ—¶ï¼Œå°±éœ€è¦å¯¹cacheçš„å†…å­˜è¿›è¡Œä¸¤å€æ‰©å®¹ã€‚</span><br><span class="line"></span><br><span class="line">å‚è€ƒï¼š</span><br><span class="line"></span><br><span class="line">https://juejin.cn/post/6976938077822386190#heading-3</span><br><span class="line"></span><br><span class="line">https://juejin.cn/post/6978501444911497247#heading-1</span><br><span class="line"></span><br><span class="line">- </span><br><span class="line"></span><br><span class="line">## 3.4 TODOï¼š class_data_bits_tåˆ†æï¼ˆç†è§£äº†runtimeæ–¹æ³•åŠ è½½è¿‡ç¨‹å†æ¥è¡¥å……ï¼‰</span><br><span class="line"></span><br><span class="line">### 3.4.3  ivarè§£æ</span><br><span class="line"></span><br><span class="line">#### 3.4.3.1 **ivarLayout** ä¸ **weakIvarLayout** è§„åˆ™è§£æ</span><br><span class="line"></span><br><span class="line">ivarLayout å’Œ weakIvarLayout åˆ†åˆ«è®°å½•äº†å“ªäº› ivar æ˜¯ strong æˆ–æ˜¯ weakï¼Œéƒ½æœªè®°å½•çš„å°±æ˜¯åŸºæœ¬ç±»å‹å’Œ __unsafe_unretained çš„å¯¹è±¡ç±»å‹ã€‚</span><br><span class="line"></span><br><span class="line">å…·ä½“è®°å½•è§„åˆ™ï¼š</span><br><span class="line"></span><br><span class="line">- é¦–å…ˆç”±äº ivarLayout ä¸ weakIvarLayout éƒ½æ˜¯ uint8_t ç±»å‹ï¼Œåœ¨ 16 è¿›åˆ¶ä¸‹æ˜¯ä¸¤ä½ï¼Œæ‰€ä»¥ç¼–ç çš„å€¼æ¯ä¸¤ä½ä¸€å¯¹å„¿</span><br><span class="line">- ivarLayoutï¼šæ•°æ®å¯æ‹†è§£ä¸º æ¯ä¸¤ä½ä¸ºä¸€ç»„ï¼Œä¸€ç»„ä¸­ç¬¬ä¸€ä½è¡¨ç¤ºè¿ç»­çš„ éStrongä¿®é¥°çš„æ•°é‡ï¼Œç¬¬äºŒä½ä¸º Strong ä¿®é¥°çš„æ•°é‡ï¼Œæœ€åä¸¤ä½ **00** ä¸ºç»“æŸç¬¦ï¼Œå°±åƒ cstring çš„ **\0** ä¸€æ ·</span><br><span class="line">- weakIvarLayoutï¼šæ•°æ®å¯æ‹†è§£ä¸º æ¯ä¸¤ä½ä¸ºä¸€ç»„ï¼Œä¸€ç»„ä¸­ç¬¬ä¸€ä½è¡¨ç¤ºè¿ç»­çš„ éWeakä¿®é¥°çš„æ•°é‡ï¼Œç¬¬äºŒä½ä¸º Weak ä¿®é¥°çš„æ•°é‡ï¼Œæœ€åä¸¤ä½ **00** ä¸ºç»“æŸç¬¦ï¼Œå°±åƒ cstring çš„ **\0** ä¸€æ ·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ğŸŒ°ä»£ç  1ï¼š</span><br><span class="line"></span><br><span class="line">â€‹```objc</span><br><span class="line">@interface Foo : NSObject {</span><br><span class="line">  __strong id ivar0;</span><br><span class="line">  __weak id ivar1;</span><br><span class="line">  __weak id ivar2;</span><br><span class="line">}</span><br><span class="line">@end</span><br></pre></td></tr></tbody></table></figure><p>åˆ™å‚¨å­˜ strong ivar çš„ ivarLayout çš„å€¼ä¸º <strong>0x012000</strong></p><p>å‚¨å­˜ weak ivar çš„ weakIvarLayout çš„å€¼ä¸º <strong>0x1200</strong></p><p>ğŸŒ°ä»£ç  2ï¼š</p><figure class="highlight objc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Bar</span> : <span class="title">NSObject</span> </span>{</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">id</span> ivar0;</span><br><span class="line">  __<span class="keyword">strong</span> <span class="keyword">id</span> ivar1;</span><br><span class="line">  __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> ivar2;</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">id</span> ivar3;</span><br><span class="line">  __<span class="keyword">strong</span> <span class="keyword">id</span> ivar4;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></tbody></table></figure><p>åˆ™å‚¨å­˜ strong ivar çš„ ivarLayout çš„å€¼ä¸º <strong>0x112100</strong></p><p>å‚¨å­˜ weak ivar çš„ weakIvarLayout çš„å€¼ä¸º <strong>0x01211000</strong></p><h1 id="4-å¯¹è±¡çš„ç»“æ„åˆ†æ"><a href="#4-å¯¹è±¡çš„ç»“æ„åˆ†æ" class="headerlink" title="4. å¯¹è±¡çš„ç»“æ„åˆ†æ"></a>4. å¯¹è±¡çš„ç»“æ„åˆ†æ</h1><h2 id="4-1-å¯¹è±¡çš„æœ¬è´¨"><a href="#4-1-å¯¹è±¡çš„æœ¬è´¨" class="headerlink" title="4.1 å¯¹è±¡çš„æœ¬è´¨"></a>4.1 å¯¹è±¡çš„æœ¬è´¨</h2><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_å¯¹è±¡çš„æœ¬è´¨_0.png" alt="YLPetç¼–è¯‘å‰" style="zoom:50%;"><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_å¯¹è±¡çš„æœ¬è´¨_1.png" alt="YLPetç¼–è¯‘å" style="zoom:50%;"><p>ç»“åˆæºç åˆ†æï¼š</p><p>YLPetçš„åº•å±‚å®ç°æ˜¯ä¸€ä¸ªstructã€‚å…¶å†…å®¹ä¸ºYLPet_IMPL ï¼š</p><ul><li>NSObject_IVARSï¼š // ç»§æ‰¿è‡ª <code>NSObject</code> çš„<code>isa</code>;NSObject åº•å±‚åªæœ‰ä¸€ä¸ªâ€isaâ€œå˜é‡ï¼Œæ‰€ä»¥ç»§æ‰¿æ¥çš„åªæœ‰è¿™ä¸€ä¸ªå˜é‡</li><li>genderï¼šæˆå‘˜å˜é‡ivar</li><li>_nameï¼šå±æ€§nameï¼Œè‡ªåŠ¨æ·»åŠ   â€œ__â€ç”Ÿæˆå¯¹åº”çš„æˆå‘˜å˜é‡</li><li>_ageï¼šå±æ€§ageï¼Œè‡ªåŠ¨æ·»åŠ   â€œ__â€ç”Ÿæˆå¯¹åº”çš„æˆå‘˜å˜é‡</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> {</span></span><br><span class="line">  <span class="keyword">isa_t</span> isa;</span><br><span class="line">  ...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">isa_t</span> {</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// Accessing the class requires custom ptrauth operations, so</span></span><br><span class="line">    <span class="comment">// force clients to go through setClass/getClass by making this</span></span><br><span class="line">    <span class="comment">// private.</span></span><br><span class="line">    Class cls;</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¯¹è±¡çš„æœ¬è´¨æ˜¯ä¸€ä¸ª<code>objc_object</code>ç±»å‹çš„ç»“æ„ä½“ï¼Œå…¶å†…éƒ¨åªæœ‰ä¸€ä¸ªisaæŒ‡é’ˆã€‚</p><h2 id="4-2-Tagged-Pointerå¯¹è±¡ï¼ˆç‰¹ä¾‹ï¼‰"><a href="#4-2-Tagged-Pointerå¯¹è±¡ï¼ˆç‰¹ä¾‹ï¼‰" class="headerlink" title="4.2 Tagged Pointerå¯¹è±¡ï¼ˆç‰¹ä¾‹ï¼‰"></a>4.2 Tagged Pointerå¯¹è±¡ï¼ˆç‰¹ä¾‹ï¼‰</h2><h3 id="4-2-1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer"><a href="#4-2-1-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer" class="headerlink" title="4.2.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer?"></a>4.2.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer?</h3><blockquote><p>å‡è®¾è¦å­˜å‚¨ä¸€ä¸ªNSNumberå¯¹è±¡ï¼Œå…¶å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¿™ä¸ªæ•´æ•°åªæ˜¯ä¸€ä¸ªNSIntegerçš„æ™®é€šå˜é‡ï¼Œåœ¨64ä½CPUä¸‹æ˜¯å 8ä¸ªå­—èŠ‚çš„ã€‚1ä¸ªå­—èŠ‚æœ‰8ä½ï¼Œå¦‚æœæˆ‘ä»¬å­˜å‚¨ä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œä¼šå‡ºç°å¾ˆå¤šä½éƒ½æ˜¯0çš„æƒ…å†µï¼Œè¿™æ ·å°±é€ æˆäº†å†…å­˜æµªè´¹ï¼Œè‹¹æœä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†taggedPointerçš„æ¦‚å¿µã€‚</p><p>ä»¥NSNumberä¸ºä¾‹ï¼Œå¯¹è±¡å ç”¨å†…å­˜ç©ºé—´æƒ…å†µï¼š</p><p>arm64ä¹‹å‰ï¼šæŒ‡é’ˆï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+ NSNumberå¯¹è±¡ï¼ˆ16ä¸ªå­—èŠ‚ å†…å­˜å¯¹é½ï¼‰</p><p>arm64ä¹‹åï¼šTaggedPointeræŒ‡é’ˆï¼ˆåªå 8å­—èŠ‚ï¼‰</p></blockquote><ul><li><strong>Tagged Pointer</strong>æ˜¯è‹¹æœä¸ºäº†è§£å†³32ä½CPUåˆ°64ä½CPUçš„è½¬å˜å¸¦æ¥çš„å†…å­˜å ç”¨å’Œæ•ˆç‡é—®é¢˜ï¼Œé’ˆå¯¹<strong>NSNumberã€NSDate</strong>ä»¥åŠéƒ¨åˆ†<strong>NSString</strong>çš„å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆã€‚</li><li><strong>Tagged PointeræŒ‡é’ˆ</strong>çš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒ<strong>ä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡</strong>äº†ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æ™®é€šå˜é‡è€Œå·²ã€‚æ‰€ä»¥ï¼Œå®ƒçš„<strong>å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼ˆè€Œæ˜¯åœ¨æ ˆä¸Šï¼‰ï¼Œä¹Ÿ</strong>ä¸éœ€è¦mallocå’Œfree**ã€‚</li><li><strong>Tagged PointeræŒ‡é’ˆ</strong>ä¸­åŒ…å«äº†å½“å‰å¯¹è±¡çš„åœ°å€ã€ç±»å‹ã€å…·ä½“æ•°å€¼ã€‚å› æ­¤Tagged PointeræŒ‡é’ˆåœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€3å€çš„æ•ˆç‡ï¼Œåˆ›å»ºæ—¶æ¯”æ™®é€šéœ€è¦<strong>malloc</strong>è·Ÿ<strong>free</strong>çš„ç±»å‹<strong>å¿«106å€</strong>ã€‚</li></ul><h3 id="4-2-2-å†…å­˜ç»“æ„"><a href="#4-2-2-å†…å­˜ç»“æ„" class="headerlink" title="4.2.2 å†…å­˜ç»“æ„"></a>4.2.2 å†…å­˜ç»“æ„</h3><img src="../assets/images/å†…å­˜ç®¡ç†_taggedPointer_64.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;"><img src="../assets/images/å†…å­˜ç®¡ç†_taggedPointer_64_2.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;"><p>æ³¨æ„ï¼šä¸macOSä¸åŒï¼ŒiOSç³»ç»Ÿé‡‡ç”¨ <code>MSB</code>ï¼ˆ<code>Most Significant Bit</code>ï¼Œå³æœ€é«˜æœ‰æ•ˆä½ï¼‰ä¸º<code>Tagged Pointer</code>æ ‡å¿—ä½ã€‚</p><h3 id="4-2-3-å„bitå«ä¹‰è§£é‡Š"><a href="#4-2-3-å„bitå«ä¹‰è§£é‡Š" class="headerlink" title="4.2.3 å„bitå«ä¹‰è§£é‡Š"></a>4.2.3 å„bitå«ä¹‰è§£é‡Š</h3><ul><li><p>_OBJC_TAG_MASK: å 1bitï¼Œæ˜¯<code>Tagged Pointer</code>æ ‡å¿—ä½ï¼Œ1æ„å‘³ç€è¯¥åœ°å€æ˜¯<code>Tagged Pointer</code>ï¼Œ0åˆ™ä¸æ˜¯ã€‚</p></li><li><p>Extended_Tag_Indexï¼šå 8bitï¼Œåªæœ‰å½“Tag_Index=7çš„æ—¶å€™æ‰å­˜åœ¨ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨äºæ‰©å±•çš„æ ‡å¿—ä½ï¼Œä¼šé¢å¤–å ç”¨8ä½æ¥å­˜å‚¨æ‰©å±•çš„Tag Indexã€‚ç±»æ ‡è¯†çš„åŸºæœ¬ç±»å‹å’Œæ‰©å±•ç±»å‹æˆ‘ä»¬å¯ä»¥åœ¨<code>Runtime</code>æºç ä¸­çš„<code>objc_tag_index_t</code>æŸ¥åˆ°ï¼š</p><img src="/Users/tangh/Library/Application Support/typora-user-images/image-20210806165118167.png" style="zoom:30%;"></li><li><p>Tag_Indexï¼šå 3bitï¼Œæ˜¯ç±»æ ‡å¿—ä½ï¼Œå¯ä»¥åœ¨<code>Runtime</code>æºç ä¸­æŸ¥çœ‹<code>NSNumber</code>ã€<code>NSDate</code>ã€<code>NSString</code>ç­‰ç±»çš„æ ‡å¿—ä½ã€‚</p></li><li><p>Payloadï¼šå¯¹NSNumberè€Œè¨€ï¼Œæœ€å¤šå 56bitï¼Œæœ€å°‘å 48bitï¼ˆå–å†³äºTag Indexæ˜¯å¦ä¸ºextended tag indexï¼‰ï¼Œå­˜å‚¨å…·ä½“çš„æ•°å€¼ã€‚</p></li><li><p>Type_Index: å 4bitï¼Œä»£è¡¨NSNumberå…·ä½“çš„æ•°æ®ç±»å‹ï¼Œå…·ä½“çš„å¯¹åº”å…³ç³»ï¼š</p><table><thead><tr><th>Type_Index</th><th>å¯¹åº”æ•°æ®ç±»å‹</th></tr></thead><tbody><tr><td>0</td><td>char</td></tr><tr><td>1</td><td>usigned char, short</td></tr><tr><td>2</td><td>unsigned short,int</td></tr><tr><td>3</td><td>unsigned int,NSInteger,NSUInteger,long,unsigned long,long long,unsigned long long</td></tr><tr><td>4</td><td>float</td></tr><tr><td>5</td><td>double</td></tr></tbody></table><p>ç»“è®ºï¼š<code>Tagged Pointer</code>å¯è¡¨ç¤ºçš„æ•°å­—èŒƒå›´æ˜¯-2^55+1 ~ 2^55-1ï¼Œå¯¹äºè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ•°å­—ï¼ŒNSNumberä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæ™®é€šçš„å†…å­˜åˆ†é…åœ¨å †ä¸Šçš„OCå¯¹è±¡ã€‚</p></li></ul><h3 id="4-2-4-å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged-Pointer"><a href="#4-2-4-å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged-Pointer" class="headerlink" title="4.2.4 å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged Pointer"></a>4.2.4 å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged Pointer</h3><p>åœ¨ <a href="https://link.juejin.cn/?target=https://github.com/Kanthine/SourceCode/blob/51fd88340a1d76047dcb8bb02e47f14482d00706/objc4-750/runtime/objc-internal.h">objc runtime</a>æºç ä¸­æ‰¾åˆ°äº† _objc_isTaggedPointer()çš„å®ç°ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> _objc_isTaggedPointer(<span class="keyword">const</span> <span class="keyword">void</span> * _Nullable ptr){</span><br><span class="line">    <span class="comment">//å°†ä¸€ä¸ªæŒ‡é’ˆåœ°å€å’Œ _OBJC_TAG_MASK å¸¸é‡åš &amp; è¿ç®—ï¼šåˆ¤æ–­è¯¥æŒ‡é’ˆçš„æœ€é«˜ä½æˆ–è€…æœ€ä½ä½ä¸º 1ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå°±æ˜¯ Tagged Pointerã€‚</span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>_OBJC_TAG_MASK</code> çš„å®šä¹‰ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OBJC_MSB_TAGGED_POINTERS <span class="comment">//MSB é«˜ä½ä¼˜å…ˆ</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63) <span class="comment">//Tagged Pointer æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">//LSB ä½ä½ä¼˜å…ˆ</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK 1UL <span class="comment">//Tagged Pointer æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><p>å› æ­¤<code> ptr &amp; _OBJC_TAG_MASK</code> æŒ‰ä½ä¸è¿ç®—ä¹‹åå¦‚æœåˆ¤æ–­æ ‡å¿—ä½ä¸º1åˆ™è¯¥æŒ‡é’ˆæ˜¯Tagged Pointer ã€‚</p><h3 id="4-2-5-TaggedPointeræ··æ·†åŸç†ï¼š"><a href="#4-2-5-TaggedPointeræ··æ·†åŸç†ï¼š" class="headerlink" title="4.2.5 TaggedPointeræ··æ·†åŸç†ï¼š"></a>4.2.5 TaggedPointeræ··æ·†åŸç†ï¼š</h3><p>æ··æ·†åŸç†ï¼šä½¿ç”¨ä¸€ä¸ªéšæœºæ•°<code>objc_debug_taggedpointer_obfuscator</code>å¯¹çœŸæ­£çš„å†…å­˜åœ°å€å¼‚æˆ–æ“ä½œã€‚æ ¹æ®å¼‚æˆ–è¿ç®—çš„ç‰¹æ€§ï¼Œa^b^b=aï¼Œå› æ­¤åªéœ€è¦å°†æ··æ·†åçš„åœ°å€å†ä¸<code>objc_debug_taggedpointer_obfuscator</code>å¼‚æˆ–ä¸€æ¬¡å°±èƒ½å¤Ÿå®Œæˆåæ··æ·†ã€‚</p><h3 id="4-2-6-é™„ï¼šTagged-Pointer-é’ˆå¯¹-obj-msg-send-çš„å¤„ç†"><a href="#4-2-6-é™„ï¼šTagged-Pointer-é’ˆå¯¹-obj-msg-send-çš„å¤„ç†" class="headerlink" title="4.2.6 é™„ï¼šTagged Pointer é’ˆå¯¹ obj_msg_send çš„å¤„ç†"></a>4.2.6 <strong>é™„</strong>ï¼šTagged Pointer é’ˆå¯¹ <strong>obj_msg_send</strong> çš„å¤„ç†</h3><p>â€‹    â€¢    å¯¹äºå†…ç½®Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜å››ä½ä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ï¼›</p><p>â€‹    â€¢    å¯¹äºè‡ªå®šä¹‰æ‰©å±•Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜52ä½åˆ°59ä½è¿™8ä½bitä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_ext_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ã€‚</p><h2 id="4-3-éTaggedPointerå¯¹è±¡"><a href="#4-3-éTaggedPointerå¯¹è±¡" class="headerlink" title="4.3 éTaggedPointerå¯¹è±¡"></a>4.3 éTaggedPointerå¯¹è±¡</h2><p>å¯¹è±¡æ˜¯å¦ä¸å¯ç”¨Non-pointerç›®å‰æœ‰è¿™ä¹ˆå‡ ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œè¿™äº›éƒ½å¯ä»¥åœ¨runtimeæºç objc-runtime-new.mä¸­æ‰¾åˆ°é€»è¾‘ã€‚</p><blockquote><p>1ï¼šåŒ…å«swiftä»£ç ï¼›<br>2ï¼šsdkç‰ˆæœ¬ä½äº10.11ï¼›<br>3ï¼šruntimeè¯»å–imageæ—¶å‘ç°è¿™ä¸ªimageåŒ…å«__objc_rawisaæ®µï¼›<br>4ï¼šå¼€å‘è€…è‡ªå·±æ·»åŠ äº†OBJC_DISABLE_NONPOINTER_ISA=YESåˆ°ç¯å¢ƒå˜é‡ä¸­ï¼›<br>5ï¼šæŸäº›ä¸èƒ½ä½¿ç”¨Non-pointerçš„ç±»ï¼ŒGCDç­‰ï¼›<br>6ï¼šçˆ¶ç±»å…³é—­ã€‚</p></blockquote><p>æˆ‘ä»¬è‡ªå·±æ–°å»ºä¸€ä¸ªPersonç±»ï¼Œé€šè¿‡OBJC_DISABLE_NONPOINTER_ISA=YES/NOæ¥çœ‹çœ‹isaç»“æ„ä½“çš„å…·ä½“å†…å®¹:</p><h3 id="4-3-1-non-poniterï¼š0-å¯¹è±¡"><a href="#4-3-1-non-poniterï¼š0-å¯¹è±¡" class="headerlink" title="4.3.1 non-poniterï¼š0 å¯¹è±¡"></a>4.3.1 non-poniterï¼š0 å¯¹è±¡</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">isa_t</span> isa = {</span><br><span class="line">    Class class = Person;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits = <span class="number">4294976320</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> nonpointer = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_assoc  = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_cxx_dtor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> shiftcls = <span class="number">536872040</span>; </span><br><span class="line">        <span class="keyword">uintptr_t</span> magic = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> weakly_referenced = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> deallocating = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_sidetable_rc = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> extra_rc = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">å…¶å®å¯ä»¥ç®€åŒ–ä¸º</span><br><span class="line"><span class="keyword">isa_t</span> isa = {</span><br><span class="line">    Class class = Person;</span><br><span class="line">}</span><br><span class="line">å› ä¸ºæºç ä¸­æ˜¾ç¤ºä¸ä½¿ç”¨Non-pointeråˆ™åªå¯¹isaçš„<span class="class"><span class="keyword">class</span>èµ‹å€¼äº†ï¼Œå…¶ä»–çš„éƒ½æ˜¯é»˜è®¤å€¼ï¼Œè€Œä¸”é™¤äº†<span class="keyword">class</span>å…¶ä»–æˆå‘˜ä¹Ÿä¸ä¼šåœ¨æºç ä¸­è¢«ä½¿ç”¨åˆ°ã€‚</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-3-2-non-poniterï¼š1-å¯¹è±¡"><a href="#4-3-2-non-poniterï¼š1-å¯¹è±¡" class="headerlink" title="4.3.2 non-poniterï¼š1 å¯¹è±¡"></a>4.3.2 non-poniterï¼š1 å¯¹è±¡</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">isa_t</span> isa = {</span><br><span class="line">    Class class = Person;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits = <span class="number">8303516107940673</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> nonpointer = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_assoc  = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_cxx_dtor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> shiftcls = <span class="number">536872040</span>; </span><br><span class="line">        <span class="keyword">uintptr_t</span> magic = <span class="number">59</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> weakly_referenced = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> deallocating = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> has_sidetable_rc = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uintptr_t</span> extra_rc = <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">extra_rcå°±æ˜¯å­˜çš„å¼•ç”¨è®¡æ•°ï¼Œnonpointer = <span class="number">1</span>è¡¨ç¤ºå¯ç”¨Non-pointerã€‚</span><br></pre></td></tr></tbody></table></figure><h1 id="5-allocæºç æ¢ç´¢"><a href="#5-allocæºç æ¢ç´¢" class="headerlink" title="5. allocæºç æ¢ç´¢"></a>5. allocæºç æ¢ç´¢</h1><h2 id="5-1-allocè°ƒç”¨å †æ ˆï¼š"><a href="#5-1-allocè°ƒç”¨å †æ ˆï¼š" class="headerlink" title="5.1 allocè°ƒç”¨å †æ ˆï¼š"></a>5.1 allocè°ƒç”¨å †æ ˆï¼š</h2><p><code>+ alloc</code> â€”-&gt; <code>_objc_rootAlloc</code> â€”&gt; <code>callAlloc(cls, false/*checkNil*/, true/*allocWithZone*/);</code> â€”-&gt; <code>_objc_rootAllocWithZone</code> â€”&gt; <code>_class_createInstanceFromZone</code>ï¼›</p><p>æ ¸å¿ƒä»£ç <code>_class_createInstanceFromZone</code>æ–¹æ³•å†…éƒ¨å®ç°ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ALWAYS_INLINE id</span><br><span class="line">_class_createInstanceFromZone(Class cls, <span class="keyword">size_t</span> extraBytes, <span class="keyword">void</span> *zone,</span><br><span class="line">                              <span class="keyword">int</span> construct_flags = OBJECT_CONSTRUCT_NONE,</span><br><span class="line">                              <span class="keyword">bool</span> cxxConstruct = <span class="literal">true</span>,</span><br><span class="line">                              <span class="keyword">size_t</span> *outAllocatedSize = nil)<span class="comment">// alloc æºç  ç¬¬äº”æ­¥</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">ASSERT</span>(cls-&gt;<span class="built_in">isRealized</span>()); <span class="comment">//æ£€æŸ¥æ˜¯å¦å·²ç»å®ç°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read class's info bits all at once for performance</span></span><br><span class="line">    <span class="comment">//ä¸€æ¬¡æ€§è¯»å–ç±»çš„ä½ä¿¡æ¯ä»¥æé«˜æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">bool</span> hasCxxCtor = cxxConstruct &amp;&amp; cls-&gt;<span class="built_in">hasCxxCtor</span>();</span><br><span class="line">    <span class="keyword">bool</span> hasCxxDtor = cls-&gt;<span class="built_in">hasCxxDtor</span>();</span><br><span class="line">    <span class="keyword">bool</span> fast = cls-&gt;<span class="built_in">canAllocNonpointer</span>();</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—éœ€è¦å¼€è¾Ÿçš„å†…å­˜å¤§å°ï¼Œä¼ å…¥çš„extraBytes ä¸º 0</span></span><br><span class="line">    size = cls-&gt;<span class="built_in">instanceSize</span>(extraBytes);</span><br><span class="line">    <span class="keyword">if</span> (outAllocatedSize) *outAllocatedSize = size;</span><br><span class="line"></span><br><span class="line">    id obj;</span><br><span class="line">    <span class="keyword">if</span> (zone) {</span><br><span class="line">        obj = (id)<span class="built_in">malloc_zone_calloc</span>((<span class="keyword">malloc_zone_t</span> *)zone, <span class="number">1</span>, size);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//ç”³è¯·å†…å­˜</span></span><br><span class="line">        obj = (id)<span class="built_in">calloc</span>(<span class="number">1</span>, size);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(!obj)) {</span><br><span class="line">        <span class="keyword">if</span> (construct_flags &amp; OBJECT_CONSTRUCT_CALL_BADALLOC) {</span><br><span class="line">            <span class="keyword">return</span> _objc_callBadAllocHandler(cls);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!zone &amp;&amp; fast) {</span><br><span class="line">        <span class="comment">//å°† clsç±» ä¸ objæŒ‡é’ˆï¼ˆå³isaï¼‰ å…³è”</span></span><br><span class="line">        obj-&gt;<span class="built_in">initInstanceIsa</span>(cls, hasCxxDtor);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// Use raw pointer isa on the assumption that they might be</span></span><br><span class="line">        <span class="comment">// doing something weird with the zone or RR.</span></span><br><span class="line">        obj-&gt;<span class="built_in">initIsa</span>(cls);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!hasCxxCtor)) {</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    construct_flags |= OBJECT_CONSTRUCT_FREE_ONFAILURE;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">object_cxxConstructFromClass</span>(obj, cls, construct_flags);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="5-2-æ ¸å¿ƒä¸‰æ­¥ï¼š"><a href="#5-2-æ ¸å¿ƒä¸‰æ­¥ï¼š" class="headerlink" title="5.2 æ ¸å¿ƒä¸‰æ­¥ï¼š"></a>5.2 æ ¸å¿ƒä¸‰æ­¥ï¼š</h2><ul><li><p>è®¡ç®—instancesize ï¼ˆ<strong>è¿™é‡Œæœ‰ä¸€ä¸ª16å­—èŠ‚å¯¹é½</strong>ï¼‰</p><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size = cls-&gt;<span class="built_in">instanceSize</span>(extraBytes);</span><br></pre></td></tr></tbody></table></figure><p>ä¸ºä»€ä¹ˆéœ€è¦16å­—èŠ‚å¯¹é½?</p><p>â€‹        éœ€è¦å­—èŠ‚å¯¹é½çš„åŸå› ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>é€šå¸¸å†…å­˜æ˜¯ç”±ä¸€ä¸ªä¸ªå­—èŠ‚ç»„æˆçš„ï¼Œcpuåœ¨å­˜å–æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½å­˜å‚¨ï¼Œè€Œæ˜¯ä»¥<code>å—</code>ä¸ºå•ä½å­˜å–ï¼Œå—çš„å¤§å°ä¸ºå†…å­˜å­˜å–åŠ›åº¦ã€‚é¢‘ç¹å­˜å–å­—èŠ‚æœªå¯¹é½çš„æ•°æ®ï¼Œä¼šæå¤§é™ä½cpuçš„æ€§èƒ½ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>å‡å°‘å­˜å–æ¬¡æ•°</code>æ¥<code>é™ä½cpuçš„å¼€é”€</code></li><li>16å­—èŠ‚å¯¹é½ï¼Œæ˜¯ç”±äºåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œç¬¬ä¸€ä¸ªå±æ€§<code>isa</code>å <code>8</code>å­—èŠ‚ï¼Œå½“ç„¶ä¸€ä¸ªå¯¹è±¡è‚¯å®šè¿˜æœ‰å…¶ä»–å±æ€§ï¼Œå½“æ— å±æ€§æ—¶ï¼Œä¼šé¢„ç•™8å­—èŠ‚ï¼Œå³16å­—èŠ‚å¯¹é½ï¼Œå¦‚æœä¸é¢„ç•™ï¼Œç›¸å½“äºè¿™ä¸ªå¯¹è±¡çš„isaå’Œå…¶ä»–å¯¹è±¡çš„isaç´§æŒ¨ç€ï¼Œå®¹æ˜“é€ æˆè®¿é—®æ··ä¹±</li><li>16å­—èŠ‚å¯¹é½åï¼Œå¯ä»¥<code>åŠ å¿«CPUè¯»å–é€Ÿåº¦</code>ï¼ŒåŒæ—¶ä½¿<code>è®¿é—®æ›´å®‰å…¨</code>ï¼Œä¸ä¼šäº§ç”Ÿè®¿é—®æ··ä¹±çš„æƒ…å†µ</li></ul></blockquote></li><li><p>å¼€è¾Ÿç©ºé—´å¤§å°ï¼Œè¿”å›å¯¹è±¡åœ°å€</p><blockquote><p>é€šè¿‡<code>instanceSize</code>è®¡ç®—çš„å†…å­˜å¤§å°ï¼Œå‘å†…å­˜ä¸­ç”³è¯· å¤§å° ä¸º sizeçš„å†…å­˜ï¼Œå¹¶èµ‹å€¼ç»™objï¼Œå› æ­¤ objæ˜¯æŒ‡å‘å†…å­˜åœ°å€çš„æŒ‡é’ˆ</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj = (id)<span class="built_in">calloc</span>(<span class="number">1</span>, size);</span><br></pre></td></tr></tbody></table></figure></blockquote></li><li><p>ç±»ä¸isaå…³è”</p><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-&gt;<span class="built_in">initInstanceIsa</span>(cls, hasCxxDtor);</span><br></pre></td></tr></tbody></table></figure><p>_class_createInstanceFromZone å†…éƒ¨:  </p><p><code>obj-&gt;initInstanceIsa(cls, hasCxxDtor);</code> â€”&gt;   <code>initIsa(cls, true, hasCxxDtor); </code>  â€“&gt;   <code> newisa.setClass(cls, this);</code></p></blockquote></li></ul><h1 id="6-é¢è¯•é¢˜"><a href="#6-é¢è¯•é¢˜" class="headerlink" title="6.é¢è¯•é¢˜"></a>6.é¢è¯•é¢˜</h1><h4 id="ä»€ä¹ˆæ˜¯ç±»ï¼Ÿä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç±»ï¼Ÿä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç±»ï¼Ÿä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç±»ï¼Ÿä»€ä¹ˆæ˜¯å¯¹è±¡ï¼Ÿ</h4><p>ç­”ï¼šåœ¨é¢å‘å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<font color="red"><strong>ç±»</strong></font>æ¥æè¿°<font color="red"><strong>å…·æœ‰ç‰¹å®šå±æ€§å’Œè¡Œä¸ºçš„ä¸€ç±»äº‹ç‰©</strong></font>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼›è€Œå¯¹è±¡æ˜¯æ¨¡æ¿çš„ä¸€ä¸ªå…·è±¡å®ä½“ã€‚</p><h4 id="NSObjectå¯¹è±¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#NSObjectå¯¹è±¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="NSObjectå¯¹è±¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>NSObjectå¯¹è±¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>ç­”ï¼šæœ¬è´¨æ˜¯ä¸€ä¸ªobjc_objectçš„ç»“æ„ä½“ï¼Œå…¶æˆå‘˜å˜é‡åªæœ‰ä¸€ä¸ªisaæŒ‡é’ˆï¼›</p><h4 id="objc-object-ä¸-å¯¹è±¡çš„å…³ç³»"><a href="#objc-object-ä¸-å¯¹è±¡çš„å…³ç³»" class="headerlink" title="objc_object ä¸ å¯¹è±¡çš„å…³ç³»"></a>objc_object ä¸ å¯¹è±¡çš„å…³ç³»</h4><p>ç­”ï¼š<strong>OCä¸­æ‰€æœ‰ç»§æ‰¿è‡ª<code>NSObject</code>ç±»ç”Ÿæˆçš„å¯¹è±¡ï¼Œéƒ½æ˜¯<code>struct objc_object</code>ç±»å‹</strong>ã€‚</p><p><strong>OCä¸­æ‰€æœ‰ç»§æ‰¿è‡ª<code>NSObject</code>çš„ç±»ç”Ÿæˆçš„å¯¹è±¡ï¼Œéƒ½å…·æœ‰Classç±»å‹çš„<code>isa</code>æˆå‘˜</strong></p><blockquote><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Object.mm line 34</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br></pre></td></tr></tbody></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ**<code>id</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>struct objc_object</code>çš„æŒ‡é’ˆç±»å‹ï¼›**</p><p>OCä¸­æ‰€æœ‰ç»§æ‰¿è‡ª<code>NSObject</code>ç±»ç”Ÿæˆçš„å¯¹è±¡ï¼Œéƒ½æ˜¯<code>struct objc_object</code>ç±»å‹<strong>ã€‚</strong></p><p>OCä¸­æ‰€æœ‰ç»§æ‰¿è‡ª<code>NSObject</code>çš„ç±»ç”Ÿæˆçš„å¯¹è±¡ï¼Œéƒ½å…·æœ‰Classç±»å‹çš„<code>isa</code>æˆå‘˜**</p><p>é‚£ä¹ˆ<code>Class</code>åˆæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿå…¶å®åœ¨æŸ¥çœ‹<code>id</code>ç±»å‹çš„åŸå§‹å£°æ˜æ—¶ï¼Œå°±çœ‹åˆ°äº†ä¸‹é¢è¿™å¥ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Object.mm line 33</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br></pre></td></tr></tbody></table></figure><p>åŸæ¥<code>Class</code>å°±æ˜¯ä¸€ä¸ªæŒ‡å‘<code>struct objc_class</code>çš„æŒ‡é’ˆç±»å‹ã€‚æ‰€ä»¥æˆ‘ä»¬å¹³æ—¶å®šä¹‰çš„<code>ç±»</code>ä¹Ÿå°±æ˜¯ä»¥<code>struct objc_class</code>ä½œä¸ºæ”¯æ’‘ã€‚å†ç…ç…<code>objc_class</code>ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// objc-runtime-new.h line 1145</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object {</span><br><span class="line"> <span class="comment">// Class ISA;</span></span><br><span class="line"> Class superclass;</span><br><span class="line"> <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line"> <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">class_rw_t</span> *<span class="title">data</span><span class="params">()</span> <span class="keyword">const</span> </span>{</span><br><span class="line">     <span class="keyword">return</span> bits.<span class="built_in">data</span>();</span><br><span class="line"> }</span><br><span class="line"> ...</span><br><span class="line">} </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œæ˜¯ä¸€ä¸ª<code>C++</code>å®šä¹‰çš„ç»“æ„ä½“ï¼Œå¯ä»¥ç»§æ‰¿ä»¥åŠå®šä¹‰æ–¹æ³•ã€‚æ ¹æ®è¿™ä¸ªå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p><ol><li><code>Class</code>ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå› ä¸ºå®ƒç»§æ‰¿è‡ª<code>objc_object</code>ã€‚</li><li><code>Class</code>ä¹Ÿæœ‰<code>isa</code>æˆå‘˜ï¼Œç»§æ‰¿è‡ª<code>objc_object</code>ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œåœ¨æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹æ—¶ä¼šç”¨åˆ°ã€‚`</li><li>é™¤äº†<code>isa</code>ï¼Œè¯¥ç»“æ„ä½“è¿˜åŒ…å«äº†çˆ¶ç±»æŒ‡é’ˆ<code>superclass</code>ï¼Œå’Œè¯¥ç±»ç›¸å…³è”çš„ç¼“å­˜<code>cache</code>ä»¥åŠè¯¥ç±»çš„å…·ä½“ä¿¡æ¯<code>bits</code>;</li></ol></blockquote><h4 id="ç±»çš„æœ¬è´¨"><a href="#ç±»çš„æœ¬è´¨" class="headerlink" title="ç±»çš„æœ¬è´¨"></a>ç±»çš„æœ¬è´¨</h4><p>ç­”ï¼šç±»çš„æœ¬è´¨æ˜¯ä¸€ä¸ª<code>objc_class</code>ç±»å‹çš„ç»“æ„ä½“ï¼Œ<code>objc_class</code>ç»§æ‰¿äº<code>objc_object</code>ã€‚</p><h4 id="idã€instancetypeã€NSObject-çš„åŒºåˆ«"><a href="#idã€instancetypeã€NSObject-çš„åŒºåˆ«" class="headerlink" title="idã€instancetypeã€NSObject * çš„åŒºåˆ«"></a>idã€instancetypeã€NSObject * çš„åŒºåˆ«</h4><p>ç­”ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>ä½¿ç”¨èŒƒå›´</th><th>é™æ€oråŠ¨æ€</th></tr></thead><tbody><tr><td>id</td><td>* å®šä¹‰å˜é‡ï¼› <br>* å®šä¹‰æ–¹æ³•è¿”å›å€¼ï¼›<br>*  å®šä¹‰æ–¹æ³•å‚æ•°ã€‚</td><td>åŠ¨æ€ç±»å‹å¯¹è±¡ï¼›<br>ç¼–è¯‘æ—¶ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥idå¯¹è±¡çš„ç±»å‹ï¼Œ<br>åªæœ‰åœ¨è¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥åä¼šæŠ¥é”™ã€‚<br></td></tr><tr><td>instancetype</td><td>* åªå¯ä½œä¸ºå‡½æ•°è¿”å›å€¼</td><td>åŠ¨æ€ç±»å‹ <br>ï¼ˆæ‰©å¤§å…³è”è¿”å›ç±»å‹çš„æ–¹æ³•èŒƒå›´ï¼Œ<br>ä¸å†åªæ˜¯cocoaå®šä¹‰çš„ç‰¹å®šå…³é”®å­—å¼€å¤´ï¼‰<br>ä½œç”¨ï¼šå¯ä»¥ä½¿é‚£äº›<font color="red"><strong>éå…³è”è¿”å›ç±»å‹</strong></font>çš„æ–¹æ³•è¿”å›æ‰€åœ¨ç±»çš„ç±»å‹</td></tr><tr><td>NSObject *</td><td>* å®šä¹‰å˜é‡ï¼› <br>* å®šä¹‰æ–¹æ³•è¿”å›å€¼ï¼›<br>*  å®šä¹‰æ–¹æ³•å‚æ•°ã€‚</td><td>é™æ€ç±»å‹<br>ç¼–è¯‘æ—¶ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥ã€‚</td></tr><tr><td>id<nsobject> *</nsobject></td><td></td><td>åªè¦éµå¾ª<nsobject>åè®®çš„ä»»ä½•ä¸€ç§ç±»å‹ï¼›</nsobject></td></tr></tbody></table><blockquote><p>Objective-Cä¸­çš„åŠ¨æ€ç±»å‹å’Œé™æ€ç±»å‹**</p><ul><li><p>åŠ¨æ€ç±»å‹</p><p>åŠ¨æ€ç±»å‹æŒ‡çš„æ˜¯å¯¹è±¡æŒ‡é’ˆç±»å‹çš„åŠ¨æ€æ€§ï¼Œå…·ä½“æ˜¯æŒ‡ä½¿ç”¨<code>id</code>ä¿®é¥°åå°†å¯¹è±¡çš„ç±»å‹ç¡®å®šæ¨è¿Ÿåˆ°è¿è¡Œæ—¶ï¼Œç”±èµ‹ç»™å®ƒçš„å¯¹è±¡ç±»å‹å†³å®šå¯¹è±¡æŒ‡é’ˆçš„ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´<code>id</code>ä¿®é¥°çš„å¯¹è±¡ä¸ºåŠ¨æ€ç±»å‹å¯¹è±¡ï¼Œå…¶ä»–åœ¨ç¼–è¯‘å™¨æŒ‡æ˜ç±»å‹çš„ä¸ºé™æ€ç±»å‹å¯¹è±¡ï¼Œé€šå¸¸å¦‚æœä¸éœ€è¦æ¶‰åŠåˆ°å¤šæ€çš„è¯è¿˜æ˜¯è¦å°½é‡ä½¿ç”¨é™æ€ç±»å‹ï¼ˆåŸå› ï¼šé”™è¯¯å¯ä»¥åœ¨ç¼–è¯‘å™¨æå‰æŸ¥å‡ºï¼Œå¯è¯»æ€§å¥½ï¼‰ã€‚</p></li><li><p>é™æ€ç±»å‹</p><p>ä¸€ä¸ªæŒ‡é’ˆå˜é‡æŒ‡å‘ç‰¹å®šç±»çš„å¯¹è±¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯é™æ€ç±»å‹ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°±çŸ¥é“è¿™ä¸ªæŒ‡é’ˆå˜é‡æ‰€å±çš„ç±»ã€‚ä½¿ç”¨é™æ€ç±»å‹æ—¶ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ï¼Œä¼šåšè®¸å¤šçš„ç±»å‹æ£€æŸ¥ï¼šå› ä¸ºç¼–è¯‘å™¨éœ€è¦çŸ¥é“å“ªä¸ªå¯¹è±¡è¯¥å¦‚ä½•ä½¿ç”¨ã€‚</p></li></ul><p><strong>å…³è”è¿”å›ç±»å‹å’Œéå…³è”è¿”å›ç±»å‹</strong></p><ul><li><p>å…³è”è¿”å›ç±»å‹æ¶‰åŠçš„æ–¹æ³•</p><ul><li><p>ç±»æ–¹æ³•ï¼šä»¥allocã€new å¼€å¤´çš„</p></li><li><p>å®ä¾‹æ–¹æ³•ï¼šä»¥<code>autorelease</code>ï¼Œ<code>init</code>ï¼Œ<code>retain</code>æˆ–<code>self</code>å¼€å¤´</p><p>å½“è¿™äº›æ–¹æ³•è¿”å›å€¼ä¸º<code>id</code>ç±»å‹æ—¶ï¼Œç¼–è¯‘å™¨ä¸ä¼šè¿”å›ä¸€ä¸ªç±»å‹ä¸æ˜çš„å¯¹è±¡ï¼Œä¼šè¿”å›ä¸€ä¸ªæ–¹æ³•æ‰€åœ¨ç±»ç±»å‹çš„å¯¹è±¡ï¼Œè¿™äº›æ–¹æ³•å°±è¢«ç§°ä¸ºæ˜¯å…³è”è¿”å›ç±»å‹çš„æ–¹æ³•ã€‚æ¢å¥è¯è¯´ï¼Œè¿™äº›æ–¹æ³•çš„è¿”å›ç»“æœä»¥æ–¹æ³•æ‰€åœ¨çš„ç±»ä¸ºç±»å‹ã€‚</p><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface YLAnimal : NSObject</span><br><span class="line">              </span><br><span class="line">+ (id)newTestObject;  // è¿”å›ä¸€ä¸ªè‡ªåŠ¨å…³è”ä¸ºYLAnimalç±»å‹çš„å¯¹è±¡</span><br><span class="line">+ (id)allocTestObject;// è¿”å›ä¸€ä¸ªè‡ªåŠ¨å…³è”ä¸ºYLAnimalç±»å‹çš„å¯¹è±¡</span><br><span class="line">+ (id)testObject;// è¿”å›ä¸€ä¸ªç±»å‹ä¸æ˜çš„å¯¹è±¡</span><br><span class="line">@end</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li><p>éå…³è”è¿”å›ç±»å‹</p><ul><li>éä»¥ä¸Šå…³é”®å­—å¼€å¤´çš„æ–¹æ³•,è¿”å›å€¼ä¸å…³è”æ‰€å±ç±»çš„ç±»å‹ï¼Œä¼šè¿”å›ä¸€ä¸ªç±»å‹ä¸æ˜çš„å¯¹è±¡;</li></ul></li></ul></blockquote><h1 id="TODO-å…³äºNSProxyä¸NSObject"><a href="#TODO-å…³äºNSProxyä¸NSObject" class="headerlink" title="TODO : å…³äºNSProxyä¸NSObject"></a>TODO : å…³äºNSProxyä¸NSObject</h1><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_NSObject.jpg" alt="NSobject" style="zoom:80%;"><img src="../assets/images/å†…å­˜å¸ƒå±€_OCç±»ä¸å¯¹è±¡_NSProxy.jpg" style="zoom:80%;"><h3 id=""><a href="#" class="headerlink" title=""></a></h3>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
