<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>red carb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="å†…å­˜å¸ƒå±€å…±äº«åº“ï¼ˆlibobjc.A.dylibç­‰ï¼‰ä¸å†…æ ¸ç©ºé—´çš„å†…å­˜å¸ƒå±€åœ¨æ ˆåŒºä¹‹ä¸Š;å¦‚ä¸‹å›¾ï¼š    å†…æ ¸åŒºï¼šç”¨äºåŠ è½½å†…æ ¸ä»£ç ï¼Œé¢„ç•™1GB  å…±äº«åŒºï¼šç”¨äºåŠ è½½ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚:libobjc.a.dylib  æ ˆåŒºï¼šåˆ›å»ºä¸´æ—¶å˜é‡æ—¶ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤çš„å˜é‡çš„å­˜å‚¨åŒºã€‚é‡Œé¢çš„å˜é‡é€šå¸¸æ˜¯å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ç­‰ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä½äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é¡¶éƒ¨çš„æ˜¯ç”¨æˆ·æ ˆï¼Œç¼–è¯‘å™¨ç”¨å®ƒæ¥å®ç°å‡½æ•°çš„è°ƒç”¨ã€‚å’Œå †ä¸€">
<meta property="og:type" content="article">
<meta property="og:title" content="red carb">
<meta property="og:url" content="https://chiefky.github.io/blog/2021/08/03/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E7%BB%BC%E5%90%88/index.html">
<meta property="og:site_name" content="red carb">
<meta property="og:description" content="å†…å­˜å¸ƒå±€å…±äº«åº“ï¼ˆlibobjc.A.dylibç­‰ï¼‰ä¸å†…æ ¸ç©ºé—´çš„å†…å­˜å¸ƒå±€åœ¨æ ˆåŒºä¹‹ä¸Š;å¦‚ä¸‹å›¾ï¼š    å†…æ ¸åŒºï¼šç”¨äºåŠ è½½å†…æ ¸ä»£ç ï¼Œé¢„ç•™1GB  å…±äº«åŒºï¼šç”¨äºåŠ è½½ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚:libobjc.a.dylib  æ ˆåŒºï¼šåˆ›å»ºä¸´æ—¶å˜é‡æ—¶ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤çš„å˜é‡çš„å­˜å‚¨åŒºã€‚é‡Œé¢çš„å˜é‡é€šå¸¸æ˜¯å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ç­‰ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä½äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é¡¶éƒ¨çš„æ˜¯ç”¨æˆ·æ ˆï¼Œç¼–è¯‘å™¨ç”¨å®ƒæ¥å®ç°å‡½æ•°çš„è°ƒç”¨ã€‚å’Œå †ä¸€">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_å†…å­˜å¸ƒå±€_0.jpg">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_å†…å­˜å¸ƒå±€_1.jpg">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_taggedPointer_64.jpg">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_taggedPointer_64_2.jpg">
<meta property="og:image" content="https://chiefky.github.io/Users/tangh/Library/Application%20Support/typora-user-images/image-20210806165118167.png">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_å¯¹è±¡æœ¬è´¨_setter.png">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_NSObject_isa.jpg">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ.jpg">
<meta property="og:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ_0.jpg">
<meta property="article:published_time" content="2021-08-03T11:37:36.513Z">
<meta property="article:modified_time" content="2021-08-11T05:11:17.920Z">
<meta property="article:author" content="yuli">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chiefky.github.io/blog/2021/08/03/images/å†…å­˜ç®¡ç†_å†…å­˜å¸ƒå±€_0.jpg">
  
    <link rel="alternate" href="/blog/atom.xml" title="red carb" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">red carb</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chiefky.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2021-02-16-å†…å­˜ç®¡ç†-ç»¼åˆ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2021/08/03/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E7%BB%BC%E5%90%88/" class="article-date">
  <time datetime="2021-08-03T11:37:36.513Z" itemprop="datePublished">2021-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h2><p>å…±äº«åº“ï¼ˆlibobjc.A.dylibç­‰ï¼‰ä¸å†…æ ¸ç©ºé—´çš„å†…å­˜å¸ƒå±€åœ¨æ ˆåŒºä¹‹ä¸Š;å¦‚ä¸‹å›¾ï¼š</p>
<img src="../images/å†…å­˜ç®¡ç†_å†…å­˜å¸ƒå±€_0.jpg" alt="å†…å­˜åˆ†å¸ƒ" style="zoom:100%;" />

<ul>
<li><p><strong>å†…æ ¸åŒº</strong>ï¼šç”¨äºåŠ è½½å†…æ ¸ä»£ç ï¼Œé¢„ç•™1GB</p>
</li>
<li><p><strong>å…±äº«åŒºï¼šç”¨äºåŠ è½½ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚:libobjc.a.dylib</strong></p>
</li>
<li><p><strong>æ ˆåŒº</strong>ï¼šåˆ›å»ºä¸´æ—¶å˜é‡æ—¶ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤çš„å˜é‡çš„å­˜å‚¨åŒºã€‚é‡Œé¢çš„å˜é‡é€šå¸¸æ˜¯å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ç­‰ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä½äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é¡¶éƒ¨çš„æ˜¯ç”¨æˆ·æ ˆï¼Œç¼–è¯‘å™¨ç”¨å®ƒæ¥å®ç°å‡½æ•°çš„è°ƒç”¨ã€‚å’Œå †ä¸€æ ·ï¼Œç”¨æˆ·æ ˆåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å¯ä»¥åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚</p>
</li>
<li><p><strong>å †åŒº</strong>ï¼šé‚£äº›ç”± new alloc åˆ›å»ºçš„å¯¹è±¡æ‰€åˆ†é…çš„å†…å­˜å—ï¼Œå®ƒä»¬çš„é‡Šæ”¾ç³»ç»Ÿä¸ä¼šä¸»åŠ¨å»ç®¡ï¼Œç”±æˆ‘ä»¬çš„å¼€å‘è€…å»å‘Šè¯‰ç³»ç»Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾è¿™å—å†…å­˜(ä¸€ä¸ªå¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º0æ˜¯ç³»ç»Ÿå°±ä¼šå›é”€æ¯è¯¥å†…å­˜åŒºåŸŸå¯¹è±¡)ã€‚ä¸€èˆ¬ä¸€ä¸ª new å°±è¦å¯¹åº”ä¸€ä¸ªreleaseã€‚åœ¨ARCä¸‹ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨åˆé€‚ä½ç½®ä¸ºOCå¯¹è±¡æ·»åŠ releaseæ“ä½œã€‚ä¼šåœ¨å½“å‰çº¿ç¨‹Runloopé€€å‡ºæˆ–ä¼‘çœ æ—¶é”€æ¯è¿™äº›å¯¹è±¡ï¼ŒMRCåˆ™éœ€ç¨‹åºå‘˜æ‰‹åŠ¨é‡Šæ”¾ã€‚å †å¯ä»¥åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚</p>
</li>
<li><p><strong>æœªåˆå§‹åŒ–æ•°æ®ï¼ˆé™æ€åŒºï¼‰</strong>ï¼šç¨‹åºè¿è¡Œè¿‡ç¨‹å†…å­˜çš„æ•°æ®ä¸€ç›´å­˜åœ¨ï¼Œç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾</p>
</li>
<li><p><strong>å·²åˆå§‹åŒ–æ•°æ®ï¼ˆå¸¸é‡åŒºï¼‰</strong>ï¼šä¸“é—¨ç”¨äºå­˜æ”¾å¸¸é‡ï¼Œç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾</p>
</li>
<li><p><strong>ä»£ç æ®µ</strong>ï¼šç”¨äºå­˜æ”¾ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç ï¼Œä»£ç ä¼šè¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶å­˜è¿›å†…å­˜çš„ç¨‹åºä»£ç åŒº</p>
</li>
<li><p><strong>ä¿ç•™åŒº</strong>ï¼šå†…å­˜æœ‰4MBä¿ç•™ï¼Œåœ°å€ä»ä½åˆ°é«˜é€’å¢</p>
</li>
</ul>
<p>æŸ¥çœ‹å¯¹è±¡åœ°å€ï¼š</p>
<img src="../images/å†…å­˜ç®¡ç†_å†…å­˜å¸ƒå±€_1.jpg" alt="å†…å­˜åˆ†å¸ƒ-1" style="zoom:80%;" />



<h2 id="å†…å­˜ç®¡ç†æ–¹æ¡ˆ"><a href="#å†…å­˜ç®¡ç†æ–¹æ¡ˆ" class="headerlink" title="å†…å­˜ç®¡ç†æ–¹æ¡ˆ"></a>å†…å­˜ç®¡ç†æ–¹æ¡ˆ</h2><p>å…ˆç®€å•äº†è§£å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li><p>TaggedPointer ï¼šå†…ç½®Tagged Pointer<strong>æŒ‡é’ˆ</strong>ä¸­åŒ…å«äº†å½“å‰å¯¹è±¡çš„åœ°å€ã€ç±»å‹ã€å…·ä½“æ•°å€¼ã€‚</p>
</li>
<li><p>nonpointer ï¼š isa_t è”åˆä½“çš„ç¬¬ä¸€ä½ï¼›0ï¼Œä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€classã€meta-classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼›1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯ï¼›</p>
</li>
<li><p>SideTableï¼š åœ¨OCä¸­æ‰®æ¼”è¿™ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ã€‚åœ¨runtimeä¸­ï¼Œé€šè¿‡<code>SideTable</code>æ¥ç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä»¥åŠweakå¼•ç”¨ã€‚åŒæ—¶ï¼Œç³»ç»Ÿä¸­ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„<code>SideTables</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>SideTable</code>çš„é›†åˆã€‚</p>
<p><strong>SideTable</strong>ä¸»è¦å­˜æ”¾äº†OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆRefcountMapï¼‰å’Œå¼±å¼•ç”¨ç›¸å…³ä¿¡æ¯ï¼ˆweak_table_tï¼‰ã€‚</p>
<ul>
<li>RefcountMapï¼šä»¥DisguisedPtr<objc_object>ä¸ºkeyçš„hashè¡¨ï¼Œç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°(ä»…åœ¨æœªå¼€å¯isaä¼˜åŒ– æˆ– åœ¨isaä¼˜åŒ–æƒ…å†µä¸‹isa_tçš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°)ã€‚</li>
<li>weak_table_tï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨ã€‚æ˜¯OC weakåŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚</li>
</ul>
</li>
<li><p>AssociationsHashMapï¼šå­˜æ”¾å¯¹è±¡çš„å…³è”å¯¹è±¡mapçš„mapï¼ˆkeyä¸ºä¼ å…¥çš„objectï¼Œvalueä¸ºmapï¼Œä¹Ÿå°±æ˜¯ObjectAssociationMapï¼‰</p>
</li>
</ul>
<p>ä»¥ä¸Š4ç§æ ‡è®°æˆ–è€…æ˜¯ç»“æ„ä»£è¡¨äº†4ç±»æ•°æ®çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼›ä¸‹é¢è¯¦ç»†æ¢³ç†ï¼›</p>
<h2 id="TaggedPointer"><a href="#TaggedPointer" class="headerlink" title="TaggedPointer"></a>TaggedPointer</h2><blockquote>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨taggedPointer?<br>å‡è®¾è¦å­˜å‚¨ä¸€ä¸ªNSNumberå¯¹è±¡ï¼Œå…¶å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¿™ä¸ªæ•´æ•°åªæ˜¯ä¸€ä¸ªNSIntegerçš„æ™®é€šå˜é‡ï¼Œåœ¨64ä½CPUä¸‹æ˜¯å 8ä¸ªå­—èŠ‚çš„ã€‚1ä¸ªå­—èŠ‚æœ‰8ä½ï¼Œå¦‚æœæˆ‘ä»¬å­˜å‚¨ä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œä¼šå‡ºç°å¾ˆå¤šä½éƒ½æ˜¯0çš„æƒ…å†µï¼Œè¿™æ ·å°±é€ æˆäº†å†…å­˜æµªè´¹ï¼Œè‹¹æœä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†taggedPointerçš„æ¦‚å¿µã€‚</p>
<p>ä»¥NSNumberä¸ºğŸŒ°ï¼Œå¯¹è±¡å ç”¨å†…å­˜ç©ºé—´æƒ…å†µï¼š</p>
<p>arm64ä¹‹å‰ï¼šæŒ‡é’ˆï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+ NSNumberå¯¹è±¡ï¼ˆ16ä¸ªå­—èŠ‚ å†…å­˜å¯¹é½ï¼‰</p>
<p>arm64ä¹‹åï¼šTaggedPointeræŒ‡é’ˆï¼ˆåªå 8å­—èŠ‚ï¼‰</p>
</blockquote>
<ul>
<li><strong>Tagged Pointer</strong>æ˜¯è‹¹æœä¸ºäº†è§£å†³32ä½CPUåˆ°64ä½CPUçš„è½¬å˜å¸¦æ¥çš„å†…å­˜å ç”¨å’Œæ•ˆç‡é—®é¢˜ï¼Œé’ˆå¯¹<strong>NSNumberã€NSDate</strong>ä»¥åŠéƒ¨åˆ†<strong>NSString</strong>çš„å†…å­˜ä¼˜åŒ–æ–¹æ¡ˆã€‚</li>
<li><strong>Tagged PointeræŒ‡é’ˆ</strong>çš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒ<strong>ä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡</strong>äº†ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æ™®é€šå˜é‡è€Œå·²ã€‚æ‰€ä»¥ï¼Œå®ƒçš„<strong>å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼ˆè€Œæ˜¯åœ¨æ ˆä¸Šï¼‰ï¼Œä¹Ÿ</strong>ä¸éœ€è¦mallocå’Œfree**ã€‚</li>
<li><strong>Tagged PointeræŒ‡é’ˆ</strong>ä¸­åŒ…å«äº†å½“å‰å¯¹è±¡çš„åœ°å€ã€ç±»å‹ã€å…·ä½“æ•°å€¼ã€‚å› æ­¤Tagged PointeræŒ‡é’ˆåœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€3å€çš„æ•ˆç‡ï¼Œåˆ›å»ºæ—¶æ¯”æ™®é€šéœ€è¦<strong>malloc</strong>è·Ÿ<strong>free</strong>çš„ç±»å‹<strong>å¿«106å€</strong>ã€‚</li>
</ul>
<p>TaggedPointeræ··æ·†åŸç†ï¼š</p>
<p>æ··æ·†åŸç†ï¼šä½¿ç”¨ä¸€ä¸ªéšæœºæ•°<code>objc_debug_taggedpointer_obfuscator</code>å¯¹çœŸæ­£çš„å†…å­˜åœ°å€å¼‚æˆ–æ“ä½œã€‚æ ¹æ®å¼‚æˆ–è¿ç®—çš„ç‰¹æ€§ï¼Œa^b^b=aï¼Œå› æ­¤åªéœ€è¦å°†æ··æ·†åçš„åœ°å€å†ä¸<code>objc_debug_taggedpointer_obfuscator</code>å¼‚æˆ–ä¸€æ¬¡å°±èƒ½å¤Ÿå®Œæˆåæ··æ·†ã€‚</p>
<p><strong>Tagged Pointerå†…å­˜ç»“æ„</strong></p>
<img src="../images/å†…å­˜ç®¡ç†_taggedPointer_64.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;" />

<img src="../images/å†…å­˜ç®¡ç†_taggedPointer_64_2.jpg" alt="TaggedPointerbitåˆ†å¸ƒå›¾" style="zoom:50%;" />

<p>ä¸macOSä¸åŒï¼ŒiOSç³»ç»Ÿé‡‡ç”¨ <code>MSB</code>ï¼ˆ<code>Most Significant Bit</code>ï¼Œå³æœ€é«˜æœ‰æ•ˆä½ï¼‰ä¸º<code>Tagged Pointer</code>æ ‡å¿—ä½ã€‚</p>
<p><strong>å„bitå«ä¹‰è§£é‡Š</strong></p>
<ul>
<li><p>_OBJC_TAG_MASK: å 1bitï¼Œæ˜¯<code>Tagged Pointer</code>æ ‡å¿—ä½ï¼Œ1æ„å‘³ç€è¯¥åœ°å€æ˜¯<code>Tagged Pointer</code>ï¼Œ0åˆ™ä¸æ˜¯ã€‚</p>
</li>
<li><p>Extended_Tag_Indexï¼šå 8bitï¼Œåªæœ‰å½“Tag_Index=7çš„æ—¶å€™æ‰å­˜åœ¨ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨äºæ‰©å±•çš„æ ‡å¿—ä½ï¼Œä¼šé¢å¤–å ç”¨8ä½æ¥å­˜å‚¨æ‰©å±•çš„Tag Indexã€‚ç±»æ ‡è¯†çš„åŸºæœ¬ç±»å‹å’Œæ‰©å±•ç±»å‹æˆ‘ä»¬å¯ä»¥åœ¨<code>Runtime</code>æºç ä¸­çš„<code>objc_tag_index_t</code>æŸ¥åˆ°ï¼š</p>
<img src="/Users/tangh/Library/Application Support/typora-user-images/image-20210806165118167.png" style="zoom:30%;" /></li>
<li><p>Tag_Indexï¼šå 3bitï¼Œæ˜¯ç±»æ ‡å¿—ä½ï¼Œå¯ä»¥åœ¨<code>Runtime</code>æºç ä¸­æŸ¥çœ‹<code>NSNumber</code>ã€<code>NSDate</code>ã€<code>NSString</code>ç­‰ç±»çš„æ ‡å¿—ä½ã€‚</p>
</li>
<li><p>Payloadï¼šå¯¹NSNumberè€Œè¨€ï¼Œæœ€å¤šå 56bitï¼Œæœ€å°‘å 48bitï¼ˆå–å†³äºTag Indexæ˜¯å¦ä¸ºextended tag indexï¼‰ï¼Œå­˜å‚¨å…·ä½“çš„æ•°å€¼ã€‚</p>
</li>
<li><p>Type_Index: å 4bitï¼Œä»£è¡¨NSNumberå…·ä½“çš„æ•°æ®ç±»å‹ï¼Œå…·ä½“çš„å¯¹åº”å…³ç³»ï¼š</p>
<table>
<thead>
<tr>
<th>Type_Index</th>
<th>å¯¹åº”æ•°æ®ç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>char</td>
</tr>
<tr>
<td>1</td>
<td>usigned char, short</td>
</tr>
<tr>
<td>2</td>
<td>unsigned short,int</td>
</tr>
<tr>
<td>3</td>
<td>unsigned int,NSInteger,NSUInteger,long,unsigned long,long long,unsigned long long</td>
</tr>
<tr>
<td>4</td>
<td>float</td>
</tr>
<tr>
<td>5</td>
<td>double</td>
</tr>
</tbody></table>
<p>ç»“è®ºï¼š<code>Tagged Pointer</code>å¯è¡¨ç¤ºçš„æ•°å­—èŒƒå›´æ˜¯-2^55+1 ~ 2^55-1ï¼Œå¯¹äºè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ•°å­—ï¼ŒNSNumberä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæ™®é€šçš„å†…å­˜åˆ†é…åœ¨å †ä¸Šçš„OCå¯¹è±¡ã€‚</p>
<p><strong>å¦‚ä½•åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºTagged Pointer</strong></p>
<p>åœ¨ <a href="https://link.juejin.cn/?target=https://github.com/Kanthine/SourceCode/blob/51fd88340a1d76047dcb8bb02e47f14482d00706/objc4-750/runtime/objc-internal.h">objc runtimeæºç </a>ä¸­æ‰¾åˆ°äº† <code>_objc_isTaggedPointer()</code>çš„å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static inline bool _objc_isTaggedPointer(const void * _Nullable ptr)&#123;</span><br><span class="line">    //å°†ä¸€ä¸ªæŒ‡é’ˆåœ°å€å’Œ _OBJC_TAG_MASK å¸¸é‡åš &amp; è¿ç®—ï¼šåˆ¤æ–­è¯¥æŒ‡é’ˆçš„æœ€é«˜ä½æˆ–è€…æœ€ä½ä½ä¸º 1ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå°±æ˜¯ Tagged Pointerã€‚</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure>

<p><code>_OBJC_TAG_MASK</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#if OBJC_MSB_TAGGED_POINTERS //MSB é«˜ä½ä¼˜å…ˆ</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63) //Tagged Pointer æŒ‡é’ˆ</span><br><span class="line">#else //LSB ä½ä½ä¼˜å…ˆ</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL //Tagged Pointer æŒ‡é’ˆ</span><br><span class="line">#endif</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure>

<p>å› æ­¤ <code>ptr &amp; _OBJC_TAG_MASK</code> æŒ‰ä½ä¸è¿ç®—ä¹‹åå¦‚æœåˆ¤æ–­æ ‡å¿—ä½ä¸º1åˆ™è¯¥æŒ‡é’ˆæ˜¯<code>Tagged Pointer</code> ã€‚</p>
</li>
</ul>
</blockquote>
<p><strong>é™„</strong>ï¼š<strong>tagged Pointer</strong> é’ˆå¯¹ <strong>obj_msg_send</strong> çš„å¤„ç†</p>
<p>â€‹    â€¢    å¯¹äºå†…ç½®Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜å››ä½ä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ï¼›</p>
<p>â€‹    â€¢    å¯¹äºè‡ªå®šä¹‰æ‰©å±•Tagged Pointerç±»å‹çš„å¯¹è±¡æ¥è¯´ï¼Œå…¶ä¸­çš„é«˜52ä½åˆ°59ä½è¿™8ä½bitä¿å­˜çš„æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å€¼å¯ä»¥åœ¨objc_debug_taggedpointer_ext_classesæ•°ç»„ä¸­æŸ¥æ‰¾åˆ°å¯¹è±¡æ‰€å±çš„Classå¯¹è±¡ã€‚</p>
<h2 id="nonpointer"><a href="#nonpointer" class="headerlink" title="nonpointer"></a>nonpointer</h2><blockquote>
<ul>
<li><p><code>0ï¼Œ</code>ä»£è¡¨æ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€<code>Class</code>ã€<code>Meta-Class</code>å¯¹è±¡çš„å†…å­˜åœ°å€ â€”- ï¼ˆ**<font color=red>æœªå¼€å¯isaä¼˜åŒ–</font>** ï¼‰</p>
<p>å¦‚æœnonpointerä¸º0ï¼Œä»£è¡¨raw isaï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç»“æ„ä½“çš„éƒ¨åˆ†ï¼Œè®¿é—®å¯¹è±¡çš„ isa ä¼šç›´æ¥è¿”å›ä¸€ä¸ªæŒ‡å‘ cls çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åœ¨ iPhone è¿ç§»åˆ° 64 ä½ç³»ç»Ÿä¹‹å‰æ—¶ isa çš„ç±»å‹ã€‚</p>
</li>
<li><p>1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ â€”â€“ï¼ˆ<font color=red><strong>å¼€å¯isaä¼˜åŒ–</strong></font> ï¼‰</p>
</li>
</ul>
</blockquote>
<h2 id="TODOï¼šSideTable-amp-weakåº•å±‚åŸç†"><a href="#TODOï¼šSideTable-amp-weakåº•å±‚åŸç†" class="headerlink" title="TODOï¼šSideTable&amp;weakåº•å±‚åŸç†"></a>TODOï¼šSideTable&amp;weakåº•å±‚åŸç†</h2><blockquote>
<p>æ¥çœ‹çœ‹SideTableçš„å®šä¹‰ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> SideTable &#123;</span><br><span class="line">    spinlock_t slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    weak_table_t weak_table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SideTableçš„å®šä¹‰å¾ˆæ¸…æ™°ï¼Œæœ‰ä¸‰ä¸ªæˆå‘˜:</p>
<blockquote>
<ul>
<li><strong>spinlock_t slock</strong>ï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¸Šé”/è§£é” SideTableã€‚</li>
<li><strong>RefcountMap refcnts</strong>ï¼šç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°çš„ <code>hashè¡¨</code>(ä»…åœ¨æœªå¼€å¯isaä¼˜åŒ–æˆ–åœ¨isaä¼˜åŒ–æƒ…å†µä¸‹isa_tçš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°ï¼Œ<font color="red"><strong>æœªæº¢å‡ºæ—¶æ˜¯æ”¾åœ¨isa_tä¸‹çš„extra_rcå­—æ®µä¸­</strong></font>)ã€‚</li>
<li><strong>weak_table_t weak_table</strong>ï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨ã€‚æ˜¯OCä¸­weakåŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚</li>
</ul>
</blockquote>
</blockquote>
<h2 id="TODOï¼šAssociationsHashMap-amp-å…³è”å¯¹è±¡å®ç°åŸç†"><a href="#TODOï¼šAssociationsHashMap-amp-å…³è”å¯¹è±¡å®ç°åŸç†" class="headerlink" title="TODOï¼šAssociationsHashMap&amp;å…³è”å¯¹è±¡å®ç°åŸç†"></a>TODOï¼šAssociationsHashMap&amp;å…³è”å¯¹è±¡å®ç°åŸç†</h2><blockquote>
</blockquote>
<h2 id="OCç±»ã€å¯¹è±¡çš„å†…å­˜ç»“æ„"><a href="#OCç±»ã€å¯¹è±¡çš„å†…å­˜ç»“æ„" class="headerlink" title="OCç±»ã€å¯¹è±¡çš„å†…å­˜ç»“æ„"></a>OCç±»ã€å¯¹è±¡çš„å†…å­˜ç»“æ„</h2><h4 id="ä½¿ç”¨clang"><a href="#ä½¿ç”¨clang" class="headerlink" title="ä½¿ç”¨clang"></a>ä½¿ç”¨clang</h4><p>ä¸ºäº†æ›´å¥½çš„è§‚å¯Ÿ<code>åº•å±‚</code>çš„ä¸€äº›<code>ç»“æ„</code> åŠ <code>å®ç°</code>çš„é€»è¾‘,å­¦ä¼šä½¿ç”¨clangå‘½ä»¤ï¼›</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1ã€å°† main.m ç¼–è¯‘æˆ main.cpp</span></span><br><span class="line">clang -rewrite-objc main.m -o main.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">//2ã€å°† ViewController.m ç¼–è¯‘æˆ  ViewController.cpp</span></span><br><span class="line">clang -rewrite-objc -fobjc-arc -fobjc-runtime=ios<span class="number">-13.0</span><span class="number">.0</span> -isysroot / /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator13<span class="number">.7</span>.sdk ViewController.m</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ˜¯é€šè¿‡æŒ‡å®šæ¶æ„æ¨¡å¼çš„å‘½ä»¤è¡Œï¼Œä½¿ç”¨xcodeå·¥å…· xcrun</span></span><br><span class="line"><span class="comment">//3ã€æ¨¡æ‹Ÿå™¨æ–‡ä»¶ç¼–è¯‘</span></span><br><span class="line">- xcrun -sdk iphonesimulator clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp </span><br><span class="line"></span><br><span class="line"><span class="comment">//4ã€çœŸæœºæ–‡ä»¶ç¼–è¯‘</span></span><br><span class="line">- xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main- arm64.cpp </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="é¢è¯•é¢˜"><a href="#é¢è¯•é¢˜" class="headerlink" title="é¢è¯•é¢˜"></a>é¢è¯•é¢˜</h4><p><code>YLPerson</code> ç±»ç»è¿‡ç¼–è¯‘å¾—åˆ°çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NSObjectçš„å®šä¹‰</span></span><br><span class="line">@interface NSObject &lt;NSObject&gt; &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//NSObject çš„åº•å±‚ç¼–è¯‘</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> &#123;</span></span><br><span class="line">	Class isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//YLPersonçš„åº•å±‚ç¼–è¯‘</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">YLPerson_IMPL</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> <span class="title">NSObject_IVARS</span>;</span> <span class="comment">// ç­‰æ•ˆäº Class isa;</span></span><br><span class="line">	NSString *_name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ol>
<li><p>OCå¯¹è±¡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li><code>OCå¯¹è±¡çš„æœ¬è´¨</code> å…¶å®å°±æ˜¯ <code>ç»“æ„ä½“</code></li>
</ul>
</li>
<li><p>OCå¯¹è±¡setteræ–¹æ³•åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li><p>setteræ–¹æ³•æœ€ç»ˆä¼šè¿›å…¥åº•å±‚<code>reallySetProperty</code> æ–¹æ³•ï¼Œå…¶åŸç†å°±æ˜¯<code>æ–°å€¼retainï¼Œæ—§å€¼release</code>ã€‚</p>
<img src="../images/å†…å­˜ç®¡ç†_å¯¹è±¡æœ¬è´¨_setter.png" alt="setter" style="zoom:80%;" /></li>
</ul>
</li>
</ol>
<h3 id="OCç±»ç»“æ„è§£æ"><a href="#OCç±»ç»“æ„è§£æ" class="headerlink" title="OCç±»ç»“æ„è§£æ"></a>OCç±»ç»“æ„è§£æ</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å¯¹è±¡</span></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;	<span class="comment">// çˆ¶ç±»</span></span><br><span class="line">    cache_t cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    class_rw_t *data() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isaæŒ‡å‘"><a href="#isaæŒ‡å‘" class="headerlink" title="isaæŒ‡å‘"></a>isaæŒ‡å‘</h4><p>person â€”&gt; YLPerson â€”-&gt; YLPerson(Meta) â€”-&gt; NSObject(Meta) â€”-&gt; NSObject(Meta) è‡ªå·±</p>
<h4 id="superæŒ‡å‘"><a href="#superæŒ‡å‘" class="headerlink" title="superæŒ‡å‘"></a>superæŒ‡å‘</h4><p>son â€”-&gt; YLPerson â€”-&gt; NSObject â€”-&gt; nil </p>
<img src="../images/å†…å­˜ç®¡ç†_NSObject_isa.jpg" alt="å†…å­˜åœ°å€" style="zoom:80%;" />



<h3 id="isa-tç»“æ„è§£æ"><a href="#isa-tç»“æ„è§£æ" class="headerlink" title="isa_tç»“æ„è§£æ"></a>isa_tç»“æ„è§£æ</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    uintptr_t bits;</span><br><span class="line">    Class cls;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>isa_t</strong> å…¶å®æ˜¯ä¸€ä¸ªè”åˆä½“<strong>union :</strong> ä¸€ä¸ª<strong>8</strong>å­—èŠ‚æŒ‡é’ˆ**(64<strong>ä½</strong>) = cls = bits =** ä½¿ç”¨ä½åŸŸçš„<strong>struct</strong> </p>
<p>è”åˆä½“**(union)**æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œå…è®¸æ‚¨åœ¨ç›¸åŒçš„å†…å­˜ä½ç½®å­˜å‚¨ä¸åŒçš„æ•°æ®ç±»å‹ã€‚æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå¸¦æœ‰å¤šæˆå‘˜çš„å…±ç”¨ä½“ï¼Œä½†æ˜¯ä»»ä½•æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªæˆå‘˜å¸¦æœ‰å€¼ã€‚(å¦‚ä¸‹ï¼Œè¦ä¹ˆclsæœ‰å€¼ï¼Œè¦ä¹ˆbitsæœ‰å€¼ï¼›ä¸¤è€…ä¸å¯èƒ½åŒæ—¶æœ‰å€¼)</p>
<blockquote>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>ARM64ä½æ¶æ„ä¹‹å‰ï¼Œ<code>isa</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘<code>class/meta-class</code>å¯¹è±¡çš„åœ°å€ ï¼›</p>
<p>ARM64ä½æ¶æ„å¼€å§‹(ä¹Ÿå°±æ˜¯13å¹´5sé¢ä¸–)ï¼Œ<code>isa</code>æ˜¯ä¸€ä¸ªè”åˆä½“/å…±ç”¨ä½“ï¼ˆ<code>union</code>ï¼‰ï¼Œè¿™æ˜¯è‹¹æœå¯¹<code>isa</code>çš„ä¼˜åŒ–ï¼Œç»“åˆä½åŸŸçš„æ¦‚å¿µä»¥åŠä½è¿ç®—çš„æ–¹å¼æ¥å­˜å‚¨æ›´å¤šç±»ç›¸å…³ä¿¡æ¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯<code>isa</code>æŒ‡é’ˆé€šè¿‡ä¸€ä¸ªå«<code>ISA_MASK</code>çš„å€¼è¿›è¡ŒäºŒè¿›åˆ¶&amp;è¿ç®—ï¼Œå¾—åˆ°çœŸå®çš„<code>class/meta-class</code>å¯¹è±¡çš„çœŸå®åœ°å€ã€‚</p>
</blockquote>
<h4 id="isaæºç -amp-å„ä½ä»£è¡¨å«ä¹‰"><a href="#isaæºç -amp-å„ä½ä»£è¡¨å«ä¹‰" class="headerlink" title="isaæºç &amp;å„ä½ä»£è¡¨å«ä¹‰"></a>isaæºç &amp;å„ä½ä»£è¡¨å«ä¹‰</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¯æŒarm64ä¹‹åï¼Œä¹‹å‰åªæœ‰ä¸€ä¸ªclassæˆå‘˜å˜é‡ï¼š</span></span><br><span class="line"><span class="keyword">union</span> isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    uintptr_t bits;</span><br><span class="line">    Class cls;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// x86_64 æ¶æ„</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    uintptr_t nonpointer        : <span class="number">1</span>;  <span class="comment">// 0:æ™®é€šæŒ‡é’ˆï¼Œ1:ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯</span></span><br><span class="line">    uintptr_t has_assoc         : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦å«æœ‰æˆ–æ›¾ç»å«æœ‰å…³è”å¼•ç”¨</span></span><br><span class="line">    uintptr_t has_cxx_dtor      : <span class="number">1</span>;  <span class="comment">// è¡¨ç¤ºæ˜¯å¦æœ‰C++ææ„å‡½æ•°æˆ–OCçš„dealloc</span></span><br><span class="line">    uintptr_t shiftcls          : <span class="number">44</span>; <span class="comment">// å­˜æ”¾ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</span></span><br><span class="line">    uintptr_t magic             : <span class="number">6</span>;  <span class="comment">// ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    uintptr_t weakly_referenced : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦è¢«å¼±å¼•ç”¨æŒ‡å‘</span></span><br><span class="line">    uintptr_t deallocating      : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</span></span><br><span class="line">    uintptr_t has_sidetable_rc  : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦éœ€è¦ä½¿ç”¨ sidetable æ¥å­˜å‚¨å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    uintptr_t extra_rc          : <span class="number">8</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°èƒ½å¤Ÿç”¨ 8 ä¸ªäºŒè¿›åˆ¶ä½å­˜å‚¨æ—¶ï¼Œç›´æ¥å­˜å‚¨åœ¨è¿™é‡Œ</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arm64 æ¶æ„</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    uintptr_t nonpointer        : <span class="number">1</span>;  <span class="comment">// 0:æ™®é€šæŒ‡é’ˆï¼Œ1:ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯</span></span><br><span class="line">    uintptr_t has_assoc         : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦å«æœ‰æˆ–æ›¾ç»å«æœ‰å…³è”å¼•ç”¨</span></span><br><span class="line">    uintptr_t has_cxx_dtor      : <span class="number">1</span>;  <span class="comment">// è¡¨ç¤ºæ˜¯å¦æœ‰C++ææ„å‡½æ•°æˆ–OCçš„dealloc</span></span><br><span class="line">    uintptr_t shiftcls          : <span class="number">33</span>; <span class="comment">// å­˜æ”¾ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</span></span><br><span class="line">    uintptr_t magic             : <span class="number">6</span>;  <span class="comment">// ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">    uintptr_t weakly_referenced : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦è¢«å¼±å¼•ç”¨æŒ‡å‘</span></span><br><span class="line">    uintptr_t deallocating      : <span class="number">1</span>;  <span class="comment">// å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</span></span><br><span class="line">    uintptr_t has_sidetable_rc  : <span class="number">1</span>;  <span class="comment">// æ˜¯å¦éœ€è¦ä½¿ç”¨ sidetable æ¥å­˜å‚¨å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    uintptr_t extra_rc          : <span class="number">19</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°èƒ½å¤Ÿç”¨ 19 ä¸ªäºŒè¿›åˆ¶ä½å­˜å‚¨æ—¶ï¼Œç›´æ¥å­˜å‚¨åœ¨è¿™é‡Œ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨ï¼š åœ¨ 64 ä½ç¯å¢ƒä¸‹ï¼Œä¼˜åŒ–çš„ isa æŒ‡é’ˆå¹¶ä¸æ˜¯å°±ä¸€å®šä¼šå­˜å‚¨å¼•ç”¨è®¡æ•°ï¼Œæ¯•ç«Ÿç”¨ 19bit ï¼ˆiOS ç³»ç»Ÿï¼‰ä¿å­˜å¼•ç”¨è®¡æ•°ä¸ä¸€å®šå¤Ÿã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ 19 ä½ä¿å­˜çš„æ˜¯å¼•ç”¨è®¡æ•°çš„å€¼å‡ä¸€ã€‚has_sidetable_rc çš„å€¼å¦‚æœä¸º 1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå« SideTable çš„ç±»çš„å±æ€§ä¸­ã€‚ï¼ˆæºç å®ç°ï¼šå¦‚æœæ˜¯ä¼˜åŒ–è¿‡çš„isaï¼Œextra_rc+1å°±æ˜¯å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœæœ‰SideTableï¼Œå°±ä»SideTableæ‹¿åˆ°å¼•ç”¨è®¡æ•°ï¼Œä»SideTableæ‹¿åˆ°çš„å¼•ç”¨è®¡æ•°åŠ ä¸Šextra_rc+1å°±æ˜¯æ€»çš„å¼•ç”¨è®¡æ•°ã€‚ï¼‰</p>
<h4 id="isaå®ä¾‹åŒ–æ–¹å¼"><a href="#isaå®ä¾‹åŒ–æ–¹å¼" class="headerlink" title="isaå®ä¾‹åŒ–æ–¹å¼"></a><strong>isaå®ä¾‹åŒ–æ–¹å¼</strong></h4><blockquote>
<p>ç”±isaæºç å¾—çŸ¥ï¼Œisa_tæä¾›äº†ä¸¤ä¸ªæˆå‘˜ï¼Œ<code>cls</code>  å’Œ <code> bits</code>ï¼Œç”±è”åˆä½“çš„å®šä¹‰æ‰€çŸ¥ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜æ˜¯<strong>äº’æ–¥</strong>çš„ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œå½“åˆå§‹åŒ–isaæŒ‡é’ˆæ—¶ï¼Œæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼</p>
<ul>
<li>é€šè¿‡<code>cls</code>åˆå§‹åŒ–ï¼Œ<code>bits</code>æ— é»˜è®¤å€¼</li>
<li>é€šè¿‡<code>bits</code>åˆå§‹åŒ–ï¼Œ<code>cls</code> æœ‰é»˜è®¤å€¼</li>
</ul>
</blockquote>
<h4 id="éªŒè¯isa-tä½åŸŸ"><a href="#éªŒè¯isa-tä½åŸŸ" class="headerlink" title="éªŒè¯isa_tä½åŸŸ"></a><strong>éªŒè¯isa_tä½åŸŸ</strong></h4><p>æ–¹æ³•ï¼šä½¿ç”¨objcæºç æ„å»ºå¯ç¼–è¯‘å·¥ç¨‹ï¼Œç„¶ååœ¨mainä¸­çš„<code>[YLPerson alloc]</code> (æ³¨ï¼šYLPersonæœªå¼€å¯<code>+load</code>æ–¹æ³•)æ–­ç‚¹ â€“&gt; <code>initInstanceIsa</code> â€“&gt; <code>initIsa</code> â€“&gt; èµ°åˆ°<code>else</code>ä¸­çš„ <code>isa</code>åˆå§‹åŒ–;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// isaåˆå§‹åŒ–åº•å±‚ä»£ç </span><br><span class="line">inline void </span><br><span class="line">objc_object::initIsa(Class cls, bool nonpointer, UNUSED_WITHOUT_INDEXED_ISA_AND_DTOR_BIT bool hasCxxDtor)</span><br><span class="line">&#123; </span><br><span class="line">    ASSERT(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    isa_t newisa(0);</span><br><span class="line"></span><br><span class="line">    if (!nonpointer) &#123; // é€šè¿‡clsåˆå§‹åŒ–ï¼Œä¸è®¾ç½®bitsé»˜è®¤å€¼</span><br><span class="line">        newisa.setClass(cls, this);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ASSERT(!DisableNonpointerIsa);</span><br><span class="line">        ASSERT(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line">      </span><br><span class="line">#if SUPPORT_INDEXED_ISA</span><br><span class="line">        ASSERT(cls-&gt;classArrayIndex() &gt; 0);</span><br><span class="line">        newisa.bits = ISA_INDEX_MAGIC_VALUE;</span><br><span class="line">        // isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        // isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">        newisa.indexcls = (uintptr_t)cls-&gt;classArrayIndex();</span><br><span class="line">#else</span><br><span class="line">        newisa.bits = ISA_MAGIC_VALUE; </span><br><span class="line">        // isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        // isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">#   if ISA_HAS_CXX_DTOR_BIT</span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">#   endif</span><br><span class="line">        newisa.setClass(cls, this); // é€šè¿‡bitsåˆå§‹åŒ–ï¼Œè®¾ç½®clsé»˜è®¤å€¼</span><br><span class="line">#endif</span><br><span class="line">        newisa.extra_rc = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This write must be performed in a single store in some cases</span><br><span class="line">    // (for example when realizing a class because other threads</span><br><span class="line">    // may simultaneously try to use the class).</span><br><span class="line">    // fixme use atomics here to guarantee single-store and to</span><br><span class="line">    // guarantee memory order w.r.t. the class index table</span><br><span class="line">    // ...but not too atomic because we don&#x27;t want to hurt instantiation</span><br><span class="line">    isa = newisa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡bitsåˆå§‹åŒ–å‰åå¯¹æ¯”ï¼š</p>
<img src="../images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ.jpg" alt="isaéªŒè¯bitsä½åŸŸ" style="zoom:80%;" />

<p>å…¶ä¸­<code>magic</code>æ˜¯<code>59</code>æ˜¯ç”±äºå°†<code>isa</code>æŒ‡é’ˆåœ°å€è½¬æ¢ä¸º<code>äºŒè¿›åˆ¶</code>ï¼Œä»<code>47</code>ï¼ˆå› ä¸ºå‰é¢æœ‰4ä¸ªä½åŸŸï¼Œå…±å ç”¨47ä½ï¼Œåœ°å€æ˜¯ä»0å¼€å§‹ï¼‰ä½å¼€å§‹è¯»å–<code>6</code>ä½ï¼Œå†è½¬æ¢ä¸º<code>åè¿›åˆ¶</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<img src="../images/å†…å­˜ç®¡ç†_isa_éªŒè¯ä½åŸŸ_0.jpg" alt="isaéªŒè¯bitsä½åŸŸ" style="zoom:80%;" />

<h4 id="isa-ä¸-ç±»-çš„å…³è”"><a href="#isa-ä¸-ç±»-çš„å…³è”" class="headerlink" title="isa ä¸ ç±» çš„å…³è”"></a><strong>isa ä¸ ç±» çš„å…³è”</strong></h4><p><code>cls</code> ä¸ <code>isa</code> å…³è”<code>åŸç†</code>å°±æ˜¯<code>isa</code>æŒ‡é’ˆä¸­çš„<code>shiftcls</code>ä½åŸŸä¸­å­˜å‚¨äº†<code>ç±»ä¿¡æ¯</code>ï¼Œå…¶ä¸­<code>initInstanceIsa</code>çš„è¿‡ç¨‹æ˜¯å°† <code>calloc</code> æŒ‡é’ˆ å’Œå½“å‰çš„ <code>ç±»cls</code> å…³è”èµ·æ¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç§éªŒè¯æ–¹å¼ï¼š</p>
<ul>
<li>ã€æ–¹å¼ä¸€ã€‘é€šè¿‡ä»¥ä¸Š<code>initIsa</code>æ–¹æ³•ä¸­çš„<code>newisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;</code>éªŒè¯</li>
<li>ã€æ–¹å¼äºŒã€‘é€šè¿‡<code>isaæŒ‡é’ˆåœ°å€</code>ä¸<code>ISA_MSAK</code> çš„å€¼ <code>&amp;</code> æ¥éªŒè¯</li>
<li>ã€æ–¹å¼ä¸‰ã€‘é€šè¿‡runtimeçš„æ–¹æ³•<code>object_getClass</code>éªŒè¯</li>
<li>ã€æ–¹å¼å››ã€‘é€šè¿‡<code>ä½è¿ç®—</code>éªŒè¯</li>
</ul>
<p>å‚è€ƒï¼šé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6949580932479189029">https://juejin.cn/post/6949580932479189029</a></p>
<h2 id="TODOï¼šruntimeå†…å­˜ç®¡ç†ä¼˜åŒ–"><a href="#TODOï¼šruntimeå†…å­˜ç®¡ç†ä¼˜åŒ–" class="headerlink" title="TODOï¼šruntimeå†…å­˜ç®¡ç†ä¼˜åŒ–"></a>TODOï¼šruntimeå†…å­˜ç®¡ç†ä¼˜åŒ–</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://chiefky.github.io/blog/2021/08/03/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E7%BB%BC%E5%90%88/" data-id="ckstyoxqu0006xpqd2kalb7s6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2021/08/11/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/blog/2016/02/16/2016-02-16-hello-world-vno/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World - Vno</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/08/27/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/blog/2021/08/12/2014-02-17-GCD/">(no title)</a>
          </li>
        
          <li>
            <a href="/blog/2021/08/12/2014-02-16-static-const-external%E4%BD%9C%E7%94%A8%E5%8F%8A%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/blog/2021/08/11/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-OC%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/">(no title)</a>
          </li>
        
          <li>
            <a href="/blog/2021/08/11/2021-02-16-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 yuli<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">

  
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>




<script src="/blog/js/script.js"></script>




  </div>
</body>
</html>